import { Client } from '../common/json-rpc/Client';
import { getApi } from '../common/json-rpc/API';
import { isPromiseLike } from '../common/core/isPromiseLike';
const loadAPIsNotificationName = 'LoadComponents';
const hasSymbol = typeof Symbol === 'function' && Symbol.for;
const injectedAPISymbol = hasSymbol ? Symbol('injectedAPIs') : 0xfea0;
export function inject(apiName) {
    if (apiName !== undefined && !apiName) {
        throw new TypeError('API name cannot be null / empty');
    }
    return function (target, propertyKey) {
        if (typeof propertyKey === 'string') {
            getInjectedAPIs(target).set(propertyKey, apiName || propertyKey);
        }
        else
            throw new TypeError('Cannot inject APIs with non-string names');
    };
}
export function getInjectedAPIs(instance) {
    const instanceAny = instance;
    instanceAny[injectedAPISymbol] = instanceAny[injectedAPISymbol] || new Map();
    return instanceAny[injectedAPISymbol];
}
async function _injectAPIs(target) {
    const injectedMap = getInjectedAPIs(target);
    if (injectedMap.size === 0)
        return;
    await target.loadAPIs(Array.from(injectedMap.values()));
    injectedMap.forEach(function (apiName, property) {
        target[property] = target.loadedAPIs[apiName];
    });
}
class Script extends Client {
    constructor(transport, opt) {
        super(opt);
        this.transport = transport;
        this.loadedAPIs = {};
        this.started = false;
        if (transport.onError) {
            transport.onError(e => {
                this.emit('error', e);
            });
        }
        if (transport.onClose) {
            transport.onClose(() => {
                this.emit('transportClosed');
            });
        }
        transport.onMessage(message => {
            this.processMessage(message);
        });
        if (transport.onConnect) {
            transport.onConnect(() => {
                this.didConnect();
            });
        }
        else {
            this.didConnect();
        }
    }
    sendMessage(message) {
        this.transport.sendMessage(message);
    }
    async loadAPIs(apiName) {
        const loadedKeys = Object.keys(this.loadedAPIs);
        const keysToRequest = apiName.filter(function ($) {
            return !loadedKeys.includes($);
        });
        if (keysToRequest.length) {
            await this.call(loadAPIsNotificationName, [keysToRequest]);
            keysToRequest.forEach(async (apiName) => {
                this.loadedAPIs[apiName] = getApi(this, apiName);
            });
        }
        return this.loadedAPIs;
    }
    didConnect() {
        const injection = _injectAPIs(this);
        super.didConnect();
        injection
            .then(() => {
            if (this.systemDidEnable && !this.started) {
                this.started = true;
                try {
                    const r = this.systemDidEnable();
                    if (r && isPromiseLike(r)) {
                        r.catch(e => this.emit('error', e));
                    }
                }
                catch (e) {
                    this.emit('error', e);
                }
            }
        })
            .catch(e => this.emit('error', e));
    }
}
Script.inject = inject;
export { Script };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NyaXB0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NsaWVudC9TY3JpcHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLDJCQUEyQixDQUFBO0FBQ2xELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQTtBQUUvQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFHNUQsTUFBTSx3QkFBd0IsR0FBRyxnQkFBZ0IsQ0FBQTtBQU1qRCxNQUFNLFNBQVMsR0FBRyxPQUFPLE1BQU0sS0FBSyxVQUFVLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQTtBQUU1RCxNQUFNLGlCQUFpQixHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUE7QUFZckUsTUFBTSxVQUFVLE1BQU0sQ0FBQyxPQUFnQjtJQUNyQyxJQUFJLE9BQU8sS0FBSyxTQUFTLElBQUksQ0FBQyxPQUFPLEVBQUU7UUFDckMsTUFBTSxJQUFJLFNBQVMsQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFBO0tBQ3ZEO0lBQ0QsT0FBTyxVQUEyQixNQUFTLEVBQUUsV0FBb0I7UUFDL0QsSUFBSSxPQUFPLFdBQVcsS0FBSyxRQUFRLEVBQUU7WUFDbkMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsT0FBTyxJQUFJLFdBQVcsQ0FBQyxDQUFBO1NBQ2pFOztZQUFNLE1BQU0sSUFBSSxTQUFTLENBQUMsMENBQTBDLENBQUMsQ0FBQTtJQUN4RSxDQUFDLENBQUE7QUFDSCxDQUFDO0FBTUQsTUFBTSxVQUFVLGVBQWUsQ0FBbUIsUUFBVztJQUMzRCxNQUFNLFdBQVcsR0FBUSxRQUFRLENBQUE7SUFDakMsV0FBVyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsV0FBVyxDQUFDLGlCQUFpQixDQUFDLElBQUksSUFB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S0FBSyxDQUFDLFVBQVUsRUFBRSxDQUFBO1FBRWxCLFNBQVM7YUFDTixJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ1QsSUFBSSxJQUFJLENBQUMsZUFBZSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRTtnQkFDekMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUE7Z0JBQ25CLElBQUk7b0JBQ0YsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFBO29CQUNoQyxJQUFJLENBQUMsSUFBSSxhQUFhLENBQUMsQ0FBQyxDQUFDLEVBQUU7d0JBQ3pCLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO3FCQUNwQztpQkFDRjtnQkFBQyxPQUFPLENBQUMsRUFBRTtvQkFDVixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQTtpQkFDdEI7YUFDRjtRQUNILENBQUMsQ0FBQzthQUNELEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDdEMsQ0FBQzs7QUFwRk0sYUFBTSxHQUFHLE1BQU0sQ0FBQTtBQXVGeEIsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2xpZW50IH0gZnJvbSAnLi4vY29tbW9uL2pzb24tcnBjL0NsaWVudCdcbmltcG9ydCB7IGdldEFwaSB9IGZyb20gJy4uL2NvbW1vbi9qc29uLXJwYy9BUEknXG5pbXBvcnQgeyBJTG9nT3B0cywgU2NyaXB0aW5nVHJhbnNwb3J0IH0gZnJvbSAnLi4vY29tbW9uL2pzb24tcnBjL3R5cGVzJ1xuaW1wb3J0IHsgaXNQcm9taXNlTGlrZSB9IGZyb20gJy4uL2NvbW1vbi9jb3JlL2lzUHJvbWlzZUxpa2UnXG5cbi8qKiB0aGlzIGlzIGRlZmluZWQgaW4gdGhlIGNvbnN0cnVjdG9yIFNjcmlwdGluZ0hvc3QoKSAqL1xuY29uc3QgbG9hZEFQSXNOb3RpZmljYXRpb25OYW1lID0gJ0xvYWRDb21wb25lbnRzJ1xuXG4vLyBJZiB0aGVyZSBpcyBubyBuYXRpdmUgU3ltYm9sXG4vLyBub3IgcG9seWZpbGwsIHRoZW4gYSBwbGFpbiBudW1iZXIgaXMgdXNlZCBmb3IgcGVyZm9ybWFuY2UuXG5cbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuY29uc3QgaGFzU3ltYm9sID0gdHlwZW9mIFN5bWJvbCA9PT0gJ2Z1bmN0aW9uJyAmJiBTeW1ib2wuZm9yXG5cbmNvbnN0IGluamVjdGVkQVBJU3ltYm9sID0gaGFzU3ltYm9sID8gU3ltYm9sKCdpbmplY3RlZEFQSXMnKSA6IDB4ZmVhMFxuXG5pbnRlcmZhY2UgU2NyaXB0IHtcbiAgc3lzdGVtRGlkRW5hYmxlPygpOiBQcm9taXNlPHZvaWQ+IHwgdm9pZFxufVxuXG5leHBvcnQgdHlwZSBBUEkgPSBhbnlcblxuLyoqXG4gKiBUaGlzIGZ1bmN0aW9uIGRlY29yYXRlcyBwYXJhbWV0ZXJzIHRvIGxvYWQgQVBJc1xuICogQHBhcmFtIGFwaU5hbWUgbmFtZSBvZiB0aGUgQVBJIHRvIGxvYWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGluamVjdChhcGlOYW1lPzogc3RyaW5nKSB7XG4gIGlmIChhcGlOYW1lICE9PSB1bmRlZmluZWQgJiYgIWFwaU5hbWUpIHtcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBUEkgbmFtZSBjYW5ub3QgYmUgbnVsbCAvIGVtcHR5JylcbiAgfVxuICByZXR1cm4gZnVuY3Rpb248VCBleHRlbmRzIFNjcmlwdD4odGFyZ2V0OiBULCBwcm9wZXJ0eUtleToga2V5b2YgVCkge1xuICAgIGlmICh0eXBlb2YgcHJvcGVydHlLZXkgPT09ICdzdHJpbmcnKSB7XG4gICAgICBnZXRJbmplY3RlZEFQSXModGFyZ2V0KS5zZXQocHJvcGVydHlLZXksIGFwaU5hbWUgfHwgcHJvcGVydHlLZXkpXG4gICAgfSBlbHNlIHRocm93IG5ldyBUeXBlRXJyb3IoJ0Nhbm5vdCBpbmplY3QgQVBJcyB3aXRoIG5vbi1zdHJpbmcgbmFtZXMnKVxuICB9XG59XG5cbi8qKlxuICogR2V0cyBhbGwgdGhlIGluamVjdGVkIEFQSXMgb2YgYSBzY3JpcHRcbiAqIEBwYXJhbSBpbnN0YW5jZSBBIHNjcmlwdCB0byBnZXQgdGhlIEFQSXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldEluamVjdGVkQVBJczxUIGV4dGVuZHMgU2NyaXB0PihpbnN0YW5jZTogVCk6IE1hcDxrZXlvZiBULCBzdHJpbmc+IHtcbiAgY29uc3QgaW5zdGFuY2VBbnk6IGFueSA9IGluc3RhbmNlXG4gIGluc3RhbmNlQW55W2luamVjdGVkQVBJU3ltYm9sXSA9IGluc3RhbmNlQW55W2luamVjdGVkQVBJU3ltYm9sXSB8fCBuZXcgTWFwKClcbiAgcmV0dXJuIGluc3RhbmNlQW55W2luamVjdGVkQVBJU3ltYm9sXVxufVxuXG5hc3luYyBmdW5jdGlvbiBfaW5qZWN0QVBJcyh0YXJnZXQ6IFNjcmlwdCkge1xuICBjb25zdCBpbmplY3RlZE1hcCA9IGdldEluamVjdGVkQVBJcyh0YXJnZXQpXG5cbiAgaWYgKGluamVjdGVkTWFwLnNpemUgPT09IDApIHJldHVyblxuXG4gIGF3YWl0IHRhcmdldC5sb2FkQVBJcyhBcnJheS5mcm9tKGluamVjdGVkTWFwLnZhbHVlcygpKSlcblxuICBpbmplY3RlZE1hcC5mb3JFYWNoKGZ1bmN0aW9uKGFwaU5hbWU6IHN0cmluZywgcHJvcGVydHkpIHtcbiAgICB0YXJnZXRbcHJvcGVydHldID0gdGFyZ2V0LmxvYWRlZEFQSXNbYXBpTmFtZV1cbiAgfSlcbn1cblxuY2xhc3MgU2NyaXB0IGV4dGVuZHMgQ2xpZW50IHtcbiAgc3RhdGljIGluamVjdCA9IGluamVjdFxuXG4gIGxvYWRlZEFQSXM6IHsgW2tleTogc3RyaW5nXTogQVBJIH0gPSB7fVxuXG4gIHByb3RlY3RlZCBzdGFydGVkID0gZmFsc2VcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRyYW5zcG9ydDogU2NyaXB0aW5nVHJhbnNwb3J0LCBvcHQ/OiBJTG9nT3B0cykge1xuICAgIHN1cGVyKG9wdClcblxuICAgIGlmICh0cmFuc3BvcnQub25FcnJvcikge1xuICAgICAgdHJhbnNwb3J0Lm9uRXJyb3IoZSA9PiB7XG4gICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlKVxuICAgICAgfSlcbiAgICB9XG5cbiAgICBpZiAodHJhbnNwb3J0Lm9uQ2xvc2UpIHtcbiAgICAgIHRyYW5zcG9ydC5vbkNsb3NlKCgpID0+IHtcbiAgICAgICAgdGhpcy5lbWl0KCd0cmFuc3BvcnRDbG9zZWQnKVxuICAgICAgfSlcbiAgICB9XG5cbiAgICB0cmFuc3BvcnQub25NZXNzYWdlKG1lc3NhZ2UgPT4ge1xuICAgICAgdGhpcy5wcm9jZXNzTWVzc2FnZShtZXNzYWdlKVxuICAgIH0pXG5cbiAgICBpZiAodHJhbnNwb3J0Lm9uQ29ubmVjdCkge1xuICAgICAgdHJhbnNwb3J0Lm9uQ29ubmVjdCgoKSA9PiB7XG4gICAgICAgIHRoaXMuZGlkQ29ubmVjdCgpXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRpZENvbm5lY3QoKVxuICAgIH1cbiAgfVxuXG4gIHNlbmRNZXNzYWdlKG1lc3NhZ2U6IHN0cmluZykge1xuICAgIHRoaXMudHJhbnNwb3J0LnNlbmRNZXNzYWdlKG1lc3NhZ2UpXG4gIH1cblxuICAvKipcbiAgICogUHJvdmlkZSBhIGdsb2JhbCBwb2ludCBvZiBhY2Nlc3MgdG8gYSBzZXJ2aWNlIHdpdGhvdXRcbiAgICogY291cGxpbmcgdXNlcnMgdG8gdGhlIGNvbmNyZXRlIGNsYXNzIHRoYXQgaW1wbGVtZW50cyBpdC5cbiAgICpcbiAgICogQHBhcmFtIGFwaU5hbWUgTmFtZSBvZiB0aGUgcGx1Z2luIHdlIGFyZSB0cnlpbmcgdG8gb2J0YWluXG4gICAqIEByZXR1cm5zIHtvYmplY3R9IGxvYWRlZEFQSXNcbiAgICovXG4gIGFzeW5jIGxvYWRBUElzKGFwaU5hbWU6IHN0cmluZ1tdKTogUHJvbWlzZTx7IFtrZXk6IHN0cmluZ106IGFueSB9PiB7XG4gICAgY29uc3QgbG9hZGVkS2V5cyA9IE9iamVjdC5rZXlzKHRoaXMubG9hZGVkQVBJcylcblxuICAgIGNvbnN0IGtleXNUb1JlcXVlc3QgPSBhcGlOYW1lLmZpbHRlcihmdW5jdGlvbigkKSB7XG4gICAgICByZXR1cm4gIWxvYWRlZEtleXMuaW5jbHVkZXMoJClcbiAgICB9KVxuXG4gICAgaWYgKGtleXNUb1JlcXVlc3QubGVuZ3RoKSB7XG4gICAgICBhd2FpdCB0aGlzLmNhbGwobG9hZEFQSXNOb3RpZmljYXRpb25OYW1lLCBba2V5c1RvUmVxdWVzdF0pXG5cbiAgICAgIC8vIExvYWQgLyByZXF1ZXN0IHRoZSBBUElcbiAgICAgIGtleXNUb1JlcXVlc3QuZm9yRWFjaChhc3luYyBhcGlOYW1lID0+IHtcbiAgICAgICAgdGhpcy5sb2FkZWRBUElzW2FwaU5hbWVdID0gZ2V0QXBpKHRoaXMsIGFwaU5hbWUpXG4gICAgICB9KVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmxvYWRlZEFQSXNcbiAgfVxuXG4gIHByb3RlY3RlZCBkaWRDb25uZWN0KCkge1xuICAgIGNvbnN0IGluamVjdGlvbiA9IF9pbmplY3RBUElzKHRoaXMpXG5cbiAgICBzdXBlci5kaWRDb25uZWN0KClcblxuICAgIGluamVjdGlvblxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5zeXN0ZW1EaWRFbmFibGUgJiYgIXRoaXMuc3RhcnRlZCkge1xuICAgICAgICAgIHRoaXMuc3RhcnRlZCA9IHRydWVcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgciA9IHRoaXMuc3lzdGVtRGlkRW5hYmxlKClcbiAgICAgICAgICAgIGlmIChyICYmIGlzUHJvbWlzZUxpa2UocikpIHtcbiAgICAgICAgICAgICAgci5jYXRjaChlID0+IHRoaXMuZW1pdCgnZXJyb3InLCBlKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZSA9PiB0aGlzLmVtaXQoJ2Vycm9yJywgZSkpXG4gIH1cbn1cblxuZXhwb3J0IHsgU2NyaXB0IH1cbiJdfQ==