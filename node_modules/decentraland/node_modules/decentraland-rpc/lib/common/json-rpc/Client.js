import { EventDispatcher } from '../core/EventDispatcher';
import { createCodec, encode, decode } from 'msgpack-lite';
const codec = createCodec();
export class Client extends EventDispatcher {
    constructor(opts) {
        super();
        this.sendEncoding = 'JSON';
        this._responsePromiseMap = new Map();
        this._nextMessageId = 0;
        this._consoleLog = false;
        this._requestQueue = [];
        this._connected = false;
        this.setLogging(opts);
    }
    processMessage(messageStr) {
        let message;
        if (typeof messageStr === 'string' && messageStr.charAt(0) === '{') {
            this._logMessage(messageStr, 'receive');
            try {
                message = JSON.parse(messageStr);
            }
            catch (e) {
                return this.emit('error', e);
            }
        }
        else if (typeof messageStr === 'string' ||
            messageStr instanceof Uint8Array ||
            (typeof Buffer !== 'undefined' && messageStr instanceof Buffer) ||
            messageStr instanceof Array) {
            message = decode(messageStr, { codec });
        }
        else {
            message = messageStr;
        }
        if (!message) {
            this.emit('error', new Error(`Message cannot be null, empty or undefined`));
        }
        else if (message.id) {
            if (this._responsePromiseMap.has(message.id)) {
                const promise = this._responsePromiseMap.get(message.id);
                this._responsePromiseMap.delete(message.id);
                if ('result' in message) {
                    promise.resolve(message.result);
                }
                else if ('error' in message) {
                    const error = Object.assign(new Error('Remote error'), message.error, (message.error && message.error.data) || {});
                    promise.reject(error);
                }
                else {
                    promise.reject(Object.assign(new Error(`Response must have result or error: ${messageStr}`), {
                        code: -32700
                    }));
                }
            }
            else {
                this.emit('error', new Error(`Response with id:${message.id} has no pending request`));
            }
        }
        else if (message.method) {
            this.emit(message.method, message.params);
        }
        else {
            this.emit('error', new Error(`Invalid message: ${messageStr}`));
        }
    }
    setLogging({ logConsole } = {}) {
        this._consoleLog = !!logConsole;
    }
    call(method, params) {
        if (typeof params !== 'undefined' && typeof params !== 'object') {
            throw new Error(`Client#call Params must be structured data (Array | Object) got ${JSON.stringify(params)}`);
        }
        const id = ++this._nextMessageId;
        const message = { id, method, params, jsonrpc: '2.0' };
        return new Promise((resolve, reject) => {
            try {
                this._responsePromiseMap.set(id, { resolve, reject });
                this._send(message);
            }
            catch (error) {
                return reject(error);
            }
        });
    }
    notify(method, params) {
        if (typeof params !== 'undefined' && typeof params !== 'object') {
            throw new Error(`Client#notify Params must be structured data (Array | Object) got ${JSON.stringify(params)}`);
        }
        this._send({ method, params, jsonrpc: '2.0' });
    }
    didConnect() {
        if (this._connected === false) {
            this._connected = true;
            this._sendQueuedRequests();
        }
    }
    _send(message) {
        if (this.sendEncoding === 'msgpack') {
            this._requestQueue.push(encode(message, { codec }));
        }
        else {
            this._requestQueue.push(JSON.stringify(message));
        }
        this._sendQueuedRequests();
    }
    _sendQueuedRequests() {
        if (this._connected) {
            const queue = this._requestQueue.splice(0, this._requestQueue.length);
            for (let messageStr of queue) {
                this._logMessage(messageStr, 'send');
                this.sendMessage(messageStr);
            }
        }
    }
    _logMessage(message, direction) {
        if (this._consoleLog) {
            console.log(`Client ${direction === 'send' ? '>' : '<'}`, message.toString());
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1vbi9qc29uLXJwYy9DbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHlCQUF5QixDQUFBO0FBRXpELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLGNBQWMsQ0FBQTtBQUUxRCxNQUFNLEtBQUssR0FBRyxXQUFXLEVBQUUsQ0FBQTtBQU0zQixNQUFNLE9BQWdCLE1BQU8sU0FBUSxlQUFlO0lBU2xELFlBQVksSUFBMkI7UUFDckMsS0FBSyxFQUFFLENBQUE7UUFUVCxpQkFBWSxHQUF1QixNQUFNLENBQUE7UUFFakMsd0JBQW1CLEdBQXFDLElBQUksR0FBRyxFQUFFLENBQUE7UUFDakUsbUJBQWMsR0FBVyxDQUFDLENBQUE7UUFDMUIsZ0JBQVcsR0FBWSxLQUFLLENBQUE7UUFDNUIsa0JBQWEsR0FBd0IsRUFBRSxDQUFBO1FBQ3ZDLGVBQVUsR0FBRyxLQUFLLENBQUE7UUFJeEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUN2QixDQUFDO0lBSU0sY0FBYyxDQUNuQixVQUFtRztRQUVuRyxJQUFJLE9BQW9ELENBQUE7UUFFeEQsSUFBSSxPQUFPLFVBQVUsS0FBSyxRQUFRLElBQUksVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLEVBQUU7WUFDbEUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDLENBQUE7WUFHdkMsSUFBSTtnQkFDRixPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQTthQUNqQztZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNWLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUE7YUFDN0I7U0FDRjthQUFNLElBQ0ws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U0FDakQ7UUFDRCxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQTtJQUM1QixDQUFDO0lBRU8sbUJBQW1CO1FBQ3pCLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNuQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUNyRSxLQUFLLElBQUksVUFBVSxJQUFJLEtBQUssRUFBRTtnQkFDNUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUE7Z0JBQ3BDLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUE7YUFDN0I7U0FDRjtJQUNILENBQUM7SUFFTyxXQUFXLENBQUMsT0FBd0IsRUFBRSxTQUE2QjtRQUN6RSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDcEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLFNBQVMsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUE7U0FDOUU7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudERpc3BhdGNoZXIgfSBmcm9tICcuLi9jb3JlL0V2ZW50RGlzcGF0Y2hlcidcbmltcG9ydCAqIGFzIEpzb25ScGMyIGZyb20gJy4vdHlwZXMnXG5pbXBvcnQgeyBjcmVhdGVDb2RlYywgZW5jb2RlLCBkZWNvZGUgfSBmcm9tICdtc2dwYWNrLWxpdGUnXG5cbmNvbnN0IGNvZGVjID0gY3JlYXRlQ29kZWMoKVxuXG4vKipcbiAqIENyZWF0ZXMgYSBSUEMgQ2xpZW50LlxuICogSXQgaXMgaW50ZW50aW9uYWwgdGhhdCBDbGllbnQgZG9lcyBub3QgY3JlYXRlIGEgV2ViU29ja2V0IG9iamVjdCBzaW5jZSB3ZSBwcmVmZXIgY29tcG9zYWJpbGl0eVxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQ2xpZW50IGV4dGVuZHMgRXZlbnREaXNwYXRjaGVyIGltcGxlbWVudHMgSnNvblJwYzIuSUNsaWVudCB7XG4gIHNlbmRFbmNvZGluZzogJ0pTT04nIHwgJ21zZ3BhY2snID0gJ0pTT04nXG5cbiAgcHJpdmF0ZSBfcmVzcG9uc2VQcm9taXNlTWFwOiBNYXA8bnVtYmVyLCBKc29uUnBjMi5SZXNvbHZhYmxlPiA9IG5ldyBNYXAoKVxuICBwcml2YXRlIF9uZXh0TWVzc2FnZUlkOiBudW1iZXIgPSAwXG4gIHByaXZhdGUgX2NvbnNvbGVMb2c6IGJvb2xlYW4gPSBmYWxzZVxuICBwcml2YXRlIF9yZXF1ZXN0UXVldWU6IChzdHJpbmcgfCBCdWZmZXIpW10gPSBbXVxuICBwcml2YXRlIF9jb25uZWN0ZWQgPSBmYWxzZVxuXG4gIGNvbnN0cnVjdG9yKG9wdHM/OiBKc29uUnBjMi5JQ2xpZW50T3B0cykge1xuICAgIHN1cGVyKClcbiAgICB0aGlzLnNldExvZ2dpbmcob3B0cylcbiAgfVxuXG4gIGFic3RyYWN0IHNlbmRNZXNzYWdlKG1lc3NhZ2U6IHN0cmluZyB8IEJ1ZmZlcik6IHZvaWRcblxuICBwdWJsaWMgcHJvY2Vzc01lc3NhZ2UoXG4gICAgbWVzc2FnZVN0cjogc3RyaW5nIHwgKEpzb25ScGMyLklSZXNwb25zZSAmIEpzb25ScGMyLklOb3RpZmljYXRpb24pIHwgQnVmZmVyIHwgVWludDhBcnJheSB8IG51bWJlcltdXG4gICkge1xuICAgIGxldCBtZXNzYWdlOiBKc29uUnBjMi5JUmVzcG9uc2UgJiBKc29uUnBjMi5JTm90aWZpY2F0aW9uXG5cbiAgICBpZiAodHlwZW9mIG1lc3NhZ2VTdHIgPT09ICdzdHJpbmcnICYmIG1lc3NhZ2VTdHIuY2hhckF0KDApID09PSAneycpIHtcbiAgICAgIHRoaXMuX2xvZ01lc3NhZ2UobWVzc2FnZVN0ciwgJ3JlY2VpdmUnKVxuXG4gICAgICAvLyBFbnN1cmUgSlNPTiBpcyBub3QgbWFsZm9ybWVkXG4gICAgICB0cnkge1xuICAgICAgICBtZXNzYWdlID0gSlNPTi5wYXJzZShtZXNzYWdlU3RyKVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5lbWl0KCdlcnJvcicsIGUpXG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIHR5cGVvZiBtZXNzYWdlU3RyID09PSAnc3RyaW5nJyB8fFxuICAgICAgbWVzc2FnZVN0ciBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgLyogdHNsaW50OmRpc2FibGUtbmV4dC1saW5lICovIHx8XG4gICAgICAodHlwZW9mIEJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYgbWVzc2FnZVN0ciBpbnN0YW5jZW9mIEJ1ZmZlcikgfHxcbiAgICAgIG1lc3NhZ2VTdHIgaW5zdGFuY2VvZiBBcnJheVxuICAgICkge1xuICAgICAgbWVzc2FnZSA9IGRlY29kZShtZXNzYWdlU3RyIGFzIGFueSwgeyBjb2RlYyB9KVxuICAgIH0gZWxzZSB7XG4gICAgICBtZXNzYWdlID0gbWVzc2FnZVN0clxuICAgIH1cblxuICAgIC8vIENoZWNrIHRoYXQgbWVzc2FnZXMgaXMgd2VsbCBmb3JtZWRcbiAgICBpZiAoIW1lc3NhZ2UpIHtcbiAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBuZXcgRXJyb3IoYE1lc3NhZ2UgY2Fubm90IGJlIG51bGwsIGVtcHR5IG9yIHVuZGVmaW5lZGApKVxuICAgIH0gZWxzZSBpZiAobWVzc2FnZS5pZCkge1xuICAgICAgaWYgKHRoaXMuX3Jlc3BvbnNlUHJvbWlzZU1hcC5oYXMobWVzc2FnZS5pZCkpIHtcbiAgICAgICAgLy8gUmVzb2x2ZSBwcm9taXNlIGZyb20gcGVuZGluZyBtZXNzYWdlXG4gICAgICAgIGNvbnN0IHByb21pc2UgPSB0aGlzLl9yZXNwb25zZVByb21pc2VNYXAuZ2V0KG1lc3NhZ2UuaWQpIGFzIEpzb25ScGMyLlJlc29sdmFibGVcbiAgICAgICAgdGhpcy5fcmVzcG9uc2VQcm9taXNlTWFwLmRlbGV0ZShtZXNzYWdlLmlkKVxuXG4gICAgICAgIGlmICgncmVzdWx0JyBpbiBtZXNzYWdlKSB7XG4gICAgICAgICAgcHJvbWlzZS5yZXNvbHZlKG1lc3NhZ2UucmVzdWx0KVxuICAgICAgICB9IGVsc2UgaWYgKCdlcnJvcicgaW4gbWVzc2FnZSkge1xuICAgICAgICAgIGNvbnN0IGVycm9yID0gT2JqZWN0LmFzc2lnbihcbiAgICAgICAgICAgIG5ldyBFcnJvcignUmVtb3RlIGVycm9yJyksXG4gICAgICAgICAgICBtZXNzYWdlLmVycm9yLFxuICAgICAgICAgICAgKG1lc3NhZ2UuZXJyb3IgJiYgbWVzc2FnZS5lcnJvci5kYXRhKSB8fCB7fVxuICAgICAgICAgIClcbiAgICAgICAgICBwcm9taXNlLnJlamVjdChlcnJvcilcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBwcm9taXNlLnJlamVjdChcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24obmV3IEVycm9yKGBSZXNwb25zZSBtdXN0IGhhdmUgcmVzdWx0IG9yIGVycm9yOiAke21lc3NhZ2VTdHJ9YCksIHtcbiAgICAgICAgICAgICAgY29kZTogSnNvblJwYzIuRXJyb3JDb2RlLlBhcnNlRXJyb3JcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgbmV3IEVycm9yKGBSZXNwb25zZSB3aXRoIGlkOiR7bWVzc2FnZS5pZH0gaGFzIG5vIHBlbmRpbmcgcmVxdWVzdGApKVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAobWVzc2FnZS5tZXRob2QpIHtcbiAgICAgIC8vIFNlcnZlciBoYXMgc2VudCBhIG5vdGlmaWNhdGlvblxuICAgICAgdGhpcy5lbWl0KG1lc3NhZ2UubWV0aG9kLCBtZXNzYWdlLnBhcmFtcylcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcihgSW52YWxpZCBtZXNzYWdlOiAke21lc3NhZ2VTdHJ9YCkpXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNldCBsb2dnaW5nIGZvciBhbGwgcmVjZWl2ZWQgYW5kIHNlbnQgbWVzc2FnZXNcbiAgICovXG4gIHB1YmxpYyBzZXRMb2dnaW5nKHsgbG9nQ29uc29sZSB9OiBKc29uUnBjMi5JTG9nT3B0cyA9IHt9KSB7XG4gICAgdGhpcy5fY29uc29sZUxvZyA9ICEhbG9nQ29uc29sZVxuICB9XG5cbiAgY2FsbChtZXRob2Q6IHN0cmluZyk6IFByb21pc2U8YW55PlxuICBjYWxsKG1ldGhvZDogc3RyaW5nLCBwYXJhbXM6IHN0cmluZyk6IG5ldmVyXG4gIGNhbGwobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogbnVtYmVyKTogbmV2ZXJcbiAgY2FsbChtZXRob2Q6IHN0cmluZywgcGFyYW1zOiBib29sZWFuKTogbmV2ZXJcbiAgY2FsbChtZXRob2Q6IHN0cmluZywgcGFyYW1zOiBudWxsKTogbmV2ZXJcbiAgY2FsbDxUPihtZXRob2Q6IHN0cmluZywgcGFyYW1zOiBJdGVyYWJsZTxUPik6IFByb21pc2U8YW55PlxuICBjYWxsKG1ldGhvZDogc3RyaW5nLCBwYXJhbXM6IHsgW2tleTogc3RyaW5nXTogYW55IH0pOiBQcm9taXNlPGFueT5cbiAgY2FsbChtZXRob2Q6IHN0cmluZywgcGFyYW1zPzogYW55KSB7XG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBwYXJhbXMgIT09ICdvYmplY3QnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENsaWVudCNjYWxsIFBhcmFtcyBtdXN0IGJlIHN0cnVjdHVyZWQgZGF0YSAoQXJyYXkgfCBPYmplY3QpIGdvdCAke0pTT04uc3RyaW5naWZ5KHBhcmFtcyl9YClcbiAgICB9XG5cbiAgICBjb25zdCBpZCA9ICsrdGhpcy5fbmV4dE1lc3NhZ2VJZFxuICAgIGNvbnN0IG1lc3NhZ2U6IEpzb25ScGMyLklSZXF1ZXN0ID0geyBpZCwgbWV0aG9kLCBwYXJhbXMsIGpzb25ycGM6ICcyLjAnIH1cblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLl9yZXNwb25zZVByb21pc2VNYXAuc2V0KGlkLCB7IHJlc29sdmUsIHJlamVjdCB9KVxuICAgICAgICB0aGlzLl9zZW5kKG1lc3NhZ2UpXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICByZXR1cm4gcmVqZWN0KGVycm9yKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBub3RpZnkobWV0aG9kOiBzdHJpbmcpOiB2b2lkXG4gIG5vdGlmeShtZXRob2Q6IHN0cmluZywgcGFyYW1zOiBzdHJpbmcpOiBuZXZlclxuICBub3RpZnkobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogbnVtYmVyKTogbmV2ZXJcbiAgbm90aWZ5KG1ldGhvZDogc3RyaW5nLCBwYXJhbXM6IGJvb2xlYW4pOiBuZXZlclxuICBub3RpZnkobWV0aG9kOiBzdHJpbmcsIHBhcmFtczogbnVsbCk6IG5ldmVyXG4gIG5vdGlmeTxUPihtZXRob2Q6IHN0cmluZywgcGFyYW1zOiBJdGVyYWJsZTxUPik6IHZvaWRcbiAgbm90aWZ5KG1ldGhvZDogc3RyaW5nLCBwYXJhbXM6IHsgW2tleTogc3RyaW5nXTogYW55IH0pOiB2b2lkXG4gIG5vdGlmeShtZXRob2Q6IHN0cmluZywgcGFyYW1zPzogYW55KTogdm9pZCB7XG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBwYXJhbXMgIT09ICdvYmplY3QnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENsaWVudCNub3RpZnkgUGFyYW1zIG11c3QgYmUgc3RydWN0dXJlZCBkYXRhIChBcnJheSB8IE9iamVjdCkgZ290ICR7SlNPTi5zdHJpbmdpZnkocGFyYW1zKX1gKVxuICAgIH1cblxuICAgIHRoaXMuX3NlbmQoeyBtZXRob2QsIHBhcmFtcywganNvbnJwYzogJzIuMCcgfSlcbiAgfVxuXG4gIHByb3RlY3RlZCBkaWRDb25uZWN0KCkge1xuICAgIGlmICh0aGlzLl9jb25uZWN0ZWQgPT09IGZhbHNlKSB7XG4gICAgICB0aGlzLl9jb25uZWN0ZWQgPSB0cnVlXG4gICAgICB0aGlzLl9zZW5kUXVldWVkUmVxdWVzdHMoKVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX3NlbmQobWVzc2FnZTogSnNvblJwYzIuSU5vdGlmaWNhdGlvbiB8IEpzb25ScGMyLklSZXF1ZXN0KSB7XG4gICAgaWYgKHRoaXMuc2VuZEVuY29kaW5nID09PSAnbXNncGFjaycpIHtcbiAgICAgIHRoaXMuX3JlcXVlc3RRdWV1ZS5wdXNoKGVuY29kZShtZXNzYWdlLCB7IGNvZGVjIH0pKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9yZXF1ZXN0UXVldWUucHVzaChKU09OLnN0cmluZ2lmeShtZXNzYWdlKSlcbiAgICB9XG4gICAgdGhpcy5fc2VuZFF1ZXVlZFJlcXVlc3RzKClcbiAgfVxuXG4gIHByaXZhdGUgX3NlbmRRdWV1ZWRSZXF1ZXN0cygpIHtcbiAgICBpZiAodGhpcy5fY29ubmVjdGVkKSB7XG4gICAgICBjb25zdCBxdWV1ZSA9IHRoaXMuX3JlcXVlc3RRdWV1ZS5zcGxpY2UoMCwgdGhpcy5fcmVxdWVzdFF1ZXVlLmxlbmd0aClcbiAgICAgIGZvciAobGV0IG1lc3NhZ2VTdHIgb2YgcXVldWUpIHtcbiAgICAgICAgdGhpcy5fbG9nTWVzc2FnZShtZXNzYWdlU3RyLCAnc2VuZCcpXG4gICAgICAgIHRoaXMuc2VuZE1lc3NhZ2UobWVzc2FnZVN0cilcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9sb2dNZXNzYWdlKG1lc3NhZ2U6IHN0cmluZyB8IEJ1ZmZlciwgZGlyZWN0aW9uOiAnc2VuZCcgfCAncmVjZWl2ZScpIHtcbiAgICBpZiAodGhpcy5fY29uc29sZUxvZykge1xuICAgICAgY29uc29sZS5sb2coYENsaWVudCAke2RpcmVjdGlvbiA9PT0gJ3NlbmQnID8gJz4nIDogJzwnfWAsIG1lc3NhZ2UudG9TdHJpbmcoKSlcbiAgICB9XG4gIH1cbn1cbiJdfQ==