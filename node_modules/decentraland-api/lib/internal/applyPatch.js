"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const types_1 = require("./types");
function applyPatch(tree, diffs, createEntity) {
    let length = diffs.length;
    if (length === 0) {
        return true;
    }
    for (let i = 0; i < length; i++) {
        if (!applyDiff(tree, diffs[i], createEntity)) {
            return false;
        }
    }
    return true;
}
exports.applyPatch = applyPatch;
function getNodeFromRoute(tree, route) {
    const _route = route.slice();
    let node = tree;
    while (_route.length > 0 && node) {
        let index = _route.shift();
        node = node.getChildByIndex(index);
    }
    return node;
}
function applyDiff(tree, diff, createEntity) {
    let node = getNodeFromRoute(tree, diff[types_1.Actions.route]);
    let route;
    switch (diff[types_1.Actions.action]) {
        case types_1.Actions.addAttribute:
            if (!node) {
                return false;
            }
            // do nothing, the actual change happens inside modifyAttribute
            break;
        case types_1.Actions.modifyAttribute:
            if (!node) {
                return false;
            }
            node.setAttributes({ [diff[types_1.Actions.name]]: diff[types_1.Actions.newValue] });
            break;
        case types_1.Actions.removeAttribute:
            if (!node || !node.removeAttribute) {
                return false;
            }
            node.removeAttribute(diff[types_1.Actions.name]);
            break;
        case types_1.Actions.replaceElement:
            node.replaceBy(createEntity(diff[types_1.Actions.newValue]));
            break;
        case types_1.Actions.relocateGroup:
            const nodeArray = node
                .childEntities()
                .splice(diff[types_1.Actions.from], diff[types_1.Actions.groupLength])
                .reverse();
            const target = node.getChildByIndex(diff[types_1.Actions.to]);
            for (let i = 0; i < nodeArray.length; i++) {
                node.insertAfter(nodeArray[i], target);
            }
            break;
        case types_1.Actions.removeElement:
            node.removeFromParent();
            break;
        case types_1.Actions.addElement:
            route = diff[types_1.Actions.route].slice();
            const position = route.pop();
            node = getNodeFromRoute(tree, route);
            if (node) {
                const entity = createEntity(diff[types_1.Actions.element]);
                const beforeEntity = node.getChildByIndex(position);
                if (beforeEntity) {
                    node.insertBefore(entity, beforeEntity);
                }
                else {
                    node.add(entity);
                }
            }
            else
                return false;
            break;
        default:
            // tslint:disable-next-line:no-console
            console.log('unknown action');
    }
    return true;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbHlQYXRjaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbnRlcm5hbC9hcHBseVBhdGNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQXdDO0FBc0R4QyxTQUFTLFVBQVUsQ0FBQyxJQUFhLEVBQUUsS0FBYyxFQUFFLFlBQWdEO0lBQ2pHLElBQUksTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUE7SUFFekIsSUFBSSxNQUFNLEtBQUssQ0FBQyxFQUFFO1FBQ2hCLE9BQU8sSUFBSSxDQUFBO0tBQ1o7SUFFRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQy9CLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxZQUFZLENBQUMsRUFBRTtZQUM1QyxPQUFPLEtBQUssQ0FBQTtTQUNiO0tBQ0Y7SUFFRCxPQUFPLElBQUksQ0FBQTtBQUNiLENBQUM7QUFnRmlCLGdDQUFVO0FBOUU1QixTQUFTLGdCQUFnQixDQUFDLElBQWEsRUFBRSxLQUFlO0lBQ3RELE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQTtJQUM1QixJQUFJLElBQUksR0FBRyxJQUFJLENBQUE7SUFDZixPQUFPLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRTtRQUNoQyxJQUFJLEtBQUssR0FBVyxNQUFNLENBQUMsS0FBSyxFQUFTLENBQUE7UUFDekMsSUFBSSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUE7S0FDbkM7SUFDRCxPQUFPLElBQUksQ0FBQTtBQUNiLENBQUM7QUFFRCxTQUFTLFNBQVMsQ0FBQyxJQUFhLEVBQUUsSUFBVyxFQUFFLFlBQWdEO0lBQzdGLElBQUksSUFBSSxHQUFHLGdCQUFnQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMs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InNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFjdGlvbnMsIElEaWZmIH0gZnJvbSAnLi90eXBlcydcbmltcG9ydCB7IElTaW1wbGlmaWVkTm9kZSB9IGZyb20gJy4uJ1xuXG50eXBlIElFbnRpdHk8VCBleHRlbmRzIElTaW1wbGlmaWVkTm9kZSA9IGFueT4gPSB7XG4gIC8qKlxuICAgKiBSZWNlaXZlcyBhIGRpY3Rpb25hcnkgb2YgYXR0cmlidXRlcyBhbmQgdmFsdWVzLlxuICAgKiBJdCBpbml0aWFsaXplcyBhbmQgdXBkYXRlcyB0aGUgY29tcG9uZW50cy5cbiAgICovXG4gIHNldEF0dHJpYnV0ZXMoYXR0cnM6IHsgW2F0dHJOYW1lOiBzdHJpbmddOiBhbnkgfSk6IHZvaWRcblxuICAvKipcbiAgICogUmVtb3ZlcyBhbiBhdHRyaWJ1dGUsIGlmIGEgY29tcG9uZW50IGlzIGF0dGFjaGVkIHRvIHRoZSBhdHRyaWJ1dGUsIGl0IGFsc28gdGVhciBkb3duIHRoZSBjb21wb25lbnQuXG4gICAqL1xuICByZW1vdmVBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZTogc3RyaW5nKTogdm9pZFxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIHRoZSBlbnRpdHkgZnJvbSBpdCdzIHBhcmVudCBhbmQgYWxzbyBjbGVhbnMgdXAgYW5kXG4gICAqIHJlbGVhc2VzIGFsbCB0aGUgcmVzb3VyY2VzIHJlY3Vyc2l2ZWx5XG4gICAqL1xuICByZW1vdmVGcm9tUGFyZW50KCk6IHZvaWRcblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgbGlzdCBvZiBjaGlsZHJlbiBlbnRpdGllc1xuICAgKi9cbiAgY2hpbGRFbnRpdGllcygpOiBJRW50aXR5W11cblxuICAvKipcbiAgICogQXBwZW5kcyBhbiBlbnRpdHkgdG8gdGhpcyBlbnRpdHkuXG4gICAqIElmIHRoZSBlbnRpdHkgaGFzIGFub3RoZXIgcGFyZW50LCBpdCBmaXJzdCBzYWZlbHkgcmVtb3ZlcyBpdCBmcm9tIGl0cyBwYXJlbnQuXG4gICAqL1xuICBhZGQoZW50aXR5OiBUKTogdm9pZFxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBudGgtY2hpbGQgZW50aXR5XG4gICAqL1xuICBnZXRDaGlsZEJ5SW5kZXgoaW5kZXg6IG51bWJlcik6IFQgfCBudWxsXG5cbiAgLyoqXG4gICAqIFJlcGxhY2VzIHRoaXMgZW50aXR5IGJ5IHRoZSBuZXcgb25lLlxuICAgKiBUaGUgZW50aXR5IHRoYXQgaXMgcmVtb3ZlZCBpcyByZWxlYXNlZCBhbmQgY2Fubm90IGJlIHJlYXR0YWNoZWQgdG8gdGhlIGVudGl0eSB0cmVlLlxuICAgKi9cbiAgcmVwbGFjZUJ5KGVudGl0eTogVCk6IHZvaWRcblxuICAvKipcbiAgICogRmluZHMgYW4gZW50aXR5IGluIHRoaXMgZW50aXRpZXMgY2hpbGRyZW4gYW5kIGluc2VydHMgdGhlIGZpcnN0IGFyZ3VtZW50IGJlZm9yZSB0aGUgc2Vjb25kIG9uZSAocmVmZXJlbmNlKVxuICAgKi9cbiAgaW5zZXJ0QmVmb3JlKG5ld0l0ZW06IFQsIHJlZjogVCk6IHZvaWRcblxuICAvKipcbiAgICogRmluZHMgYW4gZW50aXR5IGluIHRoaXMgZW50aXRpZXMgY2hpbGRyZW4gYW5kIGluc2VydHMgdGhlIGZpcnN0IGFyZ3VtZW50IGFmdGVyIHRoZSBzZWNvbmQgb25lIChyZWZlcmVuY2UpXG4gICAqL1xuICBpbnNlcnRBZnRlcihuZXdJdGVtOiBULCByZWY6IFQpOiB2b2lkXG59XG5cbmZ1bmN0aW9uIGFwcGx5UGF0Y2godHJlZTogSUVudGl0eSwgZGlmZnM6IElEaWZmW10sIGNyZWF0ZUVudGl0eTogKG5vZGU6IElTaW1wbGlmaWVkTm9kZSkgPT4gSUVudGl0eSkge1xuICBsZXQgbGVuZ3RoID0gZGlmZnMubGVuZ3RoXG5cbiAgaWYgKGxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgaWYgKCFhcHBseURpZmYodHJlZSwgZGlmZnNbaV0sIGNyZWF0ZUVudGl0eSkpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB0cnVlXG59XG5cbmZ1bmN0aW9uIGdldE5vZGVGcm9tUm91dGUodHJlZTogSUVudGl0eSwgcm91dGU6IG51bWJlcltdKTogSUVudGl0eSB7XG4gIGNvbnN0IF9yb3V0ZSA9IHJvdXRlLnNsaWNlKClcbiAgbGV0IG5vZGUgPSB0cmVlXG4gIHdoaWxlIChfcm91dGUubGVuZ3RoID4gMCAmJiBub2RlKSB7XG4gICAgbGV0IGluZGV4OiBudW1iZXIgPSBfcm91dGUuc2hpZnQoKSBhcyBhbnlcbiAgICBub2RlID0gbm9kZS5nZXRDaGlsZEJ5SW5kZXgoaW5kZXgpXG4gIH1cbiAgcmV0dXJuIG5vZGVcbn1cblxuZnVuY3Rpb24gYXBwbHlEaWZmKHRyZWU6IElFbnRpdHksIGRpZmY6IElEaWZmLCBjcmVhdGVFbnRpdHk6IChub2RlOiBJU2ltcGxpZmllZE5vZGUpID0+IElFbnRpdHkpIHtcbiAgbGV0IG5vZGUgPSBnZXROb2RlRnJvbVJvdXRlKHRyZWUsIGRpZmZbQWN0aW9ucy5yb3V0ZV0pXG4gIGxldCByb3V0ZTogYW55W11cblxuICBzd2l0Y2ggKGRpZmZbQWN0aW9ucy5hY3Rpb25dKSB7XG4gICAgY2FzZSBBY3Rpb25zLmFkZEF0dHJpYnV0ZTpcbiAgICAgIGlmICghbm9kZSkge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICAgIC8vIGRvIG5vdGhpbmcsIHRoZSBhY3R1YWwgY2hhbmdlIGhhcHBlbnMgaW5zaWRlIG1vZGlmeUF0dHJpYnV0ZVxuICAgICAgYnJlYWtcbiAgICBjYXNlIEFjdGlvbnMubW9kaWZ5QXR0cmlidXRlOlxuICAgICAgaWYgKCFub2RlKSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuICAgICAgbm9kZS5zZXRBdHRyaWJ1dGVzKHsgW2RpZmZbQWN0aW9ucy5uYW1lXV06IGRpZmZbQWN0aW9ucy5uZXdWYWx1ZV0gfSlcbiAgICAgIGJyZWFrXG4gICAgY2FzZSBBY3Rpb25zLnJlbW92ZUF0dHJpYnV0ZTpcbiAgICAgIGlmICghbm9kZSB8fCAhbm9kZS5yZW1vdmVBdHRyaWJ1dGUpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9XG4gICAgICBub2RlLnJlbW92ZUF0dHJpYnV0ZShkaWZmW0FjdGlvbnMubmFtZV0pXG4gICAgICBicmVha1xuICAgIGNhc2UgQWN0aW9ucy5yZXBsYWNlRWxlbWVudDpcbiAgICAgIG5vZGUucmVwbGFjZUJ5KGNyZWF0ZUVudGl0eShkaWZmW0FjdGlvbnMubmV3VmFsdWVdKSlcbiAgICAgIGJyZWFrXG4gICAgY2FzZSBBY3Rpb25zLnJlbG9jYXRlR3JvdXA6XG4gICAgICBjb25zdCBub2RlQXJyYXkgPSBub2RlXG4gICAgICAgIC5jaGlsZEVudGl0aWVzKClcbiAgICAgICAgLnNwbGljZShkaWZmW0FjdGlvbnMuZnJvbV0sIGRpZmZbQWN0aW9ucy5ncm91cExlbmd0aF0pXG4gICAgICAgIC5yZXZlcnNlKClcblxuICAgICAgY29uc3QgdGFyZ2V0ID0gbm9kZS5nZXRDaGlsZEJ5SW5kZXgoZGlmZltBY3Rpb25zLnRvXSlcblxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlQXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgbm9kZS5pbnNlcnRBZnRlcihub2RlQXJyYXlbaV0sIHRhcmdldClcbiAgICAgIH1cbiAgICAgIGJyZWFrXG4gICAgY2FzZSBBY3Rpb25zLnJlbW92ZUVsZW1lbnQ6XG4gICAgICBub2RlLnJlbW92ZUZyb21QYXJlbnQoKVxuICAgICAgYnJlYWtcbiAgICBjYXNlIEFjdGlvbnMuYWRkRWxlbWVudDpcbiAgICAgIHJvdXRlID0gZGlmZltBY3Rpb25zLnJvdXRlXS5zbGljZSgpXG4gICAgICBjb25zdCBwb3NpdGlvbiA9IHJvdXRlLnBvcCgpXG4gICAgICBub2RlID0gZ2V0Tm9kZUZyb21Sb3V0ZSh0cmVlLCByb3V0ZSlcblxuICAgICAgaWYgKG5vZGUpIHtcbiAgICAgICAgY29uc3QgZW50aXR5ID0gY3JlYXRlRW50aXR5KGRpZmZbQWN0aW9ucy5lbGVtZW50XSlcblxuICAgICAgICBjb25zdCBiZWZvcmVFbnRpdHkgPSBub2RlLmdldENoaWxkQnlJbmRleChwb3NpdGlvbilcblxuICAgICAgICBpZiAoYmVmb3JlRW50aXR5KSB7XG4gICAgICAgICAgbm9kZS5pbnNlcnRCZWZvcmUoZW50aXR5LCBiZWZvcmVFbnRpdHkpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbm9kZS5hZGQoZW50aXR5KVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgcmV0dXJuIGZhbHNlXG4gICAgICBicmVha1xuICAgIGRlZmF1bHQ6XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZVxuICAgICAgY29uc29sZS5sb2coJ3Vua25vd24gYWN0aW9uJylcbiAgfVxuXG4gIHJldHVybiB0cnVlXG59XG5cbi8vLyAtLS0gRVhQT1JUUyAtLS1cblxuZXhwb3J0IHsgSUVudGl0eSwgYXBwbHlQYXRjaCB9XG4iXX0=