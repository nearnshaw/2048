import { TransportBasedServer } from './TransportBasedServer';
const hasSymbol = typeof Symbol === 'function' && Symbol.for;
const apiNameSymbol = hasSymbol ? Symbol('pluginName') : 0xfea2;
const registeredAPIs = {};
var PrivateHelpers;
(function (PrivateHelpers) {
    function _registerAPI(apiName, api) {
        if (apiNameSymbol in api) {
            throw new Error(`The API you are trying to register is already registered`);
        }
        if (apiName in registeredAPIs) {
            throw new Error(`The API ${apiName} is already registered`);
        }
        if (typeof api !== 'function') {
            throw new Error(`The API ${apiName} is not a class, it is of type ${typeof api}`);
        }
        ;
        api[apiNameSymbol] = apiName;
        registeredAPIs[apiName] = api;
    }
    PrivateHelpers._registerAPI = _registerAPI;
    function unmountAPI(api) {
        if (api.apiWillUnmount) {
            const promise = api.apiWillUnmount();
            if (promise && 'catch' in promise) {
                promise.catch(error => console.error('Error unmounting API', { api, error }));
            }
        }
    }
    PrivateHelpers.unmountAPI = unmountAPI;
    function mountAPI(api) {
        if (api.apiDidMount) {
            const promise = api.apiDidMount();
            if (promise && 'catch' in promise) {
                promise.catch(error => console.error('Error mounting API', { api, error }));
            }
        }
    }
    PrivateHelpers.mountAPI = mountAPI;
})(PrivateHelpers || (PrivateHelpers = {}));
export var ScriptingHostEvents;
(function (ScriptingHostEvents) {
    ScriptingHostEvents["systemWillUnmount"] = "systemWillUnmount";
    ScriptingHostEvents["systemWillEnable"] = "systemWillEnable";
    ScriptingHostEvents["systemDidUnmount"] = "systemDidUnmount";
})(ScriptingHostEvents || (ScriptingHostEvents = {}));
export function getAPIName(klass) {
    return klass[apiNameSymbol] || null;
}
export function registerAPI(apiName) {
    return function (api) {
        PrivateHelpers._registerAPI(apiName, api);
    };
}
export class ScriptingHost extends TransportBasedServer {
    constructor(worker) {
        super(worker);
        this.unmounted = false;
        this.apiInstances = new Map();
        this.expose('LoadComponents', this.RPCLoadAPIs.bind(this));
    }
    static async fromTransport(transport) {
        return new ScriptingHost(transport);
    }
    enable() {
        this.emit(ScriptingHostEvents.systemWillEnable);
        this.apiInstances.forEach(PrivateHelpers.mountAPI);
        super.enable();
    }
    getAPIInstance(api) {
        if (typeof api === 'string') {
            if (this.apiInstances.has(api)) {
                return this.apiInstances.get(api);
            }
            if (api in registeredAPIs) {
                return this.initializeAPI(registeredAPIs[api]);
            }
            return null;
        }
        else if (typeof api === 'function') {
            const apiName = getAPIName(api);
            if (apiName !== null) {
                if (this.apiInstances.has(apiName)) {
                    return this.apiInstances.get(apiName);
                }
                return this.initializeAPI(api);
            }
        }
        throw Object.assign(new Error('Cannot get instance of the specified component'), { api });
    }
    unmount() {
        if (this.unmounted)
            return;
        this.notify('SIGKILL');
        this.emit(ScriptingHostEvents.systemWillUnmount);
        try {
            this.apiInstances.forEach(PrivateHelpers.unmountAPI);
            this.apiInstances.clear();
        }
        catch (e) {
            this.emit('error', e);
        }
        this.transport.close();
        this.emit(ScriptingHostEvents.systemDidUnmount);
        this.unmounted = true;
    }
    initializeAPI(ctor) {
        const apiName = getAPIName(ctor);
        if (apiName === null) {
            throw new Error('The plugin is not registered');
        }
        if (this.apiInstances.has(apiName)) {
            return this.apiInstances.get(apiName);
        }
        const apiOptions = {
            apiName,
            on: (event, handler) => this.on(`${apiName}.${event}`, handler),
            notify: (event, params) => this.notify(`${apiName}.${event}`, params),
            expose: (event, handler) => this.expose(`${apiName}.${event}`, handler),
            getAPIInstance: (name) => {
                return this.getAPIInstance(name);
            },
            system: this
        };
        const instance = ctor.factory ? ctor.factory(ctor, apiOptions) : new ctor(apiOptions);
        this.apiInstances.set(apiName, instance);
        return instance;
    }
    async RPCLoadAPIs(apiNames) {
        if (typeof apiNames !== 'object' || !(apiNames instanceof Array)) {
            throw new TypeError('RPCLoadComponents(names) name must be an array of strings');
        }
        const notFound = apiNames
            .map(name => ({ api: this.getAPIInstance(name), name }))
            .filter($ => $.api === null)
            .map($ => $.name);
        if (notFound.length) {
            const message = `Components not found ${notFound.join(',')}`;
            throw new TypeError(message);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NyaXB0aW5nSG9zdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ob3N0L1NjcmlwdGluZ0hvc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFPN0QsTUFBTSxTQUFTLEdBQUcsT0FBTyxNQUFNLEtBQUssVUFBVSxJQUFJLE1BQU0sQ0FBQyxHQUFHLENBQUE7QUFFNUQsTUFBTSxhQUFhLEdBQVEsU0FBUyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQTtBQUVwRSxNQUFNLGNBQWMsR0FBOEIsRUFBRSxDQUFBO0FBRXBELElBQVUsY0FBYyxDQXNDdkI7QUF0Q0QsV0FBVSxjQUFjO0lBQ3RCLFNBQWdCLFlBQVksQ0FBQyxPQUFlLEVBQUUsR0FBa0I7UUFDOUQsSUFBSSxhQUFhLElBQUksR0FBRyxFQUFFO1lBQ3hCLE1BQU0sSUFBSSxLQUFLLENBQUMsMERBQTBELENBQUMsQ0FBQTtTQUM1RTtRQUVELElBQUksT0FBTyxJQUFJLGNBQWMsRUFBRTtZQUM3QixNQUFNLElBQUksS0FBSyxDQUFDLFdBQVcsT0FBTyx3QkFBd0IsQ0FBQyxDQUFBO1NBQzVEO1FBRUQsSUFBSSxPQUFRLEdBQVcsS0FBSyxVQUFVLEVBQUU7WUFDdEMsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLE9BQU8sa0NBQWtDLE9BQU8sR0FBRyxFQUFFLENBQUMsQ0FBQTtTQUNsRjtRQUlELENBQUM7UUFBQyxHQUFXLENBQUMsYUFBYSxDQUFDLEdBQUcsT0FBTyxDQUFBO1FBRXRDLGNBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUE7SUFDL0IsQ0FBQztJQWxCZSwyQkFBWSxlQWtCM0IsQ0FBQTtJQUVELFNBQWdCLFVBQVUsQ0FBQyxHQUFRO1FBQ2pDLElBQUksR0FBRyxDQUFDLGNBQWMsRUFBRTtZQUN0QixNQUFN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V0FBVyxDQUFDLFFBQWtCO1FBRTFDLElBQUksT0FBTyxRQUFRLEtBQUssUUFBUSxJQUFJLENBQUMsQ0FBQyxRQUFRLFlBQVksS0FBSyxDQUFDLEVBQUU7WUFDaEUsTUFBTSxJQUFJLFNBQVMsQ0FBQywyREFBMkQsQ0FBQyxDQUFBO1NBQ2pGO1FBRUQsTUFBTSxRQUFRLEdBQUcsUUFBUTthQUN0QixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQzthQUN2RCxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLElBQUksQ0FBQzthQUMzQixHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFbkIsSUFBSSxRQUFRLENBQUMsTUFBTSxFQUFFO1lBQ25CLE1BQU0sT0FBTyxHQUFHLHdCQUF3QixRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUE7WUFDNUQsTUFBTSxJQUFJLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQTtTQUM3QjtJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpY3Rpb25hcnkgfSBmcm9tICcuLi9jb21tb24vY29yZS9FdmVudERpc3BhdGNoZXInXG5pbXBvcnQgeyBUcmFuc3BvcnRCYXNlZFNlcnZlciB9IGZyb20gJy4vVHJhbnNwb3J0QmFzZWRTZXJ2ZXInXG5pbXBvcnQgeyBBUElDbGFzcywgQVBJLCBBUElPcHRpb25zIH0gZnJvbSAnLi9BUEknXG5pbXBvcnQgeyBTY3JpcHRpbmdUcmFuc3BvcnQgfSBmcm9tICcuLi9jb21tb24vanNvbi1ycGMvdHlwZXMnXG5cbi8vIElmIHRoZXJlIGlzIG5vIG5hdGl2ZSBTeW1ib2xcbi8vIG5vciBwb2x5ZmlsbCwgdGhlbiBhIHBsYWluIG51bWJlciBpcyB1c2VkIGZvciBwZXJmb3JtYW5jZS5cbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuY29uc3QgaGFzU3ltYm9sID0gdHlwZW9mIFN5bWJvbCA9PT0gJ2Z1bmN0aW9uJyAmJiBTeW1ib2wuZm9yXG5cbmNvbnN0IGFwaU5hbWVTeW1ib2w6IGFueSA9IGhhc1N5bWJvbCA/IFN5bWJvbCgncGx1Z2luTmFtZScpIDogMHhmZWEyXG5cbmNvbnN0IHJlZ2lzdGVyZWRBUElzOiBEaWN0aW9uYXJ5PEFQSUNsYXNzPEFQST4+ID0ge31cblxubmFtZXNwYWNlIFByaXZhdGVIZWxwZXJzIHtcbiAgZXhwb3J0IGZ1bmN0aW9uIF9yZWdpc3RlckFQSShhcGlOYW1lOiBzdHJpbmcsIGFwaTogQVBJQ2xhc3M8QVBJPikge1xuICAgIGlmIChhcGlOYW1lU3ltYm9sIGluIGFwaSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgQVBJIHlvdSBhcmUgdHJ5aW5nIHRvIHJlZ2lzdGVyIGlzIGFscmVhZHkgcmVnaXN0ZXJlZGApXG4gICAgfVxuXG4gICAgaWYgKGFwaU5hbWUgaW4gcmVnaXN0ZXJlZEFQSXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIEFQSSAke2FwaU5hbWV9IGlzIGFscmVhZHkgcmVnaXN0ZXJlZGApXG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiAoYXBpIGFzIGFueSkgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIEFQSSAke2FwaU5hbWV9IGlzIG5vdCBhIGNsYXNzLCBpdCBpcyBvZiB0eXBlICR7dHlwZW9mIGFwaX1gKVxuICAgIH1cblxuICAgIC8vIHNhdmUgdGhlIHJlZ2lzdGVyZWQgbmFtZVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzZW1pY29sb25cbiAgICA7KGFwaSBhcyBhbnkpW2FwaU5hbWVTeW1ib2xdID0gYXBpTmFtZVxuXG4gICAgcmVnaXN0ZXJlZEFQSXNbYXBpTmFtZV0gPSBhcGlcbiAgfVxuXG4gIGV4cG9ydCBmdW5jdGlvbiB1bm1vdW50QVBJKGFwaTogQVBJKSB7XG4gICAgaWYgKGFwaS5hcGlXaWxsVW5tb3VudCkge1xuICAgICAgY29uc3QgcHJvbWlzZSA9IGFwaS5hcGlXaWxsVW5tb3VudCgpXG4gICAgICBpZiAocHJvbWlzZSAmJiAnY2F0Y2gnIGluIHByb21pc2UpIHtcbiAgICAgICAgcHJvbWlzZS5jYXRjaChlcnJvciA9PiBjb25zb2xlLmVycm9yKCdFcnJvciB1bm1vdW50aW5nIEFQSScsIHsgYXBpLCBlcnJvciB9KSlcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBleHBvcnQgZnVuY3Rpb24gbW91bnRBUEkoYXBpOiBBUEkpIHtcbiAgICBpZiAoYXBpLmFwaURpZE1vdW50KSB7XG4gICAgICBjb25zdCBwcm9taXNlID0gYXBpLmFwaURpZE1vdW50KClcbiAgICAgIGlmIChwcm9taXNlICYmICdjYXRjaCcgaW4gcHJvbWlzZSkge1xuICAgICAgICBwcm9taXNlLmNhdGNoKGVycm9yID0+IGNvbnNvbGUuZXJyb3IoJ0Vycm9yIG1vdW50aW5nIEFQSScsIHsgYXBpLCBlcnJvciB9KSlcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuLy8gSEVSRSBXRSBTVEFSVCBUSEUgRVhQT1JUU1xuXG5leHBvcnQgZW51bSBTY3JpcHRpbmdIb3N0RXZlbnRzIHtcbiAgc3lzdGVtV2lsbFVubW91bnQgPSAnc3lzdGVtV2lsbFVubW91bnQnLFxuICBzeXN0ZW1XaWxsRW5hYmxlID0gJ3N5c3RlbVdpbGxFbmFibGUnLFxuICBzeXN0ZW1EaWRVbm1vdW50ID0gJ3N5c3RlbURpZFVubW91bnQnXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRBUElOYW1lKGtsYXNzOiBBUElDbGFzczxBUEk+KTogc3RyaW5nIHwgbnVsbCB7XG4gIHJldHVybiAoa2xhc3MgYXMgYW55KVthcGlOYW1lU3ltYm9sXSB8fCBudWxsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWdpc3RlckFQSShhcGlOYW1lOiBzdHJpbmcpOiAoa2xhc3M6IEFQSUNsYXNzPEFQST4pID0+IHZvaWQge1xuICByZXR1cm4gZnVuY3Rpb24oYXBpOiBBUElDbGFzczxBUEk+KSB7XG4gICAgUHJpdmF0ZUhlbHBlcnMuX3JlZ2lzdGVyQVBJKGFwaU5hbWUsIGFwaSlcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgU2NyaXB0aW5nSG9zdCBleHRlbmRzIFRyYW5zcG9ydEJhc2VkU2VydmVyIHtcbiAgdW5tb3VudGVkID0gZmFsc2VcblxuICBhcGlJbnN0YW5jZXM6IE1hcDxzdHJpbmcsIEFQST4gPSBuZXcgTWFwKClcblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKHdvcmtlcjogU2NyaXB0aW5nVHJhbnNwb3J0KSB7XG4gICAgc3VwZXIod29ya2VyKVxuXG4gICAgdGhpcy5leHBvc2UoJ0xvYWRDb21wb25lbnRzJywgdGhpcy5SUENMb2FkQVBJcy5iaW5kKHRoaXMpKVxuICB9XG5cbiAgc3RhdGljIGFzeW5jIGZyb21UcmFuc3BvcnQodHJhbnNwb3J0OiBTY3JpcHRpbmdUcmFuc3BvcnQpIHtcbiAgICByZXR1cm4gbmV3IFNjcmlwdGluZ0hvc3QodHJhbnNwb3J0KVxuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aGRvZCBzaG91bGQgYmUgY2FsbGVkIG9ubHkgZnJvbSB0aGUgaW50ZXJmYWNlIHRoYXQgbWFuYWdlcyB0aGUgU2NyaXB0aW5nSG9zdHMuXG4gICAqIEl0IGluaXRpYWxpemVzIHRoZSBzeXN0ZW0gYW5kIGl0J3MgcXVldWVkIGNvbXBvbmVudHMuIEl0IGFsc28gc2VuZHMgYSBmaXJzdCBub3RpZmljYXRpb25cbiAgICogdG8gdGhlIGltcGxlbWVudGF0aW9uIG9mIHRoZSBzeXN0ZW0gdGVsbGluZyBpdCBpcyBub3cgZW5hYmxlZC4gSW4gdGhhdCBtb21lbnQsIHRoZVxuICAgKiBpbXBsZW1lbnRhdGlvbiB3aWxsIHNlbmQgdGhlIHF1ZXVlZCBtZXNzYWdlcyBhbmQgZXhlY3V0ZSB0aGUgcXVldWVkIG1ldGhvZHMgYWdhaW5zdCB0aGVcbiAgICogbWF0ZXJpYWxpemVkIGNvbXBvbmVudHMuXG4gICAqXG4gICAqIEl0OlxuICAgKiAgMSkgZW1pdHMgYSBDb21wb25lbnRTeXN0ZW1FdmVudHMuc3lzdGVtV2lsbEVuYWJsZSBldmVudFxuICAgKiAgMikgbW91bnRzIGFsbCB0aGUgY29tcG9uZW50c1xuICAgKiAgMykgc2VuZHMgdGhlIG5vdGlmaWNhdGlvbiB0byB0aGUgYWN0dWFsIHN5c3RlbSBpbXBsZW1lbnRhdGlvblxuICAgKi9cbiAgZW5hYmxlKCkge1xuICAgIHRoaXMuZW1pdChTY3JpcHRpbmdIb3N0RXZlbnRzLnN5c3RlbVdpbGxFbmFibGUpXG4gICAgdGhpcy5hcGlJbnN0YW5jZXMuZm9yRWFjaChQcml2YXRlSGVscGVycy5tb3VudEFQSSlcbiAgICBzdXBlci5lbmFibGUoKVxuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgaXMgYSBzZXJ2aWNlIGxvY2F0b3IsIGl0IGxvY2F0ZXMgb3IgaW5zdGFudGlhdGUgdGhlIHJlcXVlc3RlZCBjb21wb25lbnRcbiAgICogZm9yIHRoaXMgaW5zdGFuY2Ugb2YgQ29tcG9uZW50U3lzdGVtLlxuICAgKlxuICAgKiBAcGFyYW0gYXBpIEEgY2xhc3MgY29uc3RydWN0b3JcbiAgICovXG4gIGdldEFQSUluc3RhbmNlPFg+KGFwaTogeyBuZXcgKG9wdGlvbnM6IEFQSU9wdGlvbnMpOiBYIH0pOiBYXG5cbiAgLyoqXG4gICAqIFRoaXMgaXMgYSBzZXJ2aWNlIGxvY2F0b3IsIGl0IGxvY2F0ZXMgb3IgaW5zdGFudGlhdGUgdGhlIHJlcXVlc3RlZCBjb21wb25lbnRcbiAgICogZm9yIHRoaXMgaW5zdGFuY2Ugb2YgQ29tcG9uZW50U3lzdGVtLlxuICAgKlxuICAgKiBAcGFyYW0gbmFtZSBUaGUgbmFtZSBvZiB1c2VkIHRvIHJlZ2lzdGVyIHRoZSBjb21wb25lbnRcbiAgICovXG4gIGdldEFQSUluc3RhbmNlKG5hbWU6IHN0cmluZyk6IEFQSSB8IG51bGxcblxuICBnZXRBUElJbnN0YW5jZShhcGk6IGFueSkge1xuICAgIGlmICh0eXBlb2YgYXBpID09PSAnc3RyaW5nJykge1xuICAgICAgaWYgKHRoaXMuYXBpSW5zdGFuY2VzLmhhcyhhcGkpKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwaUluc3RhbmNlcy5nZXQoYXBpKVxuICAgICAgfVxuICAgICAgaWYgKGFwaSBpbiByZWdpc3RlcmVkQVBJcykge1xuICAgICAgICByZXR1cm4gdGhpcy5pbml0aWFsaXplQVBJKHJlZ2lzdGVyZWRBUElzW2FwaV0pXG4gICAgICB9XG4gICAgICByZXR1cm4gbnVsbFxuICAgIH0gZWxzZSBpZiAodHlwZW9mIGFwaSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgY29uc3QgYXBpTmFtZSA9IGdldEFQSU5hbWUoYXBpKVxuXG4gICAgICAvLyBpZiBpdCBoYXMgYSBuYW1lLCB1c2UgdGhhdCBpbmRpcmVjdGlvbiB0byBmaW5kIGluIHRoZSBpbnN0YW5jZSdzIG1hcFxuICAgICAgaWYgKGFwaU5hbWUgIT09IG51bGwpIHtcbiAgICAgICAgaWYgKHRoaXMuYXBpSW5zdGFuY2VzLmhhcyhhcGlOYW1lKSkge1xuICAgICAgICAgIHJldHVybiB0aGlzLmFwaUluc3RhbmNlcy5nZXQoYXBpTmFtZSlcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIElmIHdlIGRvbid0IGhhdmUgYSBsb2NhbCBpbnN0YW5jZSwgY3JlYXRlIHRoZSBpbnN0YW5jZSBvZiB0aGUgY29tcG9uZW50XG4gICAgICAgIHJldHVybiB0aGlzLmluaXRpYWxpemVBUEkoYXBpKVxuICAgICAgfVxuICAgIH1cblxuICAgIHRocm93IE9iamVjdC5hc3NpZ24obmV3IEVycm9yKCdDYW5ub3QgZ2V0IGluc3RhbmNlIG9mIHRoZSBzcGVjaWZpZWQgY29tcG9uZW50JyksIHsgYXBpIH0pXG4gIH1cblxuICAvKipcbiAgICogVGhpcyBtZXRob2QgdW5tb3VudHMgYWxsIHRoZSBjb21wb25lbnRzIGFuZCByZWxlYXNlcyB0aGUgV29ya2VyXG4gICAqL1xuICB1bm1vdW50KCkge1xuICAgIGlmICh0aGlzLnVubW91bnRlZCkgcmV0dXJuXG4gICAgdGhpcy5ub3RpZnkoJ1NJR0tJTEwnKVxuXG4gICAgdGhpcy5lbWl0KFNjcmlwdGluZ0hvc3RFdmVudHMuc3lzdGVtV2lsbFVubW91bnQpXG5cbiAgICB0cnkge1xuICAgICAgdGhpcy5hcGlJbnN0YW5jZXMuZm9yRWFjaChQcml2YXRlSGVscGVycy51bm1vdW50QVBJKVxuICAgICAgdGhpcy5hcGlJbnN0YW5jZXMuY2xlYXIoKVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlKVxuICAgIH1cblxuICAgIHRoaXMudHJhbnNwb3J0LmNsb3NlKClcblxuICAgIHRoaXMuZW1pdChTY3JpcHRpbmdIb3N0RXZlbnRzLnN5c3RlbURpZFVubW91bnQpXG5cbiAgICB0aGlzLnVubW91bnRlZCA9IHRydWVcbiAgfVxuXG4gIHByb3RlY3RlZCBpbml0aWFsaXplQVBJPFggZXh0ZW5kcyBBUEk+KGN0b3I6IHtcbiAgICBuZXcgKG9wdGlvbnM6IEFQSU9wdGlvbnMpOiBYXG4gICAgZmFjdG9yeT8oY3RvcjogeyBuZXcgKG9wdGlvbnM6IEFQSU9wdGlvbnMpOiBYIH0sIG9wdGlvbnM6IEFQSU9wdGlvbnMpOiBYXG4gIH0pOiBYIHtcbiAgICBjb25zdCBhcGlOYW1lID0gZ2V0QVBJTmFtZShjdG9yKVxuXG4gICAgaWYgKGFwaU5hbWUgPT09IG51bGwpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIHBsdWdpbiBpcyBub3QgcmVnaXN0ZXJlZCcpXG4gICAgfVxuXG4gICAgaWYgKHRoaXMuYXBpSW5zdGFuY2VzLmhhcyhhcGlOYW1lKSkge1xuICAgICAgcmV0dXJuIHRoaXMuYXBpSW5zdGFuY2VzLmdldChhcGlOYW1lKSBhcyBYXG4gICAgfVxuXG4gICAgY29uc3QgYXBpT3B0aW9uczogQVBJT3B0aW9ucyA9IHtcbiAgICAgIGFwaU5hbWUsXG4gICAgICBvbjogKGV2ZW50LCBoYW5kbGVyKSA9PiB0aGlzLm9uKGAke2FwaU5hbWV9LiR7ZXZlbnR9YCwgaGFuZGxlciksXG4gICAgICBub3RpZnk6IChldmVudCwgcGFyYW1zPykgPT4gdGhpcy5ub3RpZnkoYCR7YXBpTmFtZX0uJHtldmVudH1gLCBwYXJhbXMpLFxuICAgICAgZXhwb3NlOiAoZXZlbnQsIGhhbmRsZXIpID0+IHRoaXMuZXhwb3NlKGAke2FwaU5hbWV9LiR7ZXZlbnR9YCwgaGFuZGxlciksXG4gICAgICBnZXRBUElJbnN0YW5jZTogKG5hbWU6IGFueSkgPT4ge1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmVcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QVBJSW5zdGFuY2UobmFtZSkgYXMgYW55XG4gICAgICB9LFxuICAgICAgc3lzdGVtOiB0aGlzXG4gICAgfVxuXG4gICAgY29uc3QgaW5zdGFuY2UgPSBjdG9yLmZhY3RvcnkgPyBjdG9yLmZhY3RvcnkoY3RvciwgYXBpT3B0aW9ucykgOiBuZXcgY3RvcihhcGlPcHRpb25zKVxuXG4gICAgdGhpcy5hcGlJbnN0YW5jZXMuc2V0KGFwaU5hbWUsIGluc3RhbmNlKVxuXG4gICAgcmV0dXJuIGluc3RhbmNlXG4gIH1cblxuICAvKipcbiAgICogUHJlbG9hZHMgYSBsaXN0IG9mIGNvbXBvbmVudHNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgUlBDTG9hZEFQSXMoYXBpTmFtZXM6IHN0cmluZ1tdKSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXG4gICAgaWYgKHR5cGVvZiBhcGlOYW1lcyAhPT0gJ29iamVjdCcgfHwgIShhcGlOYW1lcyBpbnN0YW5jZW9mIEFycmF5KSkge1xuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignUlBDTG9hZENvbXBvbmVudHMobmFtZXMpIG5hbWUgbXVzdCBiZSBhbiBhcnJheSBvZiBzdHJpbmdzJylcbiAgICB9XG5cbiAgICBjb25zdCBub3RGb3VuZCA9IGFwaU5hbWVzXG4gICAgICAubWFwKG5hbWUgPT4gKHsgYXBpOiB0aGlzLmdldEFQSUluc3RhbmNlKG5hbWUpLCBuYW1lIH0pKVxuICAgICAgLmZpbHRlcigkID0+ICQuYXBpID09PSBudWxsKVxuICAgICAgLm1hcCgkID0+ICQubmFtZSlcblxuICAgIGlmIChub3RGb3VuZC5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgQ29tcG9uZW50cyBub3QgZm91bmQgJHtub3RGb3VuZC5qb2luKCcsJyl9YFxuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihtZXNzYWdlKVxuICAgIH1cbiAgfVxufVxuIl19