#!/usr/bin/env node
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const webpack = require("webpack");
const globPkg = require("glob");
const rimraf = require("rimraf");
const fs = require("fs");
const path_1 = require("path");
const TsconfigPathsPlugin = require('tsconfig-paths-webpack-plugin');
const child_process_1 = require("child_process");
const os_1 = require("os");
const ProgressBar = require("progress");
const chalk_1 = require("chalk");
const packageJson = JSON.parse(fs.readFileSync(require.resolve('../package.json')).toString());
const isWatching = process.argv.some($ => $ === '--watch');
const instrumentCoverage = process.argv.some($ => $ === '--coverage') || process.env.NODE_ENV === 'coverage';
const isProduction = process.env.NODE_ENV !== 'development' && !isWatching && !instrumentCoverage;
const webWorkerTransport = path_1.resolve(__dirname, '../lib/common/transports/WebWorker');
const entryPointWebWorker = (filename) => `
import { WebWorkerTransport } from ${JSON.stringify(webWorkerTransport)}
const imported = require(${JSON.stringify(filename)})

if (imported && imported.__esModule && imported['default']) {
  new imported['default'](WebWorkerTransport(self))
}
`;
console.log('decentraland-compiler version: ' + chalk_1.default.green(packageJson.version));
function findConfigFile(baseDir, configFileName) {
    let configFilePath = path_1.resolve(baseDir, configFileName);
    if (fs.existsSync(configFilePath)) {
        return configFilePath;
    }
    if (baseDir.length === path_1.dirname(baseDir).length) {
        return null;
    }
    return findConfigFile(path_1.resolve(baseDir, '../'), configFileName);
}
exports.findConfigFile = findConfigFile;
function compile(opt) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((onSuccess, onError) => {
            let entry = opt.files;
            const extensions = ['.ts', '.tsx', '.js', '.json'];
            if (opt.target === 'webworker') {
                entry = entry.map($ => {
                    const file = path_1.resolve(os_1.tmpdir(), Math.random().toString() + '.WebWorker.js');
                    fs.writeFileSync(file, entryPointWebWorker($));
                    return file;
                });
            }
            entry = entry.reduce((obj, $, $$) => {
                let name = path_1.relative(opt.rootFolder, opt.files[$$]);
                extensions.forEach($ => {
                    if (name.endsWith($)) {
                        name = name.substr(0, name.length - $.length);
                    }
                });
                let target = name;
                if (target.endsWith('.js')) {
                    target = target.substr(0, target.length - 3);
                }
                obj[target] = $;
                return obj;
            }, {});
            console.log([
                `     files:`,
                ...Object.keys(entry).map(($, $$) => `            (root)/${path_1.relative(opt.rootFolder, opt.files[$$])} -> (outDir)/${$}.js`)
            ].join('\n'));
            const options = {
                entry,
                mode: isProduction ? 'production' : 'development',
                optimization: {
                    nodeEnv: isProduction ? 'production' : 'development',
                    namedModules: !isProduction,
                    minimize: isProduction
                },
                output: {
                    path: opt.outDir,
                    libraryTarget: opt.target === 'webworker' ? 'this' : 'umd'
                },
                resolve: {
                    extensions,
                    plugins: [new TsconfigPathsPlugin({ configFile: opt.tsconfig })]
                },
                watch: isWatching,
                module: {
                    rules: [
                        {
                            test: /\.(jpe?g|png|gif|svg)$/i,
                            use: [
                                {
                                    loader: require.resolve('url-loader'),
                                    options: {
                                        limit: 512000
                                    }
                                }
                            ]
                        },
                        {
                            test: /\.tsx?$/,
                            loader: require.resolve('ts-loader'),
                            options: {
                                configFile: opt.tsconfig
                            }
                        }
                    ]
                },
                target: opt.target,
                plugins: [ProgressBarPlugin({})]
            };
            if (opt.coverage) {
                ;
                options.module.rules.push({
                    test: /\.[jt]sx?$/,
                    use: {
                        loader: 'istanbul-instrumenter-loader',
                        options: { esModules: true, sourceMaps: true }
                    },
                    enforce: 'post',
                    exclude: /node_modules|\.spec\.js$/
                });
            }
            const compiler = webpack(options);
            if (!isWatching) {
                compiler.run((err, stats) => {
                    if (err) {
                        onError(err);
                    }
                    else {
                        onSuccess(stats);
                    }
                });
            }
            else {
                compiler.watch({ ignored: /node_modules/, aggregateTimeout: 1000 }, (err, stats) => {
                    if (stats.hasErrors() || stats.hasWarnings()) {
                        console.log(stats.toString({
                            colors: true,
                            errors: true,
                            warnings: true
                        }));
                    }
                    else {
                        console.log('OK ' + opt.outDir);
                    }
                    if (!err) {
                        onSuccess(stats);
                    }
                });
            }
        });
    });
}
exports.compile = compile;
function tsc(tsconfig) {
    return __awaiter(this, void 0, void 0, function* () {
        const tscLocation = require.resolve('typescript/lib/tsc');
        console.log(`
    Executing "tsc -p ${path_1.basename(tsconfig)}" in ${path_1.dirname(tsconfig)}
  `.trim());
        const args = [tscLocation, '-p', path_1.basename(tsconfig)];
        if (isWatching) {
            args.push('--watch');
        }
        const childProcess = child_process_1.spawn('node', args, {
            cwd: path_1.dirname(tsconfig)
        });
        if (isWatching) {
            return true;
        }
        let resolve = a => void 0;
        let reject = a => void 0;
        const semaphore = new Promise((ok, err) => {
            resolve = ok;
            reject = err;
        });
        childProcess.stdout.on('data', data => {
            console.log(`tsc stdout: ${data}`);
        });
        childProcess.stderr.on('data', data => {
            console.log(`tsc stderr: ${data}`);
        });
        childProcess.on('close', exitCode => {
            if (exitCode) {
                reject(exitCode);
            }
            else {
                resolve(exitCode);
            }
        });
        yield semaphore;
    });
}
exports.tsc = tsc;
function processFile(opt) {
    return __awaiter(this, void 0, void 0, function* () {
        const baseFiles = (opt.file && [opt.file]) || (opt.files && opt.files[0]) || [];
        if (!baseFiles.length) {
            throw new Error(`Unable to find a file to compile`);
        }
        const baseFile = baseFiles[0];
        if (baseFile.endsWith('.json')) {
            return processJson(baseFile);
        }
        const parsed = path_1.parse(baseFile);
        const configFile = findConfigFile(path_1.dirname(baseFile), 'tsconfig.json');
        if (!configFile) {
            throw new Error(`Unable to find a tsconfig.json file for ${opt.file}`);
        }
        const rootFolder = path_1.dirname(configFile);
        const parsedTsConfig = require(configFile);
        let outFile = opt.outFile
            ? path_1.resolve(process.cwd(), opt.outFile)
            : parsedTsConfig.compilerOptions.outFile
                ? path_1.resolve(path_1.dirname(configFile), parsedTsConfig.compilerOptions.outFile)
                : parsed.name + '.js';
        const outDir = parsedTsConfig.compilerOptions.outDir
            ? path_1.resolve(path_1.dirname(configFile), parsedTsConfig.compilerOptions.outDir)
            : path_1.dirname(outFile);
        if (outFile.startsWith(outDir)) {
            outFile = outFile.replace(outDir + '/', '');
        }
        const coverage = !isWatching && (opt.coverage || instrumentCoverage);
        const options = {
            files: opt.files || [opt.file],
            outDir,
            tsconfig: configFile,
            coverage: coverage,
            target: opt.target || 'web',
            rootFolder
        };
        console.log(`
      root: ${options.rootFolder}
    outDir: ${options.outDir}
   options: { coverage: ${coverage}, production: ${isProduction}, watch: ${isWatching} }`);
        const result = yield compile(options);
        if (result.hasErrors() || result.hasWarnings()) {
            console.log(result.toString({
                assets: true,
                colors: true,
                entrypoints: true,
                env: true,
                errors: true,
                publicPath: true
            }));
        }
    });
}
exports.processFile = processFile;
function glob(path) {
    return __awaiter(this, void 0, void 0, function* () {
        return new Promise((onSuccess, onFailure) => {
            globPkg(path, { absolute: true }, (err, values) => {
                if (err) {
                    onFailure(err);
                }
                else {
                    onSuccess(values);
                }
            });
        });
    });
}
exports.glob = glob;
function cli(args) {
    return __awaiter(this, void 0, void 0, function* () {
        const files = yield glob(process.argv[2]);
        yield Promise.all(files.map($ => processFile({ file: $, outFile: args[3] })));
    });
}
exports.cli = cli;
function processJson(file) {
    return __awaiter(this, void 0, void 0, function* () {
        const config = require(file);
        if (!config || !(config instanceof Array)) {
            throw new Error(`Config file ${file} is not a valid sequence of steps`);
        }
        if (config.length === 0) {
            throw new Error(`Config file ${file} describes no compilation steps`);
        }
        for (let i = 0; i < config.length; i++) {
            const $ = config[i];
            if ($.kind === 'RM') {
                if (!isWatching) {
                    console.log(`
          Deleting folder: ${$.path}
        `.trim());
                    rimraf.sync($.path);
                }
            }
            else if ($.kind === 'Webpack') {
                const files = yield glob($.file);
                yield processFile(Object.assign({}, $, { files }));
            }
            else if ($.kind === 'TSC') {
                if (!$.config) {
                    throw new Error(`Missing config in: ${JSON.stringify($, null, 2)}`);
                }
                yield tsc($.config);
            }
            else {
                console.error(`Unknown compilation step ${JSON.stringify($, null, 2)}`);
            }
        }
    });
}
exports.processJson = processJson;
cli(process.argv)
    .then(() => {
    if (isWatching) {
        console.log('The compiler is watching file changes...');
        process.stdin.resume();
    }
})
    .catch(err => {
    console.error(err);
    process.exit(1);
});
process.on('unhandledRejection', e => {
    throw e;
});
function ProgressBarPlugin(options) {
    options = options || {};
    let stream = options.stream || process.stderr;
    let enabled = stream && stream.isTTY;
    if (!enabled) {
        return function () {
        };
    }
    let barLeft = chalk_1.default.bold('[');
    let barRight = chalk_1.default.bold(']');
    let preamble = chalk_1.default.cyan.bold('  build ') + barLeft;
    let barFormat = options.format || preamble + ':bar' + barRight + chalk_1.default.green.bold(' :percent');
    let summary = options.summary !== false;
    let summaryContent = options.summaryContent;
    let customSummary = options.customSummary;
    delete options.format;
    delete options.total;
    delete options.summary;
    delete options.summaryContent;
    delete options.customSummary;
    let barOptions = Object.assign({
        complete: '=',
        incomplete: ' ',
        width: 20,
        total: 100,
        clear: true
    }, options);
    let bar = new ProgressBar(barFormat, barOptions);
    let running = false;
    let startTime = new Date();
    let lastPercent = 0;
    return new webpack.ProgressPlugin(function (percent, msg) {
        if (!running && lastPercent !== 0 && !customSummary) {
            stream.write('\n');
        }
        let newPercent = Math.ceil(percent * barOptions.width);
        if (lastPercent !== newPercent) {
            bar.update(percent, {
                msg: msg
            });
            lastPercent = newPercent;
        }
        if (!running) {
            running = true;
            startTime = new Date();
            lastPercent = 0;
        }
        else if (percent === 1) {
            let now = new Date();
            let buildTime = (now.getTime() - startTime.getTime()) / 1000 + 's';
            bar.terminate();
            if (summary) {
                stream.write(chalk_1.default.green.bold('Build completed in ' + buildTime + '\n\n'));
            }
            else if (summaryContent) {
                stream.write('    ' + summaryContent + '(' + buildTime + ')\n\n');
            }
            if (customSummary) {
                customSummary(buildTime);
            }
            running = false;
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbXBpbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFJQSxtQ0FBa0M7QUFDbEMsZ0NBQStCO0FBQy9CLGlDQUFnQztBQUNoQyx5QkFBd0I7QUFDeEIsK0JBQStFO0FBQy9FLE1BQU0sbUJBQW1CLEdBQUcsT0FBTyxDQUFDLCtCQUErQixDQUFDLENBQUE7QUFDcEUsaURBQXFDO0FBQ3JDLDJCQUEyQjtBQUMzQix3Q0FBd0M7QUFDeEMsaUNBQXlCO0FBRXpCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFBO0FBQzlGLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFBO0FBQzFELE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssWUFBWSxDQUFDLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssVUFBVSxDQUFBO0FBQzVHLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLGFBQWEsSUFBSSxDQUFDLFVBQVUsSUFBSSxDQUFDLGtCQUFrQixDQUFBO0FBQ2pHLE1BQU0sa0JBQWtCLEdBQUcsY0FBTyxDQUFDLFNBQVMsRUFBRSxvQ0FBb0MsQ0FBQyxDQUFBO0FBRW5GLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxRQUFnQixFQUFFLEVBQUUsQ0FBQztxQ0FDYixJQUFJLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDOzJCQUM1QyxJQUFJLENBQUMsU0FBUyxDQUFDLFFB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Q0FBQTtTQUN6QjtRQUVELElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDWixPQUFPLEdBQUcsSUFBSSxDQUFBO1lBQ2QsU0FBUyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUE7WUFDdEIsV0FBVyxHQUFHLENBQUMsQ0FBQTtTQUNoQjthQUFNLElBQUksT0FBTyxLQUFLLENBQUMsRUFBRTtZQUN4QixJQUFJLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFBO1lBQ3BCLElBQUksU0FBUyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxHQUFHLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxHQUFHLElBQUksR0FBRyxHQUFHLENBQUE7WUFFbEUsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFBO1lBRWYsSUFBSSxPQUFPLEVBQUU7Z0JBQ1gsTUFBTSxDQUFDLEtBQUssQ0FBQyxlQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxTQUFTLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQTthQUMzRTtpQkFBTSxJQUFJLGNBQWMsRUFBRTtnQkFDekIsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsY0FBYyxHQUFHLEdBQUcsR0FBRyxTQUFTLEdBQUcsT0FBTyxDQUFDLENBQUE7YUFDbEU7WUFFRCxJQUFJLGFBQWEsRUFBRTtnQkFDakIsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFBO2FBQ3pCO1lBRUQsT0FBTyxHQUFHLEtBQUssQ0FBQTtTQUNoQjtJQUNILENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIiMhL3Vzci9iaW4vZW52IG5vZGVcblxuLy8gVGhpcyBzdGFydGVkIGFzIHNvbWV0aGluZyBkaWZmZXJlbnQgYXMgaXQgaXMgcmlnaHQgbm93LiBJdCBiZWNhbWUgZ3VscC5cblxuaW1wb3J0ICogYXMgd2VicGFjayBmcm9tICd3ZWJwYWNrJ1xuaW1wb3J0ICogYXMgZ2xvYlBrZyBmcm9tICdnbG9iJ1xuaW1wb3J0ICogYXMgcmltcmFmIGZyb20gJ3JpbXJhZidcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJ1xuaW1wb3J0IHsgcmVzb2x2ZSwgcGFyc2UgYXMgcGFyc2VQYXRoLCBkaXJuYW1lLCBiYXNlbmFtZSwgcmVsYXRpdmUgfSBmcm9tICdwYXRoJ1xuY29uc3QgVHNjb25maWdQYXRoc1BsdWdpbiA9IHJlcXVpcmUoJ3RzY29uZmlnLXBhdGhzLXdlYnBhY2stcGx1Z2luJylcbmltcG9ydCB7IHNwYXduIH0gZnJvbSAnY2hpbGRfcHJvY2VzcydcbmltcG9ydCB7IHRtcGRpciB9IGZyb20gJ29zJ1xuaW1wb3J0IFByb2dyZXNzQmFyID0gcmVxdWlyZSgncHJvZ3Jlc3MnKVxuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJ1xuXG5jb25zdCBwYWNrYWdlSnNvbiA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKHJlcXVpcmUucmVzb2x2ZSgnLi4vcGFja2FnZS5qc29uJykpLnRvU3RyaW5nKCkpXG5jb25zdCBpc1dhdGNoaW5nID0gcHJvY2Vzcy5hcmd2LnNvbWUoJCA9PiAkID09PSAnLS13YXRjaCcpXG5jb25zdCBpbnN0cnVtZW50Q292ZXJhZ2UgPSBwcm9jZXNzLmFyZ3Yuc29tZSgkID0+ICQgPT09ICctLWNvdmVyYWdlJykgfHwgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdjb3ZlcmFnZSdcbmNvbnN0IGlzUHJvZHVjdGlvbiA9IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAnZGV2ZWxvcG1lbnQnICYmICFpc1dhdGNoaW5nICYmICFpbnN0cnVtZW50Q292ZXJhZ2VcbmNvbnN0IHdlYldvcmtlclRyYW5zcG9ydCA9IHJlc29sdmUoX19kaXJuYW1lLCAnLi4vbGliL2NvbW1vbi90cmFuc3BvcnRzL1dlYldvcmtlcicpXG5cbmNvbnN0IGVudHJ5UG9pbnRXZWJXb3JrZXIgPSAoZmlsZW5hbWU6IHN0cmluZykgPT4gYFxuaW1wb3J0IHsgV2ViV29ya2VyVHJhbnNwb3J0IH0gZnJvbSAke0pTT04uc3RyaW5naWZ5KHdlYldvcmtlclRyYW5zcG9ydCl9XG5jb25zdCBpbXBvcnRlZCA9IHJlcXVpcmUoJHtKU09OLnN0cmluZ2lmeShmaWxlbmFtZSl9KVxuXG5pZiAoaW1wb3J0ZWQgJiYgaW1wb3J0ZWQuX19lc01vZHVsZSAmJiBpbXBvcnRlZFsnZGVmYXVsdCddKSB7XG4gIG5ldyBpbXBvcnRlZFsnZGVmYXVsdCddKFdlYldvcmtlclRyYW5zcG9ydChzZWxmKSlcbn1cbmBcblxuY29uc29sZS5sb2coJ2RlY2VudHJhbGFuZC1jb21waWxlciB2ZXJzaW9uOiAnICsgY2hhbGsuZ3JlZW4ocGFja2FnZUpzb24udmVyc2lvbikpXG5cbmV4cG9ydCBmdW5jdGlvbiBmaW5kQ29uZmlnRmlsZShiYXNlRGlyOiBzdHJpbmcsIGNvbmZpZ0ZpbGVOYW1lOiBzdHJpbmcpOiBzdHJpbmcgfCBudWxsIHtcbiAgbGV0IGNvbmZpZ0ZpbGVQYXRoID0gcmVzb2x2ZShiYXNlRGlyLCBjb25maWdGaWxlTmFtZSlcblxuICBpZiAoZnMuZXhpc3RzU3luYyhjb25maWdGaWxlUGF0aCkpIHtcbiAgICByZXR1cm4gY29uZmlnRmlsZVBhdGhcbiAgfVxuXG4gIGlmIChiYXNlRGlyLmxlbmd0aCA9PT0gZGlybmFtZShiYXNlRGlyKS5sZW5ndGgpIHtcbiAgICByZXR1cm4gbnVsbFxuICB9XG5cbiAgcmV0dXJuIGZpbmRDb25maWdGaWxlKHJlc29sdmUoYmFzZURpciwgJy4uLycpLCBjb25maWdGaWxlTmFtZSlcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQ29tcGlsZXJPcHRpb25zIHtcbiAgZmlsZXM6IHN0cmluZ1tdXG4gIG91dERpcjogc3RyaW5nXG4gIHRzY29uZmlnOiBzdHJpbmdcbiAgdGFyZ2V0PzogJ3dlYicgfCAnd2Vid29ya2VyJyB8ICdub2RlJ1xuICBjb3ZlcmFnZT86IGJvb2xlYW5cbiAgcm9vdEZvbGRlcjogc3RyaW5nXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb21waWxlKG9wdDogSUNvbXBpbGVyT3B0aW9ucykge1xuICByZXR1cm4gbmV3IFByb21pc2U8d2VicGFjay5TdGF0cz4oKG9uU3VjY2Vzcywgb25FcnJvcikgPT4ge1xuICAgIGxldCBlbnRyeTogd2VicGFjay5FbnRyeSB8IHN0cmluZ1tdID0gb3B0LmZpbGVzXG5cbiAgICBjb25zdCBleHRlbnNpb25zID0gWycudHMnLCAnLnRzeCcsICcuanMnLCAnLmpzb24nXVxuXG4gICAgaWYgKG9wdC50YXJnZXQgPT09ICd3ZWJ3b3JrZXInKSB7XG4gICAgICBlbnRyeSA9IGVudHJ5Lm1hcCgkID0+IHtcbiAgICAgICAgY29uc3QgZmlsZSA9IHJlc29sdmUodG1wZGlyKCksIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoKSArICcuV2ViV29ya2VyLmpzJylcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhmaWxlLCBlbnRyeVBvaW50V2ViV29ya2VyKCQpKVxuICAgICAgICByZXR1cm4gZmlsZVxuICAgICAgfSlcbiAgICB9XG5cbiAgICBlbnRyeSA9IGVudHJ5LnJlZHVjZShcbiAgICAgIChvYmosICQsICQkKSA9PiB7XG4gICAgICAgIGxldCBuYW1lID0gcmVsYXRpdmUob3B0LnJvb3RGb2xkZXIsIG9wdC5maWxlc1skJF0pXG4gICAgICAgIGV4dGVuc2lvbnMuZm9yRWFjaCgkID0+IHtcbiAgICAgICAgICBpZiAobmFtZS5lbmRzV2l0aCgkKSkge1xuICAgICAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyKDAsIG5hbWUubGVuZ3RoIC0gJC5sZW5ndGgpXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICBsZXQgdGFyZ2V0ID0gbmFtZVxuICAgICAgICBpZiAodGFyZ2V0LmVuZHNXaXRoKCcuanMnKSkge1xuICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5zdWJzdHIoMCwgdGFyZ2V0Lmxlbmd0aCAtIDMpXG4gICAgICAgIH1cbiAgICAgICAgb2JqW3RhcmdldF0gPSAkXG4gICAgICAgIHJldHVybiBvYmpcbiAgICAgIH0sXG4gICAgICB7fSBhcyB3ZWJwYWNrLkVudHJ5XG4gICAgKVxuXG4gICAgY29uc29sZS5sb2coXG4gICAgICBbXG4gICAgICAgIGAgICAgIGZpbGVzOmAsXG4gICAgICAgIC4uLk9iamVjdC5rZXlzKGVudHJ5KS5tYXAoXG4gICAgICAgICAgKCQsICQkKSA9PiBgICAgICAgICAgICAgKHJvb3QpLyR7cmVsYXRpdmUob3B0LnJvb3RGb2xkZXIsIG9wdC5maWxlc1skJF0pfSAtPiAob3V0RGlyKS8keyR9LmpzYFxuICAgICAgICApXG4gICAgICBdLmpvaW4oJ1xcbicpXG4gICAgKVxuXG4gICAgY29uc3Qgb3B0aW9uczogd2VicGFjay5Db25maWd1cmF0aW9uID0ge1xuICAgICAgZW50cnksXG4gICAgICBtb2RlOiBpc1Byb2R1Y3Rpb24gPyAncHJvZHVjdGlvbicgOiAnZGV2ZWxvcG1lbnQnLFxuICAgICAgb3B0aW1pemF0aW9uOiB7XG4gICAgICAgIG5vZGVFbnY6IGlzUHJvZHVjdGlvbiA/ICdwcm9kdWN0aW9uJyA6ICdkZXZlbG9wbWVudCcsXG4gICAgICAgIG5hbWVkTW9kdWxlczogIWlzUHJvZHVjdGlvbixcbiAgICAgICAgbWluaW1pemU6IGlzUHJvZHVjdGlvblxuICAgICAgfSxcbiAgICAgIG91dHB1dDoge1xuICAgICAgICBwYXRoOiBvcHQub3V0RGlyLFxuICAgICAgICBsaWJyYXJ5VGFyZ2V0OiBvcHQudGFyZ2V0ID09PSAnd2Vid29ya2VyJyA/ICd0aGlzJyA6ICd1bWQnXG4gICAgICB9LFxuXG4gICAgICByZXNvbHZlOiB7XG4gICAgICAgIC8vIEFkZCAnLnRzJyBhbmQgJy50c3gnIGFzIHJlc29sdmFibGUgZXh0ZW5zaW9ucy5cbiAgICAgICAgZXh0ZW5zaW9ucyxcbiAgICAgICAgcGx1Z2luczogW25ldyBUc2NvbmZpZ1BhdGhzUGx1Z2luKHsgY29uZmlnRmlsZTogb3B0LnRzY29uZmlnIH0pXVxuICAgICAgfSxcbiAgICAgIHdhdGNoOiBpc1dhdGNoaW5nLFxuICAgICAgbW9kdWxlOiB7XG4gICAgICAgIHJ1bGVzOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgdGVzdDogL1xcLihqcGU/Z3xwbmd8Z2lmfHN2ZykkL2ksXG4gICAgICAgICAgICB1c2U6IFtcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGxvYWRlcjogcmVxdWlyZS5yZXNvbHZlKCd1cmwtbG9hZGVyJyksXG4gICAgICAgICAgICAgICAgb3B0aW9uczoge1xuICAgICAgICAgICAgICAgICAgbGltaXQ6IDUxMjAwMFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgXVxuICAgICAgICAgIH0sXG4gICAgICAgICAgLy8gQWxsIGZpbGVzIHdpdGggYSAnLnRzJyBvciAnLnRzeCcgZXh0ZW5zaW9uIHdpbGwgYmUgaGFuZGxlZCBieSAnYXdlc29tZS10eXBlc2NyaXB0LWxvYWRlcicuXG4gICAgICAgICAge1xuICAgICAgICAgICAgdGVzdDogL1xcLnRzeD8kLyxcbiAgICAgICAgICAgIGxvYWRlcjogcmVxdWlyZS5yZXNvbHZlKCd0cy1sb2FkZXInKSxcbiAgICAgICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgY29uZmlnRmlsZTogb3B0LnRzY29uZmlnXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICB9LFxuICAgICAgdGFyZ2V0OiBvcHQudGFyZ2V0LFxuICAgICAgcGx1Z2luczogW1Byb2dyZXNzQmFyUGx1Z2luKHt9KV1cbiAgICB9XG5cbiAgICBpZiAob3B0LmNvdmVyYWdlKSB7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6c2VtaWNvbG9uXG4gICAgICA7KG9wdGlvbnMubW9kdWxlIGFzIGFueSkucnVsZXMucHVzaCh7XG4gICAgICAgIHRlc3Q6IC9cXC5banRdc3g/JC8sXG4gICAgICAgIHVzZToge1xuICAgICAgICAgIGxvYWRlcjogJ2lzdGFuYnVsLWluc3RydW1lbnRlci1sb2FkZXInLFxuICAgICAgICAgIG9wdGlvbnM6IHsgZXNNb2R1bGVzOiB0cnVlLCBzb3VyY2VNYXBzOiB0cnVlIH1cbiAgICAgICAgfSxcbiAgICAgICAgZW5mb3JjZTogJ3Bvc3QnLFxuICAgICAgICBleGNsdWRlOiAvbm9kZV9tb2R1bGVzfFxcLnNwZWNcXC5qcyQvXG4gICAgICB9KVxuICAgIH1cblxuICAgIGNvbnN0IGNvbXBpbGVyID0gd2VicGFjayhvcHRpb25zKVxuXG4gICAgaWYgKCFpc1dhdGNoaW5nKSB7XG4gICAgICBjb21waWxlci5ydW4oKGVyciwgc3RhdHMpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIG9uRXJyb3IoZXJyKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG9uU3VjY2VzcyhzdGF0cylcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgY29tcGlsZXIud2F0Y2goeyBpZ25vcmVkOiAvbm9kZV9tb2R1bGVzLywgYWdncmVnYXRlVGltZW91dDogMTAwMCB9LCAoZXJyLCBzdGF0cykgPT4ge1xuICAgICAgICBpZiAoc3RhdHMuaGFzRXJyb3JzKCkgfHwgc3RhdHMuaGFzV2FybmluZ3MoKSkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgc3RhdHMudG9TdHJpbmcoe1xuICAgICAgICAgICAgICBjb2xvcnM6IHRydWUsXG4gICAgICAgICAgICAgIGVycm9yczogdHJ1ZSxcbiAgICAgICAgICAgICAgd2FybmluZ3M6IHRydWVcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdPSyAnICsgb3B0Lm91dERpcilcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghZXJyKSB7XG4gICAgICAgICAgb25TdWNjZXNzKHN0YXRzKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cbiAgfSlcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHRzYyh0c2NvbmZpZzogc3RyaW5nKSB7XG4gIGNvbnN0IHRzY0xvY2F0aW9uID0gcmVxdWlyZS5yZXNvbHZlKCd0eXBlc2NyaXB0L2xpYi90c2MnKVxuXG4gIGNvbnNvbGUubG9nKFxuICAgIGBcbiAgICBFeGVjdXRpbmcgXCJ0c2MgLXAgJHtiYXNlbmFtZSh0c2NvbmZpZyl9XCIgaW4gJHtkaXJuYW1lKHRzY29uZmlnKX1cbiAgYC50cmltKClcbiAgKVxuXG4gIGNvbnN0IGFyZ3MgPSBbdHNjTG9jYXRpb24sICctcCcsIGJhc2VuYW1lKHRzY29uZmlnKV1cblxuICBpZiAoaXNXYXRjaGluZykge1xuICAgIGFyZ3MucHVzaCgnLS13YXRjaCcpXG4gIH1cblxuICBjb25zdCBjaGlsZFByb2Nlc3MgPSBzcGF3bignbm9kZScsIGFyZ3MsIHtcbiAgICBjd2Q6IGRpcm5hbWUodHNjb25maWcpXG4gIH0pXG5cbiAgaWYgKGlzV2F0Y2hpbmcpIHtcbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgbGV0IHJlc29sdmU6ICh4OiBhbnkpID0+IGFueSA9IGEgPT4gdm9pZCAwXG4gIGxldCByZWplY3Q6ICh4OiBhbnkpID0+IGFueSA9IGEgPT4gdm9pZCAwXG5cbiAgY29uc3Qgc2VtYXBob3JlID0gbmV3IFByb21pc2UoKG9rLCBlcnIpID0+IHtcbiAgICByZXNvbHZlID0gb2tcbiAgICByZWplY3QgPSBlcnJcbiAgfSlcblxuICBjaGlsZFByb2Nlc3Muc3Rkb3V0Lm9uKCdkYXRhJywgZGF0YSA9PiB7XG4gICAgY29uc29sZS5sb2coYHRzYyBzdGRvdXQ6ICR7ZGF0YX1gKVxuICB9KVxuXG4gIGNoaWxkUHJvY2Vzcy5zdGRlcnIub24oJ2RhdGEnLCBkYXRhID0+IHtcbiAgICBjb25zb2xlLmxvZyhgdHNjIHN0ZGVycjogJHtkYXRhfWApXG4gIH0pXG5cbiAgY2hpbGRQcm9jZXNzLm9uKCdjbG9zZScsIGV4aXRDb2RlID0+IHtcbiAgICBpZiAoZXhpdENvZGUpIHtcbiAgICAgIHJlamVjdChleGl0Q29kZSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzb2x2ZShleGl0Q29kZSlcbiAgICB9XG4gIH0pXG5cbiAgYXdhaXQgc2VtYXBob3JlXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwcm9jZXNzRmlsZShvcHQ6IHtcbiAgZmlsZT86IHN0cmluZ1xuICBmaWxlcz86IHN0cmluZ1tdXG4gIG91dEZpbGU/OiBzdHJpbmdcbiAgd2F0Y2g/OiBib29sZWFuXG4gIHRhcmdldD86IHN0cmluZ1xuICBjb3ZlcmFnZT86IGJvb2xlYW5cbn0pIHtcbiAgY29uc3QgYmFzZUZpbGVzID0gKG9wdC5maWxlICYmIFtvcHQuZmlsZV0pIHx8IChvcHQuZmlsZXMgJiYgb3B0LmZpbGVzWzBdKSB8fCBbXVxuXG4gIGlmICghYmFzZUZpbGVzLmxlbmd0aCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGZpbmQgYSBmaWxlIHRvIGNvbXBpbGVgKVxuICB9XG5cbiAgY29uc3QgYmFzZUZpbGUgPSBiYXNlRmlsZXNbMF1cblxuICBpZiAoYmFzZUZpbGUuZW5kc1dpdGgoJy5qc29uJykpIHtcbiAgICByZXR1cm4gcHJvY2Vzc0pzb24oYmFzZUZpbGUpXG4gIH1cblxuICBjb25zdCBwYXJzZWQgPSBwYXJzZVBhdGgoYmFzZUZpbGUpXG5cbiAgY29uc3QgY29uZmlnRmlsZSA9IGZpbmRDb25maWdGaWxlKGRpcm5hbWUoYmFzZUZpbGUpLCAndHNjb25maWcuanNvbicpXG5cbiAgaWYgKCFjb25maWdGaWxlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gZmluZCBhIHRzY29uZmlnLmpzb24gZmlsZSBmb3IgJHtvcHQuZmlsZX1gKVxuICB9XG5cbiAgY29uc3Qgcm9vdEZvbGRlciA9IGRpcm5hbWUoY29uZmlnRmlsZSlcblxuICBjb25zdCBwYXJzZWRUc0NvbmZpZyA9IHJlcXVpcmUoY29uZmlnRmlsZSlcblxuICBsZXQgb3V0RmlsZSA9IG9wdC5vdXRGaWxlXG4gICAgPyByZXNvbHZlKHByb2Nlc3MuY3dkKCksIG9wdC5vdXRGaWxlKVxuICAgIDogcGFyc2VkVHNDb25maWcuY29tcGlsZXJPcHRpb25zLm91dEZpbGVcbiAgICAgID8gcmVzb2x2ZShkaXJuYW1lKGNvbmZpZ0ZpbGUpLCBwYXJzZWRUc0NvbmZpZy5jb21waWxlck9wdGlvbnMub3V0RmlsZSlcbiAgICAgIDogcGFyc2VkLm5hbWUgKyAnLmpzJ1xuXG4gIGNvbnN0IG91dERpciA9IHBhcnNlZFRzQ29uZmlnLmNvbXBpbGVyT3B0aW9ucy5vdXREaXJcbiAgICA/IHJlc29sdmUoZGlybmFtZShjb25maWdGaWxlKSwgcGFyc2VkVHNDb25maWcuY29tcGlsZXJPcHRpb25zLm91dERpcilcbiAgICA6IGRpcm5hbWUob3V0RmlsZSlcblxuICBpZiAob3V0RmlsZS5zdGFydHNXaXRoKG91dERpcikpIHtcbiAgICBvdXRGaWxlID0gb3V0RmlsZS5yZXBsYWNlKG91dERpciArICcvJywgJycpXG4gIH1cblxuICBjb25zdCBjb3ZlcmFnZSA9ICFpc1dhdGNoaW5nICYmIChvcHQuY292ZXJhZ2UgfHwgaW5zdHJ1bWVudENvdmVyYWdlKVxuXG4gIGNvbnN0IG9wdGlvbnM6IElDb21waWxlck9wdGlvbnMgPSB7XG4gICAgZmlsZXM6IG9wdC5maWxlcyB8fCBbb3B0LmZpbGUgYXMgc3RyaW5nXSxcbiAgICBvdXREaXIsXG4gICAgdHNjb25maWc6IGNvbmZpZ0ZpbGUsXG4gICAgY292ZXJhZ2U6IGNvdmVyYWdlLFxuICAgIHRhcmdldDogKG9wdC50YXJnZXQgYXMgYW55KSB8fCAnd2ViJyxcbiAgICByb290Rm9sZGVyXG4gIH1cblxuICBjb25zb2xlLmxvZyhgXG4gICAgICByb290OiAke29wdGlvbnMucm9vdEZvbGRlcn1cbiAgICBvdXREaXI6ICR7b3B0aW9ucy5vdXREaXJ9XG4gICBvcHRpb25zOiB7IGNvdmVyYWdlOiAke2NvdmVyYWdlfSwgcHJvZHVjdGlvbjogJHtpc1Byb2R1Y3Rpb259LCB3YXRjaDogJHtpc1dhdGNoaW5nfSB9YClcblxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBjb21waWxlKG9wdGlvbnMpXG5cbiAgaWYgKHJlc3VsdC5oYXNFcnJvcnMoKSB8fCByZXN1bHQuaGFzV2FybmluZ3MoKSkge1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgcmVzdWx0LnRvU3RyaW5nKHtcbiAgICAgICAgYXNzZXRzOiB0cnVlLFxuICAgICAgICBjb2xvcnM6IHRydWUsXG4gICAgICAgIGVudHJ5cG9pbnRzOiB0cnVlLFxuICAgICAgICBlbnY6IHRydWUsXG4gICAgICAgIGVycm9yczogdHJ1ZSxcbiAgICAgICAgcHVibGljUGF0aDogdHJ1ZVxuICAgICAgfSlcbiAgICApXG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdsb2IocGF0aDogc3RyaW5nKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmdbXT4oKG9uU3VjY2Vzcywgb25GYWlsdXJlKSA9PiB7XG4gICAgZ2xvYlBrZyhwYXRoLCB7IGFic29sdXRlOiB0cnVlIH0sIChlcnIsIHZhbHVlcykgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBvbkZhaWx1cmUoZXJyKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb25TdWNjZXNzKHZhbHVlcylcbiAgICAgIH1cbiAgICB9KVxuICB9KVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2xpKGFyZ3M6IHN0cmluZ1tdKSB7XG4gIGNvbnN0IGZpbGVzID0gYXdhaXQgZ2xvYihwcm9jZXNzLmFyZ3ZbMl0pXG5cbiAgYXdhaXQgUHJvbWlzZS5hbGwoZmlsZXMubWFwKCQgPT4gcHJvY2Vzc0ZpbGUoeyBmaWxlOiAkLCBvdXRGaWxlOiBhcmdzWzNdIH0pKSlcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NKc29uKGZpbGU6IHN0cmluZykge1xuICBjb25zdCBjb25maWc6IGFueVtdID0gcmVxdWlyZShmaWxlKVxuXG4gIGlmICghY29uZmlnIHx8ICEoY29uZmlnIGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb25maWcgZmlsZSAke2ZpbGV9IGlzIG5vdCBhIHZhbGlkIHNlcXVlbmNlIG9mIHN0ZXBzYClcbiAgfVxuXG4gIGlmIChjb25maWcubGVuZ3RoID09PSAwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb25maWcgZmlsZSAke2ZpbGV9IGRlc2NyaWJlcyBubyBjb21waWxhdGlvbiBzdGVwc2ApXG4gIH1cblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbmZpZy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0ICQgPSBjb25maWdbaV1cblxuICAgIGlmICgkLmtpbmQgPT09ICdSTScpIHtcbiAgICAgIGlmICghaXNXYXRjaGluZykge1xuICAgICAgICAvLyBkZWxldGUgYSBmb2xkZXJcbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgYFxuICAgICAgICAgIERlbGV0aW5nIGZvbGRlcjogJHskLnBhdGh9XG4gICAgICAgIGAudHJpbSgpXG4gICAgICAgIClcbiAgICAgICAgcmltcmFmLnN5bmMoJC5wYXRoKVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoJC5raW5kID09PSAnV2VicGFjaycpIHtcbiAgICAgIC8vIGNvbXBpbGUgVFNcbiAgICAgIGNvbnN0IGZpbGVzID0gYXdhaXQgZ2xvYigkLmZpbGUpXG5cbiAgICAgIGF3YWl0IHByb2Nlc3NGaWxlKHsgLi4uJCwgZmlsZXMgfSlcbiAgICB9IGVsc2UgaWYgKCQua2luZCA9PT0gJ1RTQycpIHtcbiAgICAgIGlmICghJC5jb25maWcpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIGNvbmZpZyBpbjogJHtKU09OLnN0cmluZ2lmeSgkLCBudWxsLCAyKX1gKVxuICAgICAgfVxuXG4gICAgICBhd2FpdCB0c2MoJC5jb25maWcpXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYFVua25vd24gY29tcGlsYXRpb24gc3RlcCAke0pTT04uc3RyaW5naWZ5KCQsIG51bGwsIDIpfWApXG4gICAgfVxuICB9XG59XG5cbmNsaShwcm9jZXNzLmFyZ3YpXG4gIC50aGVuKCgpID0+IHtcbiAgICBpZiAoaXNXYXRjaGluZykge1xuICAgICAgY29uc29sZS5sb2coJ1RoZSBjb21waWxlciBpcyB3YXRjaGluZyBmaWxlIGNoYW5nZXMuLi4nKVxuICAgICAgcHJvY2Vzcy5zdGRpbi5yZXN1bWUoKVxuICAgIH1cbiAgfSlcbiAgLmNhdGNoKGVyciA9PiB7XG4gICAgY29uc29sZS5lcnJvcihlcnIpXG4gICAgcHJvY2Vzcy5leGl0KDEpXG4gIH0pXG5cbnByb2Nlc3Mub24oJ3VuaGFuZGxlZFJlamVjdGlvbicsIGUgPT4ge1xuICB0aHJvdyBlXG59KVxuXG5mdW5jdGlvbiBQcm9ncmVzc0JhclBsdWdpbihvcHRpb25zOiBhbnkpIHtcbiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge31cblxuICBsZXQgc3RyZWFtID0gb3B0aW9ucy5zdHJlYW0gfHwgcHJvY2Vzcy5zdGRlcnJcbiAgbGV0IGVuYWJsZWQgPSBzdHJlYW0gJiYgc3RyZWFtLmlzVFRZXG5cbiAgaWYgKCFlbmFibGVkKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgICAgLy8gc3R1YlxuICAgIH1cbiAgfVxuXG4gIGxldCBiYXJMZWZ0ID0gY2hhbGsuYm9sZCgnWycpXG4gIGxldCBiYXJSaWdodCA9IGNoYWxrLmJvbGQoJ10nKVxuICBsZXQgcHJlYW1ibGUgPSBjaGFsay5jeWFuLmJvbGQoJyAgYnVpbGQgJykgKyBiYXJMZWZ0XG4gIGxldCBiYXJGb3JtYXQgPSBvcHRpb25zLmZvcm1hdCB8fCBwcmVhbWJsZSArICc6YmFyJyArIGJhclJpZ2h0ICsgY2hhbGsuZ3JlZW4uYm9sZCgnIDpwZXJjZW50JylcbiAgbGV0IHN1bW1hcnkgPSBvcHRpb25zLnN1bW1hcnkgIT09IGZhbHNlXG4gIGxldCBzdW1tYXJ5Q29udGVudCA9IG9wdGlvbnMuc3VtbWFyeUNvbnRlbnRcbiAgbGV0IGN1c3RvbVN1bW1hcnkgPSBvcHRpb25zLmN1c3RvbVN1bW1hcnlcblxuICBkZWxldGUgb3B0aW9ucy5mb3JtYXRcbiAgZGVsZXRlIG9wdGlvbnMudG90YWxcbiAgZGVsZXRlIG9wdGlvbnMuc3VtbWFyeVxuICBkZWxldGUgb3B0aW9ucy5zdW1tYXJ5Q29udGVudFxuICBkZWxldGUgb3B0aW9ucy5jdXN0b21TdW1tYXJ5XG5cbiAgbGV0IGJhck9wdGlvbnMgPSBPYmplY3QuYXNzaWduKFxuICAgIHtcbiAgICAgIGNvbXBsZXRlOiAnPScsXG4gICAgICBpbmNvbXBsZXRlOiAnICcsXG4gICAgICB3aWR0aDogMjAsXG4gICAgICB0b3RhbDogMTAwLFxuICAgICAgY2xlYXI6IHRydWVcbiAgICB9LFxuICAgIG9wdGlvbnNcbiAgKVxuXG4gIGxldCBiYXIgPSBuZXcgUHJvZ3Jlc3NCYXIoYmFyRm9ybWF0LCBiYXJPcHRpb25zKVxuXG4gIGxldCBydW5uaW5nID0gZmFsc2VcbiAgbGV0IHN0YXJ0VGltZTogRGF0ZSA9IG5ldyBEYXRlKClcbiAgbGV0IGxhc3RQZXJjZW50ID0gMFxuXG4gIHJldHVybiBuZXcgd2VicGFjay5Qcm9ncmVzc1BsdWdpbihmdW5jdGlvbihwZXJjZW50LCBtc2cpIHtcbiAgICBpZiAoIXJ1bm5pbmcgJiYgbGFzdFBlcmNlbnQgIT09IDAgJiYgIWN1c3RvbVN1bW1hcnkpIHtcbiAgICAgIHN0cmVhbS53cml0ZSgnXFxuJylcbiAgICB9XG5cbiAgICBsZXQgbmV3UGVyY2VudCA9IE1hdGguY2VpbChwZXJjZW50ICogYmFyT3B0aW9ucy53aWR0aClcblxuICAgIGlmIChsYXN0UGVyY2VudCAhPT0gbmV3UGVyY2VudCkge1xuICAgICAgYmFyLnVwZGF0ZShwZXJjZW50LCB7XG4gICAgICAgIG1zZzogbXNnXG4gICAgICB9KVxuICAgICAgbGFzdFBlcmNlbnQgPSBuZXdQZXJjZW50XG4gICAgfVxuXG4gICAgaWYgKCFydW5uaW5nKSB7XG4gICAgICBydW5uaW5nID0gdHJ1ZVxuICAgICAgc3RhcnRUaW1lID0gbmV3IERhdGUoKVxuICAgICAgbGFzdFBlcmNlbnQgPSAwXG4gICAgfSBlbHNlIGlmIChwZXJjZW50ID09PSAxKSB7XG4gICAgICBsZXQgbm93ID0gbmV3IERhdGUoKVxuICAgICAgbGV0IGJ1aWxkVGltZSA9IChub3cuZ2V0VGltZSgpIC0gc3RhcnRUaW1lLmdldFRpbWUoKSkgLyAxMDAwICsgJ3MnXG5cbiAgICAgIGJhci50ZXJtaW5hdGUoKVxuXG4gICAgICBpZiAoc3VtbWFyeSkge1xuICAgICAgICBzdHJlYW0ud3JpdGUoY2hhbGsuZ3JlZW4uYm9sZCgnQnVpbGQgY29tcGxldGVkIGluICcgKyBidWlsZFRpbWUgKyAnXFxuXFxuJykpXG4gICAgICB9IGVsc2UgaWYgKHN1bW1hcnlDb250ZW50KSB7XG4gICAgICAgIHN0cmVhbS53cml0ZSgnICAgICcgKyBzdW1tYXJ5Q29udGVudCArICcoJyArIGJ1aWxkVGltZSArICcpXFxuXFxuJylcbiAgICAgIH1cblxuICAgICAgaWYgKGN1c3RvbVN1bW1hcnkpIHtcbiAgICAgICAgY3VzdG9tU3VtbWFyeShidWlsZFRpbWUpXG4gICAgICB9XG5cbiAgICAgIHJ1bm5pbmcgPSBmYWxzZVxuICAgIH1cbiAgfSlcbn1cbiJdfQ==