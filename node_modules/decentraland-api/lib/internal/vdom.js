"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const types_1 = require("./types");
const SubsetMapping_1 = require("./SubsetMapping");
const Diff_1 = require("./Diff");
const ReplaceWholeTreeException_1 = require("./ReplaceWholeTreeException");
const deepEqual_1 = require("../utils/deepEqual");
// tslint:disable:no-console
const innerDone = Symbol('innerDone');
const outerDone = Symbol('outerDone');
let diffcount;
let foundAll = false;
/** Returns the elements conaining a .tag string property */
function filterHavingTag($) {
    return typeof $.tag === 'string';
}
/**
 * Returns element descriptors, it is an array used to identify the given node
 */
function elementDescriptors(el) {
    let output = [];
    output.push(el.tag);
    if (el.attrs) {
        if (el.attrs.key) {
            output.push(el.tag + '.' + el.attrs.key);
        }
        if (el.attrs.id) {
            output.push(el.tag + '#' + el.attrs.id);
        }
        if (el.attrs.src) {
            output.push(el.tag + '%' + el.attrs.src);
        }
    }
    return output;
}
function findUniqueDescriptors(list) {
    let uniqueDescriptors = {};
    let duplicateDescriptors = {};
    let node;
    let descriptors;
    let descriptor;
    let inUnique;
    let inDupes;
    for (let i = 0; i < list.length; i++) {
        node = list[i];
        descriptors = elementDescriptors(node);
        for (let j = 0; j < descriptors.length; j++) {
            descriptor = descriptors[j];
            inUnique = descriptor in uniqueDescriptors;
            inDupes = descriptor in duplicateDescriptors;
            if (!inUnique && !inDupes) {
                uniqueDescriptors[descriptor] = true;
            }
            else if (inUnique) {
                delete uniqueDescriptors[descriptor];
                duplicateDescriptors[descriptor] = true;
            }
        }
    }
    return uniqueDescriptors;
}
function uniqueInBoth(l1, l2) {
    let l1Unique = findUniqueDescriptors(l1);
    let l2Unique = findUniqueDescriptors(l2);
    let inBoth = {};
    let keys = Object.keys(l1Unique);
    let length = keys.length;
    let key;
    for (let i = 0; i < length; i++) {
        key = keys[i];
        if (l2Unique[key]) {
            inBoth[key] = true;
        }
    }
    return inBoth;
}
function removeDone(tree) {
    delete tree[outerDone];
    delete tree[innerDone];
    if (tree.children) {
        return tree.children.every(removeDone);
    }
    else {
        return true;
    }
}
function isEqual(e1, e2) {
    let e1Attributes;
    let e2Attributes;
    if (!['tag'].every(function (element) {
        if (e1[element] !== e2[element]) {
            return false;
        }
        return true;
    })) {
        return false;
    }
    if (Boolean(e1.attrs) !== Boolean(e2.attrs)) {
        return false;
    }
    if (Boolean(e1.children) !== Boolean(e2.children)) {
        return false;
    }
    if (e1.attrs) {
        e1Attributes = Object.keys(e1.attrs);
        e2Attributes = Object.keys(e2.attrs);
        if (e1Attributes.length !== e2Attributes.length) {
            return false;
        }
        if (!e1Attributes.every(function (attribute) {
            if (!deepEqual_1.deepEqual(e1.attrs[attribute], e2.attrs[attribute])) {
                return false;
            }
            return true;
        })) {
            return false;
        }
    }
    if (e1.children) {
        if (e1.children.filter(filterHavingTag).length !== e2.children.filter(filterHavingTag).length) {
            return false;
        }
        if (!e1.children.filter(filterHavingTag).every(function (childNode, index) {
            return isEqual(childNode, e2.children.filter(filterHavingTag)[index]);
        })) {
            return false;
        }
    }
    return true;
}
function roughlyEqual(e1, e2, uniqueDescriptors, sameSiblings, preventRecursion = false) {
    let childUniqueDescriptors;
    let nodeList1;
    let nodeList2;
    if (!e1 || !e2) {
        return false;
    }
    if (e1.tag !== e2.tag) {
        return false;
    }
    if (e1.tag in uniqueDescriptors) {
        return true;
    }
    if (e1.attrs && e2.attrs) {
        if (e1.attrs.id) {
            if (e1.attrs.id !== e2.attrs.id) {
                return false;
            }
            else {
                let idDescriptor = e1.tag + '#' + e1.attrs.id;
                if (idDescriptor in uniqueDescriptors) {
                    return true;
                }
            }
        }
        if (e1.attrs.key) {
            if (e1.attrs.key !== e2.attrs.key) {
                return false;
            }
            else {
                let keyDescriptor = e1.tag + '.' + e1.attrs.key;
                if (keyDescriptor in uniqueDescriptors) {
                    return true;
                }
            }
        }
        if (e1.attrs.src) {
            if (e1.attrs.src !== e2.attrs.src) {
                return false;
            }
            else {
                let keyDescriptor = e1.tag + '%' + e1.attrs.src;
                if (keyDescriptor in uniqueDescriptors) {
                    return true;
                }
            }
        }
    }
    if (sameSiblings) {
        return true;
    }
    nodeList1 = e1.children
        ? e1.children
            .slice()
            .filter(filterHavingTag)
            .reverse()
        : [];
    nodeList2 = e2.children
        ? e2.children
            .slice()
            .filter(filterHavingTag)
            .reverse()
        : [];
    if (nodeList1.length !== nodeList2.length) {
        return false;
    }
    if (preventRecursion) {
        return nodeList1.every(function (element, index) {
            return element.tag === nodeList2[index].tag;
        });
    }
    else {
        // note: we only allow one level of recursion at any depth. If 'preventRecursion'
        // was not set, we must explicitly force it to true for child iterations.
        childUniqueDescriptors = uniqueInBoth(nodeList1, nodeList2);
        return nodeList1.every(function (element, index) {
            return roughlyEqual(element, nodeList2[index], childUniqueDescriptors, true, true);
        });
    }
}
function cloneObj(obj) {
    //  TODO: Do we really need to clone here? Is it not enough to just return the original object?
    return JSON.parse(JSON.stringify(obj));
}
/**
 * based on https://en.wikibooks.org/wiki/Algorithm_implementation/Strings/Longest_common_substring#JavaScript
 */
function findCommonSubsets(c1, c2, marked1, marked2) {
    let lcsSize = 0;
    let index = [];
    let c1Length = c1.length;
    let c2Length = c2.length;
    let matches = Array.apply(null, new Array(c1Length + 1)).map(function () {
        return [];
    });
    // set up the matching table
    let uniqueDescriptors = uniqueInBoth(c1, c2);
    // If all of the elements are the same tag, id and class, then we can
    // consider them roughly the same even if they have a different number of
    // children. This will reduce removing and re-adding similar elements.
    let subsetsSame = c1Length === c2Length;
    let origin;
    let ret;
    let c1Index;
    let c2Index;
    let c1Element;
    let c2Element;
    if (subsetsSame) {
        c1.some(function (element, i) {
            let c1Desc = elementDescriptors(element);
            let c2Desc = elementDescriptors(c2[i]);
            if (c1Desc.length !== c2Desc.length) {
                subsetsSame = false;
                return true;
            }
            c1Desc.some(function (description, i) {
                if (description !== c2Desc[i]) {
                    subsetsSame = false;
                    return true;
                }
            });
            if (!subsetsSame) {
                return true;
            }
        });
    }
    // fill the matches with distance values
    for (c1Index = 0; c1Index < c1Length; c1Index++) {
        c1Element = c1[c1Index];
        for (c2Index = 0; c2Index < c2Length; c2Index++) {
            c2Element = c2[c2Index];
            if (!marked1[c1Index] &&
                !marked2[c2Index] &&
                roughlyEqual(c1Element, c2Element, uniqueDescriptors, subsetsSame)) {
                matches[c1Index + 1][c2Index + 1] = matches[c1Index][c2Index] ? matches[c1Index][c2Index] + 1 : 1;
                if (matches[c1Index + 1][c2Index + 1] >= lcsSize) {
                    lcsSize = matches[c1Index + 1][c2Index + 1];
                    index = [c1Index + 1, c2Index + 1];
                }
            }
            else {
                matches[c1Index + 1][c2Index + 1] = 0;
            }
        }
    }
    if (lcsSize === 0) {
        return undefined;
    }
    origin = [index[0] - lcsSize, index[1] - lcsSize];
    ret = new SubsetMapping_1.SubsetMapping(origin[0], origin[1]);
    ret.length = lcsSize;
    return ret;
}
/**
 * This should really be a predefined function in Array...
 */
function makeArray(n, v) {
    return Array.apply(null, new Array(n)).map(function () {
        return v;
    });
}
/**
 * Generate arrays that indicate which node belongs to which subset,
 * or whether it's actually an orphan node, existing in only one
 * of the two trees, rather than somewhere in both.
 *
 * So if t1 = <img><canvas><br>, t2 = <canvas><br><img>.
 * The longest subset is "<canvas><br>" (length 2), so it will group 0.
 * The second longest is "<img>" (length 1), so it will be group 1.
 * gaps1 will therefore be [1,0,0] and gaps2 [0,0,1].
 *
 * If an element is not part of any group, it will stay being 'true', which
 * is the initial value. For example:
 * t1 = <img><p></p><br><canvas>, t2 = <b></b><br><canvas><img>
 *
 * The "<p></p>" and "<b></b>" do only show up in one of the two and will
 * therefore be marked by "true". The remaining parts are parts of the
 * groups 0 and 1:
 * gaps1 = [1, true, 0, 0], gaps2 = [true, 0, 0, 1]
 *
 */
function getGapInformation(t1, t2, stable) {
    let gaps1 = t1.children
        ? makeArray(t1.children.filter(filterHavingTag).length, true)
        : [];
    let gaps2 = t2.children
        ? makeArray(t2.children.filter(filterHavingTag).length, true)
        : [];
    let group = 0;
    let length = stable.length;
    let i;
    let j;
    let endOld;
    let endNew;
    let subset;
    // give elements from the same subset the same group number
    for (i = 0; i < length; i++) {
        subset = stable[i];
        endOld = subset.oldValue + subset.length;
        endNew = subset.newValue + subset.length;
        for (j = subset.oldValue; j < endOld; j += 1) {
            gaps1[j] = group;
        }
        for (j = subset.newValue; j < endNew; j += 1) {
            gaps2[j] = group;
        }
        group += 1;
    }
    return {
        gaps1: gaps1,
        gaps2: gaps2
    };
}
/**
 * Find all matching subsets, based on immediate child differences only.
 */
function markSubTrees(oldTree, newTree) {
    // note: the child lists are views, and so update as we update old/newTree
    let oldChildren = oldTree.children ? oldTree.children.filter(filterHavingTag) : [];
    let newChildren = newTree.children ? newTree.children.filter(filterHavingTag) : [];
    let marked1 = makeArray(oldChildren.length, false);
    let marked2 = makeArray(newChildren.length, false);
    let subsets = [];
    let subset;
    let returnIndex = function () {
        return arguments[1];
    };
    let markBoth = function (i) {
        marked1[subset.oldValue + i] = true;
        marked2[subset.newValue + i] = true;
    };
    let subsetArray;
    do {
        subset = findCommonSubsets(oldChildren, newChildren, marked1, marked2);
        if (subset) {
            subsets.push(subset);
            subsetArray = Array.apply(null, new Array(subset.length)).map(returnIndex);
            for (let i = 0; i < subsetArray.length; i++) {
                markBoth(subsetArray[i]);
            }
        }
    } while (subset);
    return subsets;
}
class DiffDOM {
    constructor(options = {}) {
        this.options = options;
        this.debug = false;
        this.diffcap = 10; // Limit for how many diffs are accepting when debugging. Inactive when debug is false.
        this.maxDepth = false; // False or a numeral. If set to a numeral, limits the level of depth that the the diff mechanism looks for differences. If false, goes through the entire tree.
        this.maxChildCount = false; // False or a numeral. If set to a numeral, does not try to diff the contents of nodes with more children if there are more than maxChildCountDiffCount differences among child nodes.
        this.maxChildCountDiffCount = 3; // Numeral. See maxChildCount.
        this.filterOuterDiff = null;
        this.compress = false;
    }
    // ===== Create a diff =====
    diff(t1Node, t2Node) {
        diffcount = 0;
        if (this.debug) {
            this.t1Orig = t1Node;
            this.t2Orig = t2Node;
        }
        this.tracker = [];
        return this.findDiffs(t1Node, t2Node);
    }
    findDiffs(t1, t2) {
        let diffs;
        do {
            if (this.debug) {
                diffcount += 1;
                if (diffcount > this.diffcap) {
                    // tslint:disable-next-line
                    ;
                    window.diffError = [this.t1Orig, this.t2Orig];
                    throw new Error('surpassed diffcap:' + JSON.stringify(this.t1Orig) + ' -> ' + JSON.stringify(this.t2Orig));
                }
            }
            diffs = this.findNextDiff(t1, t2, []);
            if (diffs.length === 0) {
                // Last check if the elements really are the same now.
                // If not, remove all info about being done and start over.
                // Sometimes a node can be marked as done, but the creation of subsequent diffs means that it has to be changed again.
                if (!isEqual(t1, t2)) {
                    if (foundAll) {
                        console.error('Could not find remaining diffs!');
                        console.trace({ t1, t2 });
                    }
                    else {
                        foundAll = true;
                        removeDone(t1);
                        diffs = this.findNextDiff(t1, t2, []);
                    }
                }
            }
            if (diffs.length > 0) {
                foundAll = false;
                this.tracker.push(...diffs);
                this.applyVirtual(t1, diffs);
            }
        } while (diffs.length > 0);
        return this.tracker;
    }
    findNextDiff(t1, t2, route) {
        let diffs;
        let fdiffs;
        if (this.maxDepth && route.length > this.maxDepth) {
            return [];
        }
        // outer differences?
        if (!t1[outerDone]) {
            diffs = this.findOuterDiff(t1, t2, route);
            if (this.filterOuterDiff) {
                fdiffs = this.filterOuterDiff(t1, t2, diffs);
                if (fdiffs)
                    diffs = fdiffs;
            }
            if (diffs.length > 0) {
                t1[outerDone] = true;
                return diffs;
            }
            else {
                t1[outerDone] = true;
            }
        }
        // inner differences?
        if (!t1[innerDone]) {
            diffs = this.findInnerDiff(t1, t2, route);
            if (diffs.length > 0) {
                return diffs;
            }
            else {
                t1[innerDone] = true;
            }
        }
        // no differences
        return [];
    }
    findOuterDiff(t1, t2, route) {
        let diffs = [];
        let attr;
        let attr1;
        let attr2;
        let attrLength;
        let pos;
        let i;
        if (t1.tag !== t2.tag) {
            return [
                new Diff_1.Diff()
                    .setValue(types_1.Actions.action, types_1.Actions.replaceElement)
                    .setValue(types_1.Actions.oldValue, t1)
                    .setValue(types_1.Actions.newValue, cloneObj(t2))
                    .setValue(types_1.Actions.route, route)
            ];
        }
        let t1Children = t1.children.filter(filterHavingTag);
        let t2Children = t2.children.filter(filterHavingTag);
        if (this.maxChildCount &&
            t1Children &&
            t2Children &&
            t1Children.length > this.maxChildCount &&
            t2Children.length > this.maxChildCount) {
            let childNodesLength = t1Children.length < t2Children.length ? t1Children.length : t2Children.length;
            let childDiffCount = 0;
            let j = 0;
            while (childDiffCount < this.maxChildCountDiffCount && j < childNodesLength) {
                if (!isEqual(t1Children[j], t2Children[j])) {
                    childDiffCount++;
                }
                j++;
            }
            if (childDiffCount === this.maxChildCountDiffCount) {
                return [
                    new Diff_1.Diff()
                        .setValue(types_1.Actions.action, types_1.Actions.replaceElement)
                        .setValue(types_1.Actions.oldValue, cloneObj(t1))
                        .setValue(types_1.Actions.newValue, cloneObj(t2))
                        .setValue(types_1.Actions.route, route)
                ];
            }
        }
        attr1 = t1.attrs ? Object.keys(t1.attrs).sort() : [];
        attr2 = t2.attrs ? Object.keys(t2.attrs).sort() : [];
        attrLength = attr1.length;
        for (i = 0; i < attrLength; i++) {
            attr = attr1[i];
            pos = attr2.indexOf(attr);
            if (pos === -1) {
                diffs.push(new Diff_1.Diff()
                    .setValue(types_1.Actions.action, types_1.Actions.removeAttribute)
                    .setValue(types_1.Actions.route, route)
                    .setValue(types_1.Actions.name, attr));
            }
            else {
                attr2.splice(pos, 1);
                if (!deepEqual_1.deepEqual(t1.attrs[attr], t2.attrs[attr])) {
                    diffs.push(new Diff_1.Diff()
                        .setValue(types_1.Actions.action, types_1.Actions.modifyAttribute)
                        .setValue(types_1.Actions.route, route)
                        .setValue(types_1.Actions.name, attr)
                        .setValue(types_1.Actions.oldValue, t1.attrs[attr])
                        .setValue(types_1.Actions.newValue, t2.attrs[attr]));
                }
            }
        }
        attrLength = attr2.length;
        for (i = 0; i < attrLength; i++) {
            attr = attr2[i];
            diffs.push(new Diff_1.Diff()
                .setValue(types_1.Actions.action, types_1.Actions.addAttribute)
                .setValue(types_1.Actions.route, route)
                .setValue(types_1.Actions.name, attr));
        }
        return diffs;
    }
    findInnerDiff(t1, t2, route) {
        let subtrees = t1.children && t2.children ? markSubTrees(t1, t2) : [];
        let t1ChildNodes = t1.children ? t1.children.filter(filterHavingTag) : [];
        let t2ChildNodes = t2.children ? t2.children.filter(filterHavingTag) : [];
        let childNodesLengthDifference;
        let diffs = [];
        let index = 0;
        let last;
        let e1;
        let e2;
        let i;
        if (subtrees.length > 0) {
            /* One or more groups have been identified among the children of t1
             * and t2.
             */
            diffs = this.attemptGroupRelocation(t1, t2, subtrees, route);
            if (diffs.length > 0) {
                return diffs;
            }
        }
        /* 0 or 1 groups of similar child nodes have been found
         * for t1 and t2. 1 If there is 1, it could be a sign that the
         * contents are the same. When the number of groups is below 2,
         * t1 and t2 are made to have the same length and each of the
         * pairs of child nodes are diffed.
         */
        last = Math.max(t1ChildNodes.length, t2ChildNodes.length);
        if (t1ChildNodes.length !== t2ChildNodes.length) {
            childNodesLengthDifference = true;
        }
        for (i = 0; i < last; i += 1) {
            e1 = t1ChildNodes[i];
            e2 = t2ChildNodes[i];
            if (childNodesLengthDifference) {
                /* t1 and t2 have different amounts of children. Add
                 * and remove as necessary to obtain the same length */
                if (e1 && !e2) {
                    diffs.push(new Diff_1.Diff()
                        .setValue(types_1.Actions.action, types_1.Actions.removeElement)
                        .setValue(types_1.Actions.route, route.concat(index))
                        .setValue(types_1.Actions.element, e1));
                    index -= 1;
                }
                else if (e2 && !e1) {
                    diffs.push(new Diff_1.Diff()
                        .setValue(types_1.Actions.action, types_1.Actions.addElement)
                        .setValue(types_1.Actions.route, route.concat(index))
                        .setValue(types_1.Actions.element, cloneObj(e2)));
                }
            }
            /* We are now guaranteed that children e1 and e2 exist,
             * and that they can be diffed.
             */
            /* Diffs in child nodes should not affect the parent node,
             * so we let these diffs be submitted together with other
             * diffs.
             */
            if (e1 && e2) {
                diffs = diffs.concat(this.findNextDiff(e1, e2, route.concat(index)));
            }
            index += 1;
        }
        t1[innerDone] = true;
        return diffs;
    }
    // tslint:disable-next-line:prefer-function-over-method
    attemptGroupRelocation(t1, t2, subtrees, route) {
        /* Either t1.children and t2.children have the same length, or
         * there are at least two groups of similar elements can be found.
         * attempts are made at equalizing t1 with t2. First all initial
         * elements with no group affiliation (gaps=true) are removed (if
         * only in t1) or added (if only in t2). Then the creation of a group
         * relocation diff is attempted.
        */
        let gapInformation = getGapInformation(t1, t2, subtrees);
        let gaps1 = gapInformation.gaps1;
        let gaps2 = gapInformation.gaps2;
        let shortest = Math.min(gaps1.length, gaps2.length);
        let destinationDifferent;
        let toGroup;
        let group;
        let node;
        let diffs = [];
        let index1;
        let index2;
        let j;
        let t1Children = t1.children.filter(filterHavingTag);
        let t2Children = t2.children.filter(filterHavingTag);
        for (index2 = 0, index1 = 0; index2 < shortest; index1 += 1, index2 += 1) {
            if (gaps1[index2] === true) {
                node = t1Children[index1];
                diffs.push(new Diff_1.Diff()
                    .setValue(types_1.Actions.action, types_1.Actions.removeElement)
                    .setValue(types_1.Actions.route, route.concat(index2))
                    .setValue(types_1.Actions.element, cloneObj(node)));
                gaps1.splice(index2, 1);
                shortest = Math.min(gaps1.length, gaps2.length);
                index2 -= 1;
            }
            else if (gaps2[index2] === true) {
                node = t2Children[index2];
                diffs.push(new Diff_1.Diff()
                    .setValue(types_1.Actions.action, types_1.Actions.addElement)
                    .setValue(types_1.Actions.route, route.concat(index2))
                    .setValue(types_1.Actions.element, cloneObj(node)));
                gaps1.splice(index2, 0, true);
                shortest = Math.min(gaps1.length, gaps2.length);
                index1 -= 1;
            }
            else if (gaps1[index2] !== gaps2[index2]) {
                if (diffs.length > 0) {
                    return diffs;
                }
                // group relocation
                group = subtrees[gaps1[index2]];
                toGroup = Math.min(group.newValue, t1Children.length - group.length);
                if (toGroup !== group.oldValue) {
                    // Check whether destination nodes are different than originating ones.
                    destinationDifferent = false;
                    for (j = 0; j < group.length; j += 1) {
                        if (!roughlyEqual(t1Children[toGroup + j], t1Children[group.oldValue + j], {}, false, true)) {
                            destinationDifferent = true;
                        }
                    }
                    if (destinationDifferent) {
                        return [
                            new Diff_1.Diff()
                                .setValue(types_1.Actions.action, types_1.Actions.relocateGroup)
                                .setValue(types_1.Actions.groupLength, group.length)
                                .setValue(types_1.Actions.from, group.oldValue)
                                .setValue(types_1.Actions.to, toGroup)
                                .setValue(types_1.Actions.route, route)
                        ];
                    }
                }
            }
        }
        return diffs;
    }
    // ===== Apply a virtual diff =====
    /** Patches a virtual tree using a list of diffs */
    applyVirtual(tree, diffs) {
        let length = diffs.length;
        if (length === 0) {
            return true;
        }
        for (let i = 0; i < length; i++) {
            let diff = diffs[i];
            this.applyVirtualDiff(tree, diff);
        }
        return true;
    }
    /** Gets a node in the virtual tree by a route */
    // tslint:disable-next-line:prefer-function-over-method
    getFromVirtualRoute(tree, route) {
        let node = tree;
        let parentNode;
        let nodeIndex;
        let newRoute = route.slice();
        while (newRoute.length > 0) {
            const ch = node.children.filter(filterHavingTag);
            if (!ch.length) {
                return undefined;
            }
            nodeIndex = newRoute.shift();
            parentNode = node;
            node = ch[nodeIndex];
        }
        return {
            node: node,
            parentNode: parentNode,
            nodeIndex: nodeIndex
        };
    }
    /** Patches a virtual tree using a diff */
    applyVirtualDiff(tree, diff) {
        let routeInfo = this.getFromVirtualRoute(tree, diff[types_1.Actions.route]);
        let node = routeInfo && routeInfo.node;
        let parentNode = routeInfo && routeInfo.parentNode;
        let nodeIndex = routeInfo && routeInfo.nodeIndex;
        let newNode;
        // pre-diff hook
        let info = {
            diff: diff,
            node: node,
            newNode: void 0
        };
        switch (diff[types_1.Actions.action]) {
            case types_1.Actions.addElement:
                const route = diff[types_1.Actions.route].slice();
                const position = route.pop();
                const x = this.getFromVirtualRoute(tree, route);
                if (x) {
                    node = x.node;
                    newNode = cloneObj(diff[types_1.Actions.element]);
                    newNode[outerDone] = true;
                    newNode[innerDone] = true;
                    if (!node.children) {
                        node.children = [];
                    }
                    if (node.children[position]) {
                        node.children.splice(position, 0, newNode);
                    }
                    else {
                        node.children.push(newNode);
                    }
                }
                break;
            case types_1.Actions.addAttribute:
                if (!node.attrs) {
                    node.attrs = {};
                }
                node.attrs[diff[types_1.Actions.name]] = diff[types_1.Actions.value];
                break;
            case types_1.Actions.modifyAttribute:
                node.attrs[diff[types_1.Actions.name]] = diff[types_1.Actions.newValue];
                break;
            case types_1.Actions.removeAttribute:
                delete node.attrs[diff[types_1.Actions.name]];
                break;
            case types_1.Actions.replaceElement:
                newNode = cloneObj(diff[types_1.Actions.newValue]);
                newNode[outerDone] = true;
                newNode[innerDone] = true;
                if (parentNode) {
                    parentNode.children[nodeIndex] = newNode;
                }
                else {
                    throw new ReplaceWholeTreeException_1.ReplaceWholeTreeException();
                }
                break;
            case types_1.Actions.relocateGroup:
                const nodeArray = node.children.splice(diff[types_1.Actions.from], diff[types_1.Actions.groupLength]).reverse();
                for (let i = 0; i < nodeArray.length; i++) {
                    node.children.splice(diff[types_1.Actions.to], 0, nodeArray[i]);
                }
                break;
            case types_1.Actions.removeElement:
                parentNode.children.splice(nodeIndex, 1);
                break;
            default:
                console.log('unknown action');
        }
        // capture newNode for the callback
        info.newNode = newNode;
        return undefined;
    }
}
exports.DiffDOM = DiffDOM;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmRvbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbnRlcm5hbC92ZG9tLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQXdDO0FBRXhDLG1EQUErQztBQUMvQyxpQ0FBNkI7QUFDN0IsMkVBQXVFO0FBQ3ZFLGtEQUE4QztBQUM5Qyw0QkFBNEI7QUFFNUIsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0FBQ3JDLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQTtBQUVyQyxJQUFJLFNBQVMsQ0FBQTtBQUNiLElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQTtBQUVwQiw0REFBNEQ7QUFDNUQsU0FBUyxlQUFlLENBQUMsQ0FBa0I7SUFDekMsT0FBTyxPQUFPLENBQUMsQ0FBQyxHQUFHLEtBQUssUUFBUSxDQUFBO0FBQ2xDLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsa0JBQWtCLENBQUMsRUFBbUI7SUFDN0MsSUFBSSxNQUFNLEdBQWEsRUFBRSxDQUFBO0lBRXpCLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBRW5CLElBQUksRUFBRSxDQUFDLEtBQUssRUFBRTtRQUNaLElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUU7WUFDaEIsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1NBQ3pDO1FBQ0QsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRTtZQUNmLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQTtTQUN4QztRQUNELElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUU7WUFDaEIsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1NBQ3pDO0tBQ0Y7SUFFRCxPQUFPLE1BQU0sQ0FBQTtBQUNmLENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUFDLElBQXVCO0lBQ3BELElBQUksaUJBQWlCLEdBQUcsRUFBRSxDQUFBO0lBQzFCLElBQUksb0JBQW9CLEdBQUcsRUFBRSxDQUFBO0lBQzdCLElBQUksSUFBcUIsQ0FBQTtJQUN6QixJQUFJLFdBQXFCLENBQUE7SUFDekIsSUFBSSxVQUFrQixDQUFBO0lBQ3RCLElBQUksUUFBaUIsQ0FBQTtJQUNyQixJQUFJLE9BQWdCLENBQUE7SUFFcEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDcEMsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNkLFdBQVcsR0FBRyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUV0QyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMzQyxVQUFVLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQzNCLFFBQVEsR0FBRyxVQUFVLElBQUksaUJBQWlCLENBQUE7WUFDMUMsT0FBTyxHQUFHLFVBQVUsSUFBSSxvQkFBb0IsQ0FBQTtZQUM1QyxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsT0FBTyxFQUFFO2dCQUN6QixpQkFBaUIsQ0FBQyxVQUFVLENBQUMsR0FBRyxJQUFJLENBQUE7YUFDckM7aUJBQU0sSUFBSSxRQUFRLEVBQUU7Z0JBQ25CLE9BQU8saUJBQWlCLENBQUMsVUFBVSxDQUFDLENBQUE7Z0JBQ3BDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxHQUFHLElBQUksQ0FBQTthQUN4QztTQUNGO0tBQ0Y7SUFFRCxPQUFPLGlCQUFpQixDQUFBO0FBQzFCLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxFQUFxQixFQUFFLEVBQXFCO0lBQ2hFLElBQUksUUFBUSxHQUFHLHFCQUFxQixDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBQ3hDLElBQUksUUFBUSxHQUFHLHFCQUFxQixDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBQ3hDLElBQUksTUFBTSxHQUFzQyxFQUFFLENBQUE7SUFDbEQsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUNoQyxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFBO0lBQ3hCLElBQUksR0FBVyxDQUFBO0lBRWYsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUMvQixHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ2IsSUFBSSxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDakIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQTtTQUNuQjtLQUNGO0lBRUQsT0FBTyxNQUFNLENBQUE7QUFDZixDQUFDO0FBRUQsU0FBUyxVQUFVLENBQUMsSUFBcUI7SUFDdkMsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUE7SUFDdEIsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUE7SUFFdEIsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUE7S0FDdkM7U0FBTTtRQUNMLE9BQU8sSUFBSSxDQUFBO0tBQ1o7QUFDSCxDQUFDO0FBRUQsU0FBUyxPQUFPLENBQUMsRUFBbUIsRUFBRSxFQUFtQjtJQUN2RCxJQUFJLFlBQXNCLENBQUE7SUFDMUIsSUFBSSxZQUFzQixDQUFBO0lBRTFCLElBQ0UsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFTLE9BQU87UUFDN0IsSUFBSSxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQy9CLE9BQU8sS0FBSyxDQUFBO1NBQ2I7UUFDRCxPQUFPLElBQUksQ0FBQTtJQUNiLENBQUMsQ0FBQyxFQUNGO1FBQ0EsT0FBTyxLQUFLLENBQUE7S0FDYjtJQUVELElBQUksT0FBTyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxPQUFPLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQzNDLE9BQU8sS0FBSyxDQUFBO0tBQ2I7SUFFRCxJQUFJLE9BQU8sQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssT0FBTyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRTtRQUNqRCxPQUFPLEtBQUssQ0FBQTtLQUNiO0lBQ0QsSUFBSSxFQUFFLENBQUMsS0FBSyxFQUFFO1FBQ1osWUFBWSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3BDLFlBQVksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUVwQyxJQUFJLFlBQVksQ0FBQyxNQUFNLEtBQUssWUFBWSxDQUFDLE1BQU0sRUFBRTtZQUMvQyxPQUFPLEtBQUssQ0FBQTtTQUNiO1FBQ0QsSUFDRSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsVUFBUyxTQUFTO1lBQ3BDLElBQUksQ0FBQyxxQkFBUyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFO2dCQUN4RCxPQUFPLEtBQUssQ0FBQTthQUNiO1lBQ0QsT0FBTyxJQUFJLENBQUE7UUFDYixDQUFDLENBQUMsRUFDRjtZQUNBLE9BQU8sS0FBSyxDQUFBO1NBQ2I7S0FDRjtJQUNELElBQUksRUFBRSxDQUFDLFFBQVEsRUFBRTtRQUNmLElBQUksRUFBRSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsTUFBTSxLQUFLLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLE1BQU0sRUFBRTtZQUM3RixPQUFPLEtBQUssQ0FBQTtTQUNiO1FBQ0QsSUFDRSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFTLFNBQVMsRUFBRSxLQUFLO1lBQ2xFLE9BQU8sT0FBTyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO1FBQ3ZFLENBQUMsQ0FBQyxFQUNGO1lBQ0EsT0FBTyxLQUFLLENBQUE7U0FDYjtLQUNGO0lBRUQsT0FBTyxJQUFJLENBQUE7QUFDYixDQUFDO0FBRUQsU0FBUyxZQUFZLENBQ25CLEVBQW1CLEVBQ25CLEVBQW1CLEVBQ25CLGlCQUFvRCxFQUNwRCxZQUFxQixFQUNyQixnQkFBZ0IsR0FBRyxLQUFLO0lBRXhCLElBQUksc0JBQXlELENBQUE7SUFDN0QsSUFBSSxTQUE0QixDQUFBO0lBQ2hDLElBQUksU0FBNEIsQ0FBQTtJQUVoQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2QsT0FBTyxLQUFLLENBQUE7S0FDYjtJQUVELElBQUksRUFBRSxDQUFDLEdBQUcsS0FBSyxFQUFFLENBQUMsR0FBRyxFQUFFO1FBQ3JCLE9BQU8sS0FBSyxDQUFBO0tBQ2I7SUFFRCxJQUFJLEVBQUUsQ0FBQyxHQUFHLElBQUksaUJBQWlCLEVBQUU7UUFDL0IsT0FBTyxJQUFJLENBQUE7S0FDWjtJQUVELElBQUksRUFBRSxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUMsS0FBSyxFQUFFO1FBQ3hCLElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUU7WUFDZixJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFO2dCQUMvQixPQUFPLEtBQUssQ0FBQTthQUNiO2lCQUFNO2dCQUNMLElBQUksWUFBWSxHQUFHLEVBQUUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFBO2dCQUM3QyxJQUFJLFlBQVksSUFBSSxpQkFBaUIsRUFBRTtvQkFDckMsT0FBTyxJQUFJLENBQUE7aUJBQ1o7YUFDRjtTQUNGO1FBQ0QsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRTtZQUNoQixJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxLQUFLLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFO2dCQUNqQyxPQUFPLEtBQUssQ0FBQTthQUNiO2lCQUFNO2dCQUNMLElBQUksYUFBYSxHQUFHLEVBQUUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFBO2dCQUMvQyxJQUFJLGFBQWEsSUFBSSxpQkFBaUIsRUFBRTtvQkFDdEMsT0FBTyxJQUFJLENBQUE7aUJBQ1o7YUFDRjtTQUNGO1FBQ0QsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRTtZQUNoQixJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxLQUFLLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFO2dCQUNqQyxPQUFPLEtBQUssQ0FBQTthQUNiO2lCQUFNO2dCQUNMLElBQUksYUFBYSxHQUFHLEVBQUUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFBO2dCQUMvQyxJQUFJLGFBQWEsSUFBSSxpQkFBaUIsRUFBRTtvQkFDdEMsT0FBTyxJQUFJLENBQUE7aUJBQ1o7YUFDRjtTQUNGO0tBQ0Y7SUFFRCxJQUFJLFlBQVksRUFBRTtRQUNoQixPQUFPLElBQUksQ0FBQTtLQUNaO0lBRUQsU0FBUyxHQUFHLEVBQUUsQ0FBQyxRQUFRO1FBQ3JCLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUTthQUNSLEtBQUssRUFBRTthQUNQLE1BQU0sQ0FBQyxlQUFlLENBQUM7YUFDdkIsT0FBTyxFQUFFO1FBQ2QsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtJQUNOLFNBQVMsR0FBRyxFQUFFLENBQUMsUUFBUTtRQUNyQixDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVE7YUFDUixLQUFLLEVBQUU7YUFDUCxNQUFNLENBQUMsZUFBZSxDQUFDO2FBQ3ZCLE9BQU8sRUFBRTtRQUNkLENBQUMsQ0FBQyxFQUFFLENBQUE7SUFFTixJQUFJLFNBQVMsQ0FBQyxNQUFNLEtBQUssU0FBUyxDQUFDLE1BQU0sRUFBRTtRQUN6QyxPQUFPLEtBQUssQ0FBQTtLQUNiO0lBRUQsSUFBSSxnQkFBZ0IsRUFBRTtRQUNwQixPQUFPLFNBQVMsQ0FBQyxLQUFLLENBQUMsVUFBUyxPQUFPLEVBQUUsS0FBSztZQUM1QyxPQUFPLE9BQU8sQ0FBQyxHQUFHLEtBQUssU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQTtRQUM3QyxDQUFDLENBQUMsQ0FBQTtLQUNIO1NBQU07UUFDTCxpRkFBaUY7UUFDakYseUVBQXlFO1FBQ3pFLHNCQUFzQixHQUFHLFlBQVksQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUE7UUFDM0QsT0FBTyxTQUFTLENBQUMsS0FBSyxDQUFDLFVBQVMsT0FBTyxFQUFFLEtBQUs7WUFDNUMsT0FBTyxZQUFZLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRSxzQkFBc0IsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDcEYsQ0FBQyxDQUFDLENBQUE7S0FDSDtBQUNILENBQUM7QUFFRCxTQUFTLFFBQVEsQ0FBSSxHQUFNO0lBQ3pCLCtGQUErRjtJQUMvRixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0FBQ3hDLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsaUJBQWlCLENBQ3hCLEVBQXFCLEVBQ3JCLEVBQXFCLEVBQ3JCLE9BQWtCLEVBQ2xCLE9BQWtCO0lBRWxCLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQTtJQUNmLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQTtJQUNkLElBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUE7SUFDeEIsSUFBSSxRQUFRLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQTtJQUN4QixJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLEtBQUssQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7UUFDM0QsT0FBTyxFQUFFLENBQUE7SUFDWCxDQUFDLENBQUMsQ0FBQTtJQUNGLDRCQUE0QjtJQUM1QixJQUFJLGlCQUFpQixHQUFHLFlBQVksQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFDNUMscUVBQXFFO0lBQ3JFLHlFQUF5RTtJQUN6RSxzRUFBc0U7SUFDdEUsSUFBSSxXQUFXLEdBQUcsUUFBUSxLQUFLLFFBQVEsQ0FBQTtJQUN2QyxJQUFJLE1BQU0sQ0FBQTtJQUNWLElBQUksR0FBRyxDQUFBO0lBQ1AsSUFBSSxPQUFlLENBQUE7SUFDbkIsSUFBSSxPQUFlLENBQUE7SUFDbkIsSUFBSSxTQUEwQixDQUFBO0lBQzlCLElBQUksU0FBMEIsQ0FBQTtJQUU5QixJQUFJLFdBQVcsRUFBRTtRQUNmLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBUyxPQUFPLEVBQUUsQ0FBQztZQUN6QixJQUFJLE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUN4QyxJQUFJLE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUN0QyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssTUFBTSxDQUFDLE1BQU0sRUFBRTtnQkFDbkMsV0FBVyxHQUFHLEtBQUssQ0FBQTtnQkFDbkIsT0FBTyxJQUFJLENBQUE7YUFDWjtZQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBUyxXQUFXLEVBQUUsQ0FBQztnQkFDakMsSUFBSSxXQUFXLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFO29CQUM3QixXQUFXLEdBQUcsS0FBSyxDQUFBO29CQUNuQixPQUFPLElBQUksQ0FBQTtpQkFDWjtZQUNILENBQUMsQ0FBQyxDQUFBO1lBQ0YsSUFBSSxDQUFDLFdBQVcsRUFBRTtnQkFDaEIsT0FBTyxJQUFJLENBQUE7YUFDWjtRQUNILENBQUMsQ0FBQyxDQUFBO0tBQ0g7SUFFRCx3Q0FBd0M7SUFDeEMsS0FBSyxPQUFPLEdBQUcsQ0FBQyxFQUFFLE9BQU8sR0FBRyxRQUFRLEVBQUUsT0FBTyxFQUFFLEVBQUU7UUFDL0MsU0FBUyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUN2QixLQUFLLE9BQU8sR0FBRyxDQUFDLEVBQUUsT0FBTyxHQUFHLFFBQVEsRUFBRSxPQUFPLEVBQUUsRUFBRTtZQUMvQyxTQUFTLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQ3ZCLElBQ0UsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDO2dCQUNqQixDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUM7Z0JBQ2pCLFlBQVksQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFLGlCQUFpQixFQUFFLFdBQVcsQ0FBQyxFQUNsRTtnQkFDQSxPQUFPLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDakcsSUFBSSxPQUFPLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsSUFBSSxPQUFPLEVBQUU7b0JBQ2hELE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQTtvQkFDM0MsS0FBSyxHQUFHLENBQUMsT0FBTyxHQUFHLENBQUMsRUFBRSxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUE7aUJBQ25DO2FBQ0Y7aUJBQU07Z0JBQ0wsT0FBTyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFBO2FBQ3RDO1NBQ0Y7S0FDRjtJQUVELElBQUksT0FBTyxLQUFLLENBQUMsRUFBRTtRQUNqQixPQUFPLFNBQVMsQ0FBQTtLQUNqQjtJQUNELE1BQU0sR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxDQUFBO0lBQ2pELEdBQUcsR0FBRyxJQUFJLDZCQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzdDLEdBQUcsQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFBO0lBRXBCLE9BQU8sR0FBRyxDQUFBO0FBQ1osQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBUyxTQUFTLENBQUksQ0FBUyxFQUFFLENBQUk7SUFDbkMsT0FBTyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztRQUN6QyxPQUFPLENBQUMsQ0FBQTtJQUNWLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQUVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBbUJHO0FBQ0gsU0FBUyxpQkFBaUIsQ0FBQyxFQUFtQixFQUFFLEVBQW1CLEVBQUUsTUFBdUI7SUFDMUYsSUFBSSxLQUFLLEdBQXNCLEVBQUUsQ0FBQyxRQUFRO1FBQ3hDLENBQUMsQ0FBRSxTQUFTLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBWTtRQUN6RSxDQUFDLENBQUMsRUFBRSxDQUFBO0lBQ04sSUFBSSxLQUFLLEdBQXNCLEVBQUUsQ0FBQyxRQUFRO1FBQ3hDLENBQUMsQ0FBRSxTQUFTLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBWTtRQUN6RSxDQUFDLENBQUMsRUFBRSxDQUFBO0lBQ04sSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFBO0lBQ2IsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQTtJQUMxQixJQUFJLENBQVMsQ0FBQTtJQUNiLElBQUksQ0FBUyxDQUFBO0lBQ2IsSUFBSSxNQUFjLENBQUE7SUFDbEIsSUFBSSxNQUFjLENBQUE7SUFDbEIsSUFBSSxNQUFxQixDQUFBO0lBRXpCLDJEQUEyRDtJQUMzRCxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUMzQixNQUFNLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ2xCLE1BQU0sR0FBRyxNQUFNLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUE7UUFDeEMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQTtRQUN4QyxLQUFLLENBQUMsR0FBRyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsR0FBRyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUM1QyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFBO1NBQ2pCO1FBQ0QsS0FBSyxDQUFDLEdBQUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLEdBQUcsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDNUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQTtTQUNqQjtRQUNELEtBQUssSUFBSSxDQUFDLENBQUE7S0FDWDtJQUVELE9BQU87UUFDTCxLQUFLLEVBQUUsS0FBSztRQUNaLEtBQUssRUFBRSxLQUFLO0tBQ2IsQ0FBQTtBQUNILENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsWUFBWSxDQUFDLE9BQXdCLEVBQUUsT0FBd0I7SUFDdEUsMEVBQTBFO0lBQzFFLElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUE7SUFDbEYsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtJQUNsRixJQUFJLE9BQU8sR0FBRyxTQUFTLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQTtJQUNsRCxJQUFJLE9BQU8sR0FBRyxTQUFTLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQTtJQUNsRCxJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUE7SUFDaEIsSUFBSSxNQUFxQixDQUFBO0lBQ3pCLElBQUksV0FBVyxHQUFHO1FBQ2hCLE9BQU8sU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ3JCLENBQUMsQ0FBQTtJQUNELElBQUksUUFBUSxHQUFHLFVBQVMsQ0FBQztRQUN2QixPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUE7UUFDbkMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFBO0lBQ3JDLENBQUMsQ0FBQTtJQUNELElBQUksV0FBcUIsQ0FBQTtJQUV6QixHQUFHO1FBQ0QsTUFBTSxHQUFHLGlCQUFpQixDQUFDLFdBQVcsRUFBRSxXQUFXLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFBO1FBQ3RFLElBQUksTUFBTSxFQUFFO1lBQ1YsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUNwQixXQUFXLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFBO1lBRTFFLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUMzQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7YUFDekI7U0FDRjtLQUNGLFFBQVEsTUFBTSxFQUFDO0lBQ2hCLE9BQU8sT0FBTyxDQUFBO0FBQ2hCLENBQUM7QUFFRCxNQUFhLE9BQU87SUFZbEIsWUFBbUIsVUFBVSxFQUFFO1FBQVosWUFBTyxHQUFQLE9BQU8sQ0FBSztRQVIvQixVQUFLLEdBQUcsS0FBSyxDQUFBO1FBQ2IsWUFBTyxHQUFHLEVBQUUsQ0FBQSxDQUFDLHVGQUF1RjtRQUNwRyxhQUFRLEdBQW1CLEtBQUssQ0FBQSxDQUFDLGdLQUFnSztRQUNqTSxrQkFBYSxHQUFtQixLQUFLLENBQUEsQ0FBQyxzTEFBc0w7UUFDNU4sMkJBQXNCLEdBQUcsQ0FBQyxDQUFBLENBQUMsOEJBQThCO1FBQ3pELG9CQUFlLEdBQUcsSUFBSSxDQUFBO1FBQ3RCLGFBQVEsR0FBRyxLQUFLLENBQUE7SUFFa0IsQ0FBQztJQUVuQyw0QkFBNEI7SUFFNUIsSUFBSSxDQUFDLE1BQXVCLEVBQUUsTUFBdUI7UUFDbkQsU0FBUyxHQUFHLENBQUMsQ0FBQTtRQUViLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNkLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFBO1lBQ3BCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFBO1NBQ3JCO1FBRUQsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUE7UUFDakIsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQTtJQUN2QyxDQUFDO0lBRUQsU0FBUyxDQUFDLEVBQW1CLEVBQUUsRUFBbUI7UUFDaEQsSUFBSSxLQUFhLENBQUE7UUFDakIsR0FBRztZQUNELElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtnQkFDZCxTQUFTLElBQUksQ0FBQyxDQUFBO2dCQUNkLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUU7b0JBQzVCLDJCQUEyQjtvQkFDM0IsQ0FBQztvQkFBQyxNQUFjLENBQUMsU0FBUyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7b0JBQ3ZELE1BQU0sSUFBSSxLQUFLLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUE7aUJBQzNHO2FBQ0Y7WUFDRCxLQUFLLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO1lBRXJDLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQ3RCLHNEQUFzRDtnQkFDdEQsMkRBQTJEO2dCQUMzRCxzSEFBc0g7Z0JBQ3RILElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFO29CQUNwQixJQUFJLFFBQVEsRUFBRTt3QkFDWixPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUE7d0JBQ2hELE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQTtxQkFDMUI7eUJBQU07d0JBQ0wsUUFBUSxHQUFHLElBQUksQ0FBQTt3QkFDZixVQUFVLENBQUMsRUFBRSxDQUFDLENBQUE7d0JBQ2QsS0FBSyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQTtxQkFDdEM7aUJBQ0Y7YUFDRjtZQUNELElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ3BCLFFBQVEsR0FBRyxLQUFLLENBQUE7Z0JBQ2hCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUE7Z0JBQzNCLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFBO2FBQzdCO1NBQ0YsUUFBUSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBQztRQUMxQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUE7SUFDckIsQ0FBQztJQUVELFlBQVksQ0FBQyxFQUFtQixFQUFFLEVBQW1CLEVBQUUsS0FBZTtRQUNwRSxJQUFJLEtBQWEsQ0FBQTtRQUNqQixJQUFJLE1BQU0sQ0FBQTtRQUVWLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDakQsT0FBTyxFQUFFLENBQUE7U0FDVjtRQUNELHFCQUFxQjtRQUNyQixJQUFJLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxFQUFFO1lBQ2xCLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUE7WUFDekMsSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO2dCQUN4QixNQUFNLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFBO2dCQUM1QyxJQUFJLE1BQU07b0JBQUUsS0FBSyxHQUFHLE1BQU0sQ0FBQTthQUMzQjtZQUNELElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ3BCLEVBQUUsQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUE7Z0JBQ3BCLE9BQU8sS0FBSyxDQUFBO2FBQ2I7aUJBQU07Z0JBQ0wsRUFBRSxDQUFDLFNBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQTthQUNyQjtTQUNGO1FBQ0QscUJBQXFCO1FBQ3JCLElBQUksQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDbEIsS0FBSyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQTtZQUN6QyxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUNwQixPQUFPLEtBQUssQ0FBQTthQUNiO2lCQUFNO2dCQUNMLEVBQUUsQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUE7YUFDckI7U0FDRjtRQUVELGlCQUFpQjtRQUNqQixPQUFPLEVBQUUsQ0FBQTtJQUNYLENBQUM7SUFDRCxhQUFhLENBQUMsRUFBbUIsRUFBRSxFQUFtQixFQUFFLEtBQWU7UUFDckUsSUFBSSxLQUFLLEdBQVcsRUFBRSxDQUFBO1FBQ3RCLElBQUksSUFBSSxDQUFBO1FBQ1IsSUFBSSxLQUFLLENBQUE7UUFDVCxJQUFJLEtBQUssQ0FBQTtRQUNULElBQUksVUFBVSxDQUFBO1FBQ2QsSUFBSSxHQUFHLENBQUE7UUFDUCxJQUFJLENBQUMsQ0FBQTtRQUVMLElBQUksRUFBRSxDQUFDLEdBQUcsS0FBSyxFQUFFLENBQUMsR0FBRyxFQUFFO1lBQ3JCLE9BQU87Z0JBQ0wsSUFBSSxXQUFJLEVBQUU7cUJBQ1AsUUFBUSxDQUFDLGVBQU8sQ0FBQyxNQUFNLEVBQUUsZUFBTyxDQUFDLGNBQWMsQ0FBQztxQkFDaEQsUUFBUSxDQUFDLGVBQU8sQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDO3FCQUM5QixRQUFRLENBQUMsZUFBTyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7cUJBQ3hDLFFBQVEsQ0FBQyxlQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQzthQUNsQyxDQUFBO1NBQ0Y7UUFFRCxJQUFJLFVBQVUsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQTtRQUNwRCxJQUFJLFVBQVUsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQTtRQUVwRCxJQUNFLElBQUksQ0FBQyxhQUFhO1lBQ2xCLFVBQVU7WUFDVixVQUFVO1lBQ1YsVUFBVSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYTtZQUN0QyxVQUFVLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQ3RDO1lBQ0EsSUFBSSxnQkFBZ0IsR0FBRyxVQUFVLENBQUMsTUFBTSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUE7WUFDcEcsSUFBSSxjQUFjLEdBQUcsQ0FBQyxDQUFBO1lBQ3RCLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUNULE9BQU8sY0FBYyxHQUFHLElBQUksQ0FBQyxzQkFBc0IsSUFBSSxDQUFDLEdBQUcsZ0JBQWdCLEVBQUU7Z0JBQzNFLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO29CQUMxQyxjQUFjLEVBQUUsQ0FBQTtpQkFDakI7Z0JBQ0QsQ0FBQyxFQUFFLENBQUE7YUFDSjtZQUNELElBQUksY0FBYyxLQUFLLElBQUksQ0FBQyxzQkFBc0IsRUFBRTtnQkFDbEQsT0FBTztvQkFDTCxJQUFJLFdBQUksRUFBRTt5QkFDUCxRQUFRLENBQUMsZUFBTyxDQUFDLE1BQU0sRUFBRSxlQUFPLENBQUMsY0FBYyxDQUFDO3lCQUNoRCxRQUFRLENBQUMsZUFBTyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7eUJBQ3hDLFFBQVEsQ0FBQyxlQUFPLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQzt5QkFDeEMsUUFBUSxDQUFDLGVBQU8sQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDO2lCQUNsQyxDQUFBO2FBQ0Y7U0FDRjtRQUVELEtBQUssR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFBO1FBQ3BELEtBQUssR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFBO1FBRXBELFVBQVUsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFBO1FBQ3pCLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsVUFBVSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQy9CLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDZixHQUFHLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUN6QixJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsRUFBRTtnQkFDZCxLQUFLLENBQUMsSUFBSSxDQUNSLElBQUksV0FBSSxFQUFFO3FCQUNQLFFBQVEsQ0FBQyxlQUFPLENBQUMsTUFBTSxFQUFFLGVBQU8sQ0FBQyxlQUFlLENBQUM7cUJBQ2pELFFBQVEsQ0FBQyxlQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQztxQkFDOUIsUUFBUSxDQUFDLGVBQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQ2hDLENBQUE7YUFDRjtpQkFBTTtnQkFDTCxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQTtnQkFDcEIsSUFBSSxDQUFDLHFCQUFTLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUU7b0JBQzlDLEtBQUssQ0FBQyxJQUFJLENBQ1IsSUFBSSxXQUFJLEVBQUU7eUJBQ1AsUUFBUSxDQUFDLGVBQU8sQ0FBQyxNQUFNLEVBQUUsZUFBTyxDQUFDLGVBQWUsQ0FBQzt5QkFDakQsUUFBUSxDQUFDLGVBQU8sQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDO3lCQUM5QixRQUFRLENBQUMsZUFBTyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUM7eUJBQzVCLFFBQVEsQ0FBQyxlQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7eUJBQzFDLFFBQVEsQ0FBQyxlQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FDOUMsQ0FBQTtpQkFDRjthQUNGO1NBQ0Y7UUFFRCxVQUFVLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQTtRQUN6QixLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFVBQVUsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMvQixJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQ2YsS0FBSyxDQUFDLElBQUksQ0FDUixJQUFJLFdBQUksRUFBRTtpQkFDUCxRQUFRLENBQUMsZUFBTyxDQUFDLE1BQU0sRUFBRSxlQUFPLENBQUMsWUFBWSxDQUFDO2lCQUM5QyxRQUFRLENBQUMsZUFBTyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUM7aUJBQzlCLFFBQVEsQ0FBQyxlQUFPLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUNoQyxDQUFBO1NBQ0Y7UUFFRCxPQUFPLEtBQUssQ0FBQTtJQUNkLENBQUM7SUFDRCxhQUFhLENBQUMsRUFBbUIsRUFBRSxFQUFtQixFQUFFLEtBQWU7UUFDckUsSUFBSSxRQUFRLEdBQUcsRUFBRSxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUE7UUFDckUsSUFBSSxZQUFZLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtRQUN6RSxJQUFJLFlBQVksR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFBO1FBQ3pFLElBQUksMEJBQTBCLENBQUE7UUFDOUIsSUFBSSxLQUFLLEdBQVcsRUFBRSxDQUFBO1FBQ3RCLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQTtRQUNiLElBQUksSUFBSSxDQUFBO1FBQ1IsSUFBSSxFQUFFLENBQUE7UUFDTixJQUFJLEVBQUUsQ0FBQTtRQUNOLElBQUksQ0FBQyxDQUFBO1FBRUwsSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN2Qjs7ZUFFRztZQUNILEtBQUssR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUE7WUFDNUQsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDcEIsT0FBTyxLQUFLLENBQUE7YUFDYjtTQUNGO1FBRUQ7Ozs7O1dBS0c7UUFFSCxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUN6RCxJQUFJLFlBQVksQ0FBQyxNQUFNLEtBQUssWUFBWSxDQUFDLE1BQU0sRUFBRTtZQUMvQywwQkFBMEIsR0FBRyxJQUFJLENBQUE7U0FDbEM7UUFFRCxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzVCLEVBQUUsR0FBRyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDcEIsRUFBRSxHQUFHLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUVwQixJQUFJLDBCQUEwQixFQUFFO2dCQUM5Qjt1RUFDdUQ7Z0JBQ3ZELElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO29CQUNiLEtBQUssQ0FBQyxJQUFJLENBQ1IsSUFBSSxXQUFJLEVBQUU7eUJBQ1AsUUFBUSxDQUFDLGVBQU8sQ0FBQyxNQUFNLEVBQUUsZUFBTyxDQUFDLGFBQWEsQ0FBQzt5QkFDL0MsUUFBUSxDQUFDLGVBQU8sQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQzt5QkFDNUMsUUFBUSxDQUFDLGVBQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQ2pDLENBQUE7b0JBQ0QsS0FBSyxJQUFJLENBQUMsQ0FBQTtpQkFDWDtxQkFBTSxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtvQkFDcEIsS0FBSyxDQUFDLElBQUksQ0FDUixJQUFJLFdBQUksRUFBRTt5QkFDUCxRQUFRLENBQUMsZUFBTyxDQUFDLE1BQU0sRUFBRSxlQUFPLENBQUMsVUFBVSxDQUFDO3lCQUM1QyxRQUFRLENBQUMsZUFBTyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO3lCQUM1QyxRQUFRLENBQUMsZUFBTyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FDM0MsQ0FBQTtpQkFDRjthQUNGO1lBQ0Q7O2VBRUc7WUFDSDs7O2VBR0c7WUFFSCxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUU7Z0JBQ1osS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO2FBQ3JFO1lBRUQsS0FBSyxJQUFJLENBQUMsQ0FBQTtTQUNYO1FBQ0QsRUFBRSxDQUFDLFNBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQTtRQUNwQixPQUFPLEtBQUssQ0FBQTtJQUNkLENBQUM7SUFFRCx1REFBdUQ7SUFDdkQsc0JBQXNCLENBQUMsRUFBbUIsRUFBRSxFQUFtQixFQUFFLFFBQVEsRUFBRSxLQUFlO1FBQ3hGOzs7Ozs7VUFNRTtRQUVGLElBQUksY0FBYyxHQUFHLGlCQUFpQixDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUE7UUFDeEQsSUFBSSxLQUFLLEdBQUcsY0FBYyxDQUFDLEtBQUssQ0FBQTtRQUNoQyxJQUFJLEtBQUssR0FBRyxjQUFjLENBQUMsS0FBSyxDQUFBO1FBQ2hDLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDbkQsSUFBSSxvQkFBNkIsQ0FBQTtRQUNqQyxJQUFJLE9BQU8sQ0FBQTtRQUNYLElBQUksS0FBSyxDQUFBO1FBQ1QsSUFBSSxJQUFJLENBQUE7UUFDUixJQUFJLEtBQUssR0FBVyxFQUFFLENBQUE7UUFDdEIsSUFBSSxNQUFNLENBQUE7UUFDVixJQUFJLE1BQU0sQ0FBQTtRQUNWLElBQUksQ0FBQyxDQUFBO1FBRUwsSUFBSSxVQUFVLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUE7UUFDcEQsSUFBSSxVQUFVLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUE7UUFFcEQsS0FBSyxNQUFNLEdBQUcsQ0FBQyxFQUFFLE1BQU0sR0FBRyxDQUFDLEVBQUUsTUFBTSxHQUFHLFFBQVEsRUFBRSxNQUFNLElBQUksQ0FBQyxFQUFFLE1BQU0sSUFBSSxDQUFDLEVBQUU7WUFDeEUsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssSUFBSSxFQUFFO2dCQUMxQixJQUFJLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFBO2dCQUN6QixLQUFLLENBQUMsSUFBSSxDQUNSLElBQUksV0FBSSxFQUFFO3FCQUNQLFFBQVEsQ0FBQyxlQUFPLENBQUMsTUFBTSxFQUFFLGVBQU8sQ0FBQyxhQUFhLENBQUM7cUJBQy9DLFFBQVEsQ0FBQyxlQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7cUJBQzdDLFFBQVEsQ0FBQyxlQUFPLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUM3QyxDQUFBO2dCQUNELEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFBO2dCQUN2QixRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQTtnQkFDL0MsTUFBTSxJQUFJLENBQUMsQ0FBQTthQUNaO2lCQUFNLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksRUFBRTtnQkFDakMsSUFBSSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtnQkFFekIsS0FBSyxDQUFDLElBQUksQ0FDUixJQUFJLFdBQUksRUFBRTtxQkFDUCxRQUFRLENBQUMsZUFBTyxDQUFDLE1BQU0sRUFBRSxlQUFPLENBQUMsVUFBVSxDQUFDO3FCQUM1QyxRQUFRLENBQUMsZUFBTyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO3FCQUM3QyxRQUFRLENBQUMsZUFBTyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FDN0MsQ0FBQTtnQkFDRCxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUE7Z0JBQzdCLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFBO2dCQUMvQyxNQUFNLElBQUksQ0FBQyxDQUFBO2FBQ1o7aUJBQU0sSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFO2dCQUMxQyxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO29CQUNwQixPQUFPLEtBQUssQ0FBQTtpQkFDYjtnQkFDRCxtQkFBbUI7Z0JBQ25CLEtBQUssR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBVyxDQUFDLENBQUE7Z0JBQ3pDLE9BQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUE7Z0JBQ3BFLElBQUksT0FBTyxLQUFLLEtBQUssQ0FBQyxRQUFRLEVBQUU7b0JBQzlCLHVFQUF1RTtvQkFDdkUsb0JBQW9CLEdBQUcsS0FBSyxDQUFBO29CQUM1QixLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRTt3QkFDcEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxLQUFLLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUU7NEJBQzNGLG9CQUFvQixHQUFHLElBQUksQ0FBQTt5QkFDNUI7cUJBQ0Y7b0JBQ0QsSUFBSSxvQkFBb0IsRUFBRTt3QkFDeEIsT0FBTzs0QkFDTCxJQUFJLFdBQUksRUFBRTtpQ0FDUCxRQUFRLENBQUMsZUFBTyxDQUFDLE1BQU0sRUFBRSxlQUFPLENBQUMsYUFBYSxDQUFDO2lDQUMvQyxRQUFRLENBQUMsZUFBTyxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDO2lDQUMzQyxRQUFRLENBQUMsZUFBTyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDO2lDQUN0QyxRQUFRLENBQUMsZUFBTyxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUM7aUNBQzdCLFFBQVEsQ0FBQyxlQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQzt5QkFDbEMsQ0FBQTtxQkFDRjtpQkFDRjthQUNGO1NBQ0Y7UUFDRCxPQUFPLEtBQUssQ0FBQTtJQUNkLENBQUM7SUFFRCxtQ0FBbUM7SUFFbkMsbURBQW1EO0lBQ25ELFlBQVksQ0FBQyxJQUFxQixFQUFFLEtBQWM7UUFDaEQsSUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQTtRQUN6QixJQUFJLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDaEIsT0FBTyxJQUFJLENBQUE7U0FDWjtRQUNELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDL0IsSUFBSSxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQ25CLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUE7U0FDbEM7UUFDRCxPQUFPLElBQUksQ0FBQTtJQUNiLENBQUM7SUFFRCxpREFBaUQ7SUFDakQsdURBQXVEO0lBQ3ZELG1CQUFtQixDQUFDLElBQXFCLEVBQUUsS0FBZTtRQUN4RCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUE7UUFDZixJQUFJLFVBQTJCLENBQUE7UUFDL0IsSUFBSSxTQUFpQixDQUFBO1FBRXJCLElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQTtRQUU1QixPQUFPLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzFCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFBO1lBRWhELElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFO2dCQUNkLE9BQU8sU0FBUyxDQUFBO2FBQ2pCO1lBRUQsU0FBUyxHQUFHLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQTtZQUM1QixVQUFVLEdBQUcsSUFBSSxDQUFBO1lBQ2pCLElBQUksR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUE7U0FDckI7UUFFRCxPQUFPO1lBQ0wsSUFBSSxFQUFFLElBQUk7WUFDVixVQUFVLEVBQUUsVUFBVTtZQUN0QixTQUFTLEVBQUUsU0FBUztTQUNyQixDQUFBO0lBQ0gsQ0FBQztJQUVELDBDQUEwQztJQUMxQyxnQkFBZ0IsQ0FBQyxJQUFxQixFQUFFLElBQVc7UUFDakQsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsZUFBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7UUFDbkUsSUFBSSxJQUFJLEdBQUcsU0FBUyxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUE7UUFDdEMsSUFBSSxVQUFVLEdBQUcsU0FBUyxJQUFJLFNBQVMsQ0FBQyxVQUFVLENBQUE7UUFDbEQsSUFBSSxTQUFTLEdBQUcsU0FBUyxJQUFJLFNBQVMsQ0FBQyxTQUFTLENBQUE7UUFDaEQsSUFBSSxPQUF3QixDQUFBO1FBRTVCLGdCQUFnQjtRQUNoQixJQUFJLElBQUksR0FBRztZQUNULElBQUksRUFBRSxJQUFJO1lBQ1YsSUFBSSxFQUFFLElBQUk7WUFDVixPQUFPLEVBQUUsS0FBSyxDQUFDO1NBQ2hCLENBQUE7UUFFRCxRQUFRLElBQUksQ0FBQyxlQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDNUIsS0FBSyxlQUFPLENBQUMsVUFBVTtnQkFDckIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGVBQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQTtnQkFDekMsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFBO2dCQUM1QixNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFBO2dCQUMvQyxJQUFJLENBQUMsRUFBRTtvQkFDTCxJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQTtvQkFDYixPQUFPLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxlQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQTtvQkFDekMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQTtvQkFDekIsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQTtvQkFFekIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7d0JBQ2xCLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFBO3FCQUNuQjtvQkFFRCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUU7d0JBQzNCLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUE7cUJBQzNDO3lCQUFNO3dCQUNMLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO3FCQUM1QjtpQkFDRjtnQkFDRCxNQUFLO1lBQ1AsS0FBSyxlQUFPLENBQUMsWUFBWTtnQkFDdkIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUU7b0JBQ2YsSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUE7aUJBQ2hCO2dCQUVELElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLGVBQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxlQUFPLENBQUMsS0FBSyxDQUFDLENBQUE7Z0JBRXBELE1BQUs7WUFDUCxLQUFLLGVBQU8sQ0FBQyxlQUFlO2dCQUMxQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxlQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsZUFBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBO2dCQUV2RCxNQUFLO1lBQ1AsS0FBSyxlQUFPLENBQUMsZUFBZTtnQkFDMUIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxlQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtnQkFFckMsTUFBSztZQUNQLEtBQUssZUFBTyxDQUFDLGNBQWM7Z0JBQ3pCLE9BQU8sR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLGVBQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBO2dCQUMxQyxPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxDQUFBO2dCQUN6QixPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxDQUFBO2dCQUN6QixJQUFJLFVBQVUsRUFBRTtvQkFDZCxVQUFVLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLE9BQU8sQ0FBQTtpQkFDekM7cUJBQU07b0JBQ0wsTUFBTSxJQUFJLHFEQUF5QixFQUFFLENBQUE7aUJBQ3RDO2dCQUNELE1BQUs7WUFDUCxLQUFLLGVBQU8sQ0FBQyxhQUFhO2dCQUN4QixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsZUFBTyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksQ0FBQyxlQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtnQkFDL0YsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ3pDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFPLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO2lCQUN4RDtnQkFDRCxNQUFLO1lBQ1AsS0FBSyxlQUFPLENBQUMsYUFBYTtnQkFDeEIsVUFBVSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFBO2dCQUN4QyxNQUFLO1lBQ1A7Z0JBQ0UsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO1NBQ2hDO1FBRUQsbUNBQW1DO1FBQ25DLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFBO1FBRXRCLE9BQU8sU0FBUyxDQUFBO0lBQ2xCLENBQUM7Q0FDRjtBQXZkRCwwQkF1ZEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBY3Rpb25zLCBJRGlmZiB9IGZyb20gJy4vdHlwZXMnXG5pbXBvcnQgeyBJU2ltcGxpZmllZE5vZGUgfSBmcm9tICcuLi9pbnRlcmZhY2VzJ1xuaW1wb3J0IHsgU3Vic2V0TWFwcGluZyB9IGZyb20gJy4vU3Vic2V0TWFwcGluZydcbmltcG9ydCB7IERpZmYgfSBmcm9tICcuL0RpZmYnXG5pbXBvcnQgeyBSZXBsYWNlV2hvbGVUcmVlRXhjZXB0aW9uIH0gZnJvbSAnLi9SZXBsYWNlV2hvbGVUcmVlRXhjZXB0aW9uJ1xuaW1wb3J0IHsgZGVlcEVxdWFsIH0gZnJvbSAnLi4vdXRpbHMvZGVlcEVxdWFsJ1xuLy8gdHNsaW50OmRpc2FibGU6bm8tY29uc29sZVxuXG5jb25zdCBpbm5lckRvbmUgPSBTeW1ib2woJ2lubmVyRG9uZScpXG5jb25zdCBvdXRlckRvbmUgPSBTeW1ib2woJ291dGVyRG9uZScpXG5cbmxldCBkaWZmY291bnRcbmxldCBmb3VuZEFsbCA9IGZhbHNlXG5cbi8qKiBSZXR1cm5zIHRoZSBlbGVtZW50cyBjb25haW5pbmcgYSAudGFnIHN0cmluZyBwcm9wZXJ0eSAqL1xuZnVuY3Rpb24gZmlsdGVySGF2aW5nVGFnKCQ6IElTaW1wbGlmaWVkTm9kZSkge1xuICByZXR1cm4gdHlwZW9mICQudGFnID09PSAnc3RyaW5nJ1xufVxuXG4vKipcbiAqIFJldHVybnMgZWxlbWVudCBkZXNjcmlwdG9ycywgaXQgaXMgYW4gYXJyYXkgdXNlZCB0byBpZGVudGlmeSB0aGUgZ2l2ZW4gbm9kZVxuICovXG5mdW5jdGlvbiBlbGVtZW50RGVzY3JpcHRvcnMoZWw6IElTaW1wbGlmaWVkTm9kZSk6IHN0cmluZ1tdIHtcbiAgbGV0IG91dHB1dDogc3RyaW5nW10gPSBbXVxuXG4gIG91dHB1dC5wdXNoKGVsLnRhZylcblxuICBpZiAoZWwuYXR0cnMpIHtcbiAgICBpZiAoZWwuYXR0cnMua2V5KSB7XG4gICAgICBvdXRwdXQucHVzaChlbC50YWcgKyAnLicgKyBlbC5hdHRycy5rZXkpXG4gICAgfVxuICAgIGlmIChlbC5hdHRycy5pZCkge1xuICAgICAgb3V0cHV0LnB1c2goZWwudGFnICsgJyMnICsgZWwuYXR0cnMuaWQpXG4gICAgfVxuICAgIGlmIChlbC5hdHRycy5zcmMpIHtcbiAgICAgIG91dHB1dC5wdXNoKGVsLnRhZyArICclJyArIGVsLmF0dHJzLnNyYylcbiAgICB9XG4gIH1cblxuICByZXR1cm4gb3V0cHV0XG59XG5cbmZ1bmN0aW9uIGZpbmRVbmlxdWVEZXNjcmlwdG9ycyhsaXN0OiBJU2ltcGxpZmllZE5vZGVbXSkge1xuICBsZXQgdW5pcXVlRGVzY3JpcHRvcnMgPSB7fVxuICBsZXQgZHVwbGljYXRlRGVzY3JpcHRvcnMgPSB7fVxuICBsZXQgbm9kZTogSVNpbXBsaWZpZWROb2RlXG4gIGxldCBkZXNjcmlwdG9yczogc3RyaW5nW11cbiAgbGV0IGRlc2NyaXB0b3I6IHN0cmluZ1xuICBsZXQgaW5VbmlxdWU6IGJvb2xlYW5cbiAgbGV0IGluRHVwZXM6IGJvb2xlYW5cblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHtcbiAgICBub2RlID0gbGlzdFtpXVxuICAgIGRlc2NyaXB0b3JzID0gZWxlbWVudERlc2NyaXB0b3JzKG5vZGUpXG5cbiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGRlc2NyaXB0b3JzLmxlbmd0aDsgaisrKSB7XG4gICAgICBkZXNjcmlwdG9yID0gZGVzY3JpcHRvcnNbal1cbiAgICAgIGluVW5pcXVlID0gZGVzY3JpcHRvciBpbiB1bmlxdWVEZXNjcmlwdG9yc1xuICAgICAgaW5EdXBlcyA9IGRlc2NyaXB0b3IgaW4gZHVwbGljYXRlRGVzY3JpcHRvcnNcbiAgICAgIGlmICghaW5VbmlxdWUgJiYgIWluRHVwZXMpIHtcbiAgICAgICAgdW5pcXVlRGVzY3JpcHRvcnNbZGVzY3JpcHRvcl0gPSB0cnVlXG4gICAgICB9IGVsc2UgaWYgKGluVW5pcXVlKSB7XG4gICAgICAgIGRlbGV0ZSB1bmlxdWVEZXNjcmlwdG9yc1tkZXNjcmlwdG9yXVxuICAgICAgICBkdXBsaWNhdGVEZXNjcmlwdG9yc1tkZXNjcmlwdG9yXSA9IHRydWVcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gdW5pcXVlRGVzY3JpcHRvcnNcbn1cblxuZnVuY3Rpb24gdW5pcXVlSW5Cb3RoKGwxOiBJU2ltcGxpZmllZE5vZGVbXSwgbDI6IElTaW1wbGlmaWVkTm9kZVtdKSB7XG4gIGxldCBsMVVuaXF1ZSA9IGZpbmRVbmlxdWVEZXNjcmlwdG9ycyhsMSlcbiAgbGV0IGwyVW5pcXVlID0gZmluZFVuaXF1ZURlc2NyaXB0b3JzKGwyKVxuICBsZXQgaW5Cb3RoOiB7IFtkZXNjcmlwdG9yOiBzdHJpbmddOiBib29sZWFuIH0gPSB7fVxuICBsZXQga2V5cyA9IE9iamVjdC5rZXlzKGwxVW5pcXVlKVxuICBsZXQgbGVuZ3RoID0ga2V5cy5sZW5ndGhcbiAgbGV0IGtleTogc3RyaW5nXG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgIGtleSA9IGtleXNbaV1cbiAgICBpZiAobDJVbmlxdWVba2V5XSkge1xuICAgICAgaW5Cb3RoW2tleV0gPSB0cnVlXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGluQm90aFxufVxuXG5mdW5jdGlvbiByZW1vdmVEb25lKHRyZWU6IElTaW1wbGlmaWVkTm9kZSkge1xuICBkZWxldGUgdHJlZVtvdXRlckRvbmVdXG4gIGRlbGV0ZSB0cmVlW2lubmVyRG9uZV1cblxuICBpZiAodHJlZS5jaGlsZHJlbikge1xuICAgIHJldHVybiB0cmVlLmNoaWxkcmVuLmV2ZXJ5KHJlbW92ZURvbmUpXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfVxufVxuXG5mdW5jdGlvbiBpc0VxdWFsKGUxOiBJU2ltcGxpZmllZE5vZGUsIGUyOiBJU2ltcGxpZmllZE5vZGUpIHtcbiAgbGV0IGUxQXR0cmlidXRlczogc3RyaW5nW11cbiAgbGV0IGUyQXR0cmlidXRlczogc3RyaW5nW11cblxuICBpZiAoXG4gICAgIVsndGFnJ10uZXZlcnkoZnVuY3Rpb24oZWxlbWVudCkge1xuICAgICAgaWYgKGUxW2VsZW1lbnRdICE9PSBlMltlbGVtZW50XSkge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlXG4gICAgfSlcbiAgKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBpZiAoQm9vbGVhbihlMS5hdHRycykgIT09IEJvb2xlYW4oZTIuYXR0cnMpKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBpZiAoQm9vbGVhbihlMS5jaGlsZHJlbikgIT09IEJvb2xlYW4oZTIuY2hpbGRyZW4pKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbiAgaWYgKGUxLmF0dHJzKSB7XG4gICAgZTFBdHRyaWJ1dGVzID0gT2JqZWN0LmtleXMoZTEuYXR0cnMpXG4gICAgZTJBdHRyaWJ1dGVzID0gT2JqZWN0LmtleXMoZTIuYXR0cnMpXG5cbiAgICBpZiAoZTFBdHRyaWJ1dGVzLmxlbmd0aCAhPT0gZTJBdHRyaWJ1dGVzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICAgIGlmIChcbiAgICAgICFlMUF0dHJpYnV0ZXMuZXZlcnkoZnVuY3Rpb24oYXR0cmlidXRlKSB7XG4gICAgICAgIGlmICghZGVlcEVxdWFsKGUxLmF0dHJzW2F0dHJpYnV0ZV0sIGUyLmF0dHJzW2F0dHJpYnV0ZV0pKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgIH0pXG4gICAgKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH1cbiAgaWYgKGUxLmNoaWxkcmVuKSB7XG4gICAgaWYgKGUxLmNoaWxkcmVuLmZpbHRlcihmaWx0ZXJIYXZpbmdUYWcpLmxlbmd0aCAhPT0gZTIuY2hpbGRyZW4uZmlsdGVyKGZpbHRlckhhdmluZ1RhZykubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgaWYgKFxuICAgICAgIWUxLmNoaWxkcmVuLmZpbHRlcihmaWx0ZXJIYXZpbmdUYWcpLmV2ZXJ5KGZ1bmN0aW9uKGNoaWxkTm9kZSwgaW5kZXgpIHtcbiAgICAgICAgcmV0dXJuIGlzRXF1YWwoY2hpbGROb2RlLCBlMi5jaGlsZHJlbi5maWx0ZXIoZmlsdGVySGF2aW5nVGFnKVtpbmRleF0pXG4gICAgICB9KVxuICAgICkge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHRydWVcbn1cblxuZnVuY3Rpb24gcm91Z2hseUVxdWFsKFxuICBlMTogSVNpbXBsaWZpZWROb2RlLFxuICBlMjogSVNpbXBsaWZpZWROb2RlLFxuICB1bmlxdWVEZXNjcmlwdG9yczogeyBbZGVzY3JpcHRvcjogc3RyaW5nXTogYm9vbGVhbiB9LFxuICBzYW1lU2libGluZ3M6IGJvb2xlYW4sXG4gIHByZXZlbnRSZWN1cnNpb24gPSBmYWxzZVxuKSB7XG4gIGxldCBjaGlsZFVuaXF1ZURlc2NyaXB0b3JzOiB7IFtkZXNjcmlwdG9yOiBzdHJpbmddOiBib29sZWFuIH1cbiAgbGV0IG5vZGVMaXN0MTogSVNpbXBsaWZpZWROb2RlW11cbiAgbGV0IG5vZGVMaXN0MjogSVNpbXBsaWZpZWROb2RlW11cblxuICBpZiAoIWUxIHx8ICFlMikge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgaWYgKGUxLnRhZyAhPT0gZTIudGFnKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBpZiAoZTEudGFnIGluIHVuaXF1ZURlc2NyaXB0b3JzKSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIGlmIChlMS5hdHRycyAmJiBlMi5hdHRycykge1xuICAgIGlmIChlMS5hdHRycy5pZCkge1xuICAgICAgaWYgKGUxLmF0dHJzLmlkICE9PSBlMi5hdHRycy5pZCkge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxldCBpZERlc2NyaXB0b3IgPSBlMS50YWcgKyAnIycgKyBlMS5hdHRycy5pZFxuICAgICAgICBpZiAoaWREZXNjcmlwdG9yIGluIHVuaXF1ZURlc2NyaXB0b3JzKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoZTEuYXR0cnMua2V5KSB7XG4gICAgICBpZiAoZTEuYXR0cnMua2V5ICE9PSBlMi5hdHRycy5rZXkpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsZXQga2V5RGVzY3JpcHRvciA9IGUxLnRhZyArICcuJyArIGUxLmF0dHJzLmtleVxuICAgICAgICBpZiAoa2V5RGVzY3JpcHRvciBpbiB1bmlxdWVEZXNjcmlwdG9ycykge1xuICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGUxLmF0dHJzLnNyYykge1xuICAgICAgaWYgKGUxLmF0dHJzLnNyYyAhPT0gZTIuYXR0cnMuc3JjKSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IGtleURlc2NyaXB0b3IgPSBlMS50YWcgKyAnJScgKyBlMS5hdHRycy5zcmNcbiAgICAgICAgaWYgKGtleURlc2NyaXB0b3IgaW4gdW5pcXVlRGVzY3JpcHRvcnMpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKHNhbWVTaWJsaW5ncykge1xuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICBub2RlTGlzdDEgPSBlMS5jaGlsZHJlblxuICAgID8gZTEuY2hpbGRyZW5cbiAgICAgICAgLnNsaWNlKClcbiAgICAgICAgLmZpbHRlcihmaWx0ZXJIYXZpbmdUYWcpXG4gICAgICAgIC5yZXZlcnNlKClcbiAgICA6IFtdXG4gIG5vZGVMaXN0MiA9IGUyLmNoaWxkcmVuXG4gICAgPyBlMi5jaGlsZHJlblxuICAgICAgICAuc2xpY2UoKVxuICAgICAgICAuZmlsdGVyKGZpbHRlckhhdmluZ1RhZylcbiAgICAgICAgLnJldmVyc2UoKVxuICAgIDogW11cblxuICBpZiAobm9kZUxpc3QxLmxlbmd0aCAhPT0gbm9kZUxpc3QyLmxlbmd0aCkge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgaWYgKHByZXZlbnRSZWN1cnNpb24pIHtcbiAgICByZXR1cm4gbm9kZUxpc3QxLmV2ZXJ5KGZ1bmN0aW9uKGVsZW1lbnQsIGluZGV4KSB7XG4gICAgICByZXR1cm4gZWxlbWVudC50YWcgPT09IG5vZGVMaXN0MltpbmRleF0udGFnXG4gICAgfSlcbiAgfSBlbHNlIHtcbiAgICAvLyBub3RlOiB3ZSBvbmx5IGFsbG93IG9uZSBsZXZlbCBvZiByZWN1cnNpb24gYXQgYW55IGRlcHRoLiBJZiAncHJldmVudFJlY3Vyc2lvbidcbiAgICAvLyB3YXMgbm90IHNldCwgd2UgbXVzdCBleHBsaWNpdGx5IGZvcmNlIGl0IHRvIHRydWUgZm9yIGNoaWxkIGl0ZXJhdGlvbnMuXG4gICAgY2hpbGRVbmlxdWVEZXNjcmlwdG9ycyA9IHVuaXF1ZUluQm90aChub2RlTGlzdDEsIG5vZGVMaXN0MilcbiAgICByZXR1cm4gbm9kZUxpc3QxLmV2ZXJ5KGZ1bmN0aW9uKGVsZW1lbnQsIGluZGV4KSB7XG4gICAgICByZXR1cm4gcm91Z2hseUVxdWFsKGVsZW1lbnQsIG5vZGVMaXN0MltpbmRleF0sIGNoaWxkVW5pcXVlRGVzY3JpcHRvcnMsIHRydWUsIHRydWUpXG4gICAgfSlcbiAgfVxufVxuXG5mdW5jdGlvbiBjbG9uZU9iajxUPihvYmo6IFQpOiBUIHtcbiAgLy8gIFRPRE86IERvIHdlIHJlYWxseSBuZWVkIHRvIGNsb25lIGhlcmU/IElzIGl0IG5vdCBlbm91Z2ggdG8ganVzdCByZXR1cm4gdGhlIG9yaWdpbmFsIG9iamVjdD9cbiAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSlcbn1cblxuLyoqXG4gKiBiYXNlZCBvbiBodHRwczovL2VuLndpa2lib29rcy5vcmcvd2lraS9BbGdvcml0aG1faW1wbGVtZW50YXRpb24vU3RyaW5ncy9Mb25nZXN0X2NvbW1vbl9zdWJzdHJpbmcjSmF2YVNjcmlwdFxuICovXG5mdW5jdGlvbiBmaW5kQ29tbW9uU3Vic2V0cyhcbiAgYzE6IElTaW1wbGlmaWVkTm9kZVtdLFxuICBjMjogSVNpbXBsaWZpZWROb2RlW10sXG4gIG1hcmtlZDE6IGJvb2xlYW5bXSxcbiAgbWFya2VkMjogYm9vbGVhbltdXG4pOiBTdWJzZXRNYXBwaW5nIHtcbiAgbGV0IGxjc1NpemUgPSAwXG4gIGxldCBpbmRleCA9IFtdXG4gIGxldCBjMUxlbmd0aCA9IGMxLmxlbmd0aFxuICBsZXQgYzJMZW5ndGggPSBjMi5sZW5ndGhcbiAgbGV0IG1hdGNoZXMgPSBBcnJheS5hcHBseShudWxsLCBuZXcgQXJyYXkoYzFMZW5ndGggKyAxKSkubWFwKGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBbXVxuICB9KVxuICAvLyBzZXQgdXAgdGhlIG1hdGNoaW5nIHRhYmxlXG4gIGxldCB1bmlxdWVEZXNjcmlwdG9ycyA9IHVuaXF1ZUluQm90aChjMSwgYzIpXG4gIC8vIElmIGFsbCBvZiB0aGUgZWxlbWVudHMgYXJlIHRoZSBzYW1lIHRhZywgaWQgYW5kIGNsYXNzLCB0aGVuIHdlIGNhblxuICAvLyBjb25zaWRlciB0aGVtIHJvdWdobHkgdGhlIHNhbWUgZXZlbiBpZiB0aGV5IGhhdmUgYSBkaWZmZXJlbnQgbnVtYmVyIG9mXG4gIC8vIGNoaWxkcmVuLiBUaGlzIHdpbGwgcmVkdWNlIHJlbW92aW5nIGFuZCByZS1hZGRpbmcgc2ltaWxhciBlbGVtZW50cy5cbiAgbGV0IHN1YnNldHNTYW1lID0gYzFMZW5ndGggPT09IGMyTGVuZ3RoXG4gIGxldCBvcmlnaW5cbiAgbGV0IHJldFxuICBsZXQgYzFJbmRleDogbnVtYmVyXG4gIGxldCBjMkluZGV4OiBudW1iZXJcbiAgbGV0IGMxRWxlbWVudDogSVNpbXBsaWZpZWROb2RlXG4gIGxldCBjMkVsZW1lbnQ6IElTaW1wbGlmaWVkTm9kZVxuXG4gIGlmIChzdWJzZXRzU2FtZSkge1xuICAgIGMxLnNvbWUoZnVuY3Rpb24oZWxlbWVudCwgaSkge1xuICAgICAgbGV0IGMxRGVzYyA9IGVsZW1lbnREZXNjcmlwdG9ycyhlbGVtZW50KVxuICAgICAgbGV0IGMyRGVzYyA9IGVsZW1lbnREZXNjcmlwdG9ycyhjMltpXSlcbiAgICAgIGlmIChjMURlc2MubGVuZ3RoICE9PSBjMkRlc2MubGVuZ3RoKSB7XG4gICAgICAgIHN1YnNldHNTYW1lID0gZmFsc2VcbiAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgIH1cbiAgICAgIGMxRGVzYy5zb21lKGZ1bmN0aW9uKGRlc2NyaXB0aW9uLCBpKSB7XG4gICAgICAgIGlmIChkZXNjcmlwdGlvbiAhPT0gYzJEZXNjW2ldKSB7XG4gICAgICAgICAgc3Vic2V0c1NhbWUgPSBmYWxzZVxuICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICBpZiAoIXN1YnNldHNTYW1lKSB7XG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8vIGZpbGwgdGhlIG1hdGNoZXMgd2l0aCBkaXN0YW5jZSB2YWx1ZXNcbiAgZm9yIChjMUluZGV4ID0gMDsgYzFJbmRleCA8IGMxTGVuZ3RoOyBjMUluZGV4KyspIHtcbiAgICBjMUVsZW1lbnQgPSBjMVtjMUluZGV4XVxuICAgIGZvciAoYzJJbmRleCA9IDA7IGMySW5kZXggPCBjMkxlbmd0aDsgYzJJbmRleCsrKSB7XG4gICAgICBjMkVsZW1lbnQgPSBjMltjMkluZGV4XVxuICAgICAgaWYgKFxuICAgICAgICAhbWFya2VkMVtjMUluZGV4XSAmJlxuICAgICAgICAhbWFya2VkMltjMkluZGV4XSAmJlxuICAgICAgICByb3VnaGx5RXF1YWwoYzFFbGVtZW50LCBjMkVsZW1lbnQsIHVuaXF1ZURlc2NyaXB0b3JzLCBzdWJzZXRzU2FtZSlcbiAgICAgICkge1xuICAgICAgICBtYXRjaGVzW2MxSW5kZXggKyAxXVtjMkluZGV4ICsgMV0gPSBtYXRjaGVzW2MxSW5kZXhdW2MySW5kZXhdID8gbWF0Y2hlc1tjMUluZGV4XVtjMkluZGV4XSArIDEgOiAxXG4gICAgICAgIGlmIChtYXRjaGVzW2MxSW5kZXggKyAxXVtjMkluZGV4ICsgMV0gPj0gbGNzU2l6ZSkge1xuICAgICAgICAgIGxjc1NpemUgPSBtYXRjaGVzW2MxSW5kZXggKyAxXVtjMkluZGV4ICsgMV1cbiAgICAgICAgICBpbmRleCA9IFtjMUluZGV4ICsgMSwgYzJJbmRleCArIDFdXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG1hdGNoZXNbYzFJbmRleCArIDFdW2MySW5kZXggKyAxXSA9IDBcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpZiAobGNzU2l6ZSA9PT0gMCkge1xuICAgIHJldHVybiB1bmRlZmluZWRcbiAgfVxuICBvcmlnaW4gPSBbaW5kZXhbMF0gLSBsY3NTaXplLCBpbmRleFsxXSAtIGxjc1NpemVdXG4gIHJldCA9IG5ldyBTdWJzZXRNYXBwaW5nKG9yaWdpblswXSwgb3JpZ2luWzFdKVxuICByZXQubGVuZ3RoID0gbGNzU2l6ZVxuXG4gIHJldHVybiByZXRcbn1cblxuLyoqXG4gKiBUaGlzIHNob3VsZCByZWFsbHkgYmUgYSBwcmVkZWZpbmVkIGZ1bmN0aW9uIGluIEFycmF5Li4uXG4gKi9cbmZ1bmN0aW9uIG1ha2VBcnJheTxUPihuOiBudW1iZXIsIHY6IFQpOiBUW10ge1xuICByZXR1cm4gQXJyYXkuYXBwbHkobnVsbCwgbmV3IEFycmF5KG4pKS5tYXAoZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHZcbiAgfSlcbn1cblxuLyoqXG4gKiBHZW5lcmF0ZSBhcnJheXMgdGhhdCBpbmRpY2F0ZSB3aGljaCBub2RlIGJlbG9uZ3MgdG8gd2hpY2ggc3Vic2V0LFxuICogb3Igd2hldGhlciBpdCdzIGFjdHVhbGx5IGFuIG9ycGhhbiBub2RlLCBleGlzdGluZyBpbiBvbmx5IG9uZVxuICogb2YgdGhlIHR3byB0cmVlcywgcmF0aGVyIHRoYW4gc29tZXdoZXJlIGluIGJvdGguXG4gKlxuICogU28gaWYgdDEgPSA8aW1nPjxjYW52YXM+PGJyPiwgdDIgPSA8Y2FudmFzPjxicj48aW1nPi5cbiAqIFRoZSBsb25nZXN0IHN1YnNldCBpcyBcIjxjYW52YXM+PGJyPlwiIChsZW5ndGggMiksIHNvIGl0IHdpbGwgZ3JvdXAgMC5cbiAqIFRoZSBzZWNvbmQgbG9uZ2VzdCBpcyBcIjxpbWc+XCIgKGxlbmd0aCAxKSwgc28gaXQgd2lsbCBiZSBncm91cCAxLlxuICogZ2FwczEgd2lsbCB0aGVyZWZvcmUgYmUgWzEsMCwwXSBhbmQgZ2FwczIgWzAsMCwxXS5cbiAqXG4gKiBJZiBhbiBlbGVtZW50IGlzIG5vdCBwYXJ0IG9mIGFueSBncm91cCwgaXQgd2lsbCBzdGF5IGJlaW5nICd0cnVlJywgd2hpY2hcbiAqIGlzIHRoZSBpbml0aWFsIHZhbHVlLiBGb3IgZXhhbXBsZTpcbiAqIHQxID0gPGltZz48cD48L3A+PGJyPjxjYW52YXM+LCB0MiA9IDxiPjwvYj48YnI+PGNhbnZhcz48aW1nPlxuICpcbiAqIFRoZSBcIjxwPjwvcD5cIiBhbmQgXCI8Yj48L2I+XCIgZG8gb25seSBzaG93IHVwIGluIG9uZSBvZiB0aGUgdHdvIGFuZCB3aWxsXG4gKiB0aGVyZWZvcmUgYmUgbWFya2VkIGJ5IFwidHJ1ZVwiLiBUaGUgcmVtYWluaW5nIHBhcnRzIGFyZSBwYXJ0cyBvZiB0aGVcbiAqIGdyb3VwcyAwIGFuZCAxOlxuICogZ2FwczEgPSBbMSwgdHJ1ZSwgMCwgMF0sIGdhcHMyID0gW3RydWUsIDAsIDAsIDFdXG4gKlxuICovXG5mdW5jdGlvbiBnZXRHYXBJbmZvcm1hdGlvbih0MTogSVNpbXBsaWZpZWROb2RlLCB0MjogSVNpbXBsaWZpZWROb2RlLCBzdGFibGU6IFN1YnNldE1hcHBpbmdbXSkge1xuICBsZXQgZ2FwczE6IChudW1iZXIgfCB0cnVlKVtdID0gdDEuY2hpbGRyZW5cbiAgICA/IChtYWtlQXJyYXkodDEuY2hpbGRyZW4uZmlsdGVyKGZpbHRlckhhdmluZ1RhZykubGVuZ3RoLCB0cnVlKSBhcyB0cnVlW10pXG4gICAgOiBbXVxuICBsZXQgZ2FwczI6IChudW1iZXIgfCB0cnVlKVtdID0gdDIuY2hpbGRyZW5cbiAgICA/IChtYWtlQXJyYXkodDIuY2hpbGRyZW4uZmlsdGVyKGZpbHRlckhhdmluZ1RhZykubGVuZ3RoLCB0cnVlKSBhcyB0cnVlW10pXG4gICAgOiBbXVxuICBsZXQgZ3JvdXAgPSAwXG4gIGxldCBsZW5ndGggPSBzdGFibGUubGVuZ3RoXG4gIGxldCBpOiBudW1iZXJcbiAgbGV0IGo6IG51bWJlclxuICBsZXQgZW5kT2xkOiBudW1iZXJcbiAgbGV0IGVuZE5ldzogbnVtYmVyXG4gIGxldCBzdWJzZXQ6IFN1YnNldE1hcHBpbmdcblxuICAvLyBnaXZlIGVsZW1lbnRzIGZyb20gdGhlIHNhbWUgc3Vic2V0IHRoZSBzYW1lIGdyb3VwIG51bWJlclxuICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICBzdWJzZXQgPSBzdGFibGVbaV1cbiAgICBlbmRPbGQgPSBzdWJzZXQub2xkVmFsdWUgKyBzdWJzZXQubGVuZ3RoXG4gICAgZW5kTmV3ID0gc3Vic2V0Lm5ld1ZhbHVlICsgc3Vic2V0Lmxlbmd0aFxuICAgIGZvciAoaiA9IHN1YnNldC5vbGRWYWx1ZTsgaiA8IGVuZE9sZDsgaiArPSAxKSB7XG4gICAgICBnYXBzMVtqXSA9IGdyb3VwXG4gICAgfVxuICAgIGZvciAoaiA9IHN1YnNldC5uZXdWYWx1ZTsgaiA8IGVuZE5ldzsgaiArPSAxKSB7XG4gICAgICBnYXBzMltqXSA9IGdyb3VwXG4gICAgfVxuICAgIGdyb3VwICs9IDFcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgZ2FwczE6IGdhcHMxLFxuICAgIGdhcHMyOiBnYXBzMlxuICB9XG59XG5cbi8qKlxuICogRmluZCBhbGwgbWF0Y2hpbmcgc3Vic2V0cywgYmFzZWQgb24gaW1tZWRpYXRlIGNoaWxkIGRpZmZlcmVuY2VzIG9ubHkuXG4gKi9cbmZ1bmN0aW9uIG1hcmtTdWJUcmVlcyhvbGRUcmVlOiBJU2ltcGxpZmllZE5vZGUsIG5ld1RyZWU6IElTaW1wbGlmaWVkTm9kZSkge1xuICAvLyBub3RlOiB0aGUgY2hpbGQgbGlzdHMgYXJlIHZpZXdzLCBhbmQgc28gdXBkYXRlIGFzIHdlIHVwZGF0ZSBvbGQvbmV3VHJlZVxuICBsZXQgb2xkQ2hpbGRyZW4gPSBvbGRUcmVlLmNoaWxkcmVuID8gb2xkVHJlZS5jaGlsZHJlbi5maWx0ZXIoZmlsdGVySGF2aW5nVGFnKSA6IFtdXG4gIGxldCBuZXdDaGlsZHJlbiA9IG5ld1RyZWUuY2hpbGRyZW4gPyBuZXdUcmVlLmNoaWxkcmVuLmZpbHRlcihmaWx0ZXJIYXZpbmdUYWcpIDogW11cbiAgbGV0IG1hcmtlZDEgPSBtYWtlQXJyYXkob2xkQ2hpbGRyZW4ubGVuZ3RoLCBmYWxzZSlcbiAgbGV0IG1hcmtlZDIgPSBtYWtlQXJyYXkobmV3Q2hpbGRyZW4ubGVuZ3RoLCBmYWxzZSlcbiAgbGV0IHN1YnNldHMgPSBbXVxuICBsZXQgc3Vic2V0OiBTdWJzZXRNYXBwaW5nXG4gIGxldCByZXR1cm5JbmRleCA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBhcmd1bWVudHNbMV1cbiAgfVxuICBsZXQgbWFya0JvdGggPSBmdW5jdGlvbihpKSB7XG4gICAgbWFya2VkMVtzdWJzZXQub2xkVmFsdWUgKyBpXSA9IHRydWVcbiAgICBtYXJrZWQyW3N1YnNldC5uZXdWYWx1ZSArIGldID0gdHJ1ZVxuICB9XG4gIGxldCBzdWJzZXRBcnJheTogbnVtYmVyW11cblxuICBkbyB7XG4gICAgc3Vic2V0ID0gZmluZENvbW1vblN1YnNldHMob2xkQ2hpbGRyZW4sIG5ld0NoaWxkcmVuLCBtYXJrZWQxLCBtYXJrZWQyKVxuICAgIGlmIChzdWJzZXQpIHtcbiAgICAgIHN1YnNldHMucHVzaChzdWJzZXQpXG4gICAgICBzdWJzZXRBcnJheSA9IEFycmF5LmFwcGx5KG51bGwsIG5ldyBBcnJheShzdWJzZXQubGVuZ3RoKSkubWFwKHJldHVybkluZGV4KVxuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN1YnNldEFycmF5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIG1hcmtCb3RoKHN1YnNldEFycmF5W2ldKVxuICAgICAgfVxuICAgIH1cbiAgfSB3aGlsZSAoc3Vic2V0KVxuICByZXR1cm4gc3Vic2V0c1xufVxuXG5leHBvcnQgY2xhc3MgRGlmZkRPTSB7XG4gIHRyYWNrZXI6IERpZmZbXVxuICB0MU9yaWc6IElTaW1wbGlmaWVkTm9kZVxuICB0Mk9yaWc6IElTaW1wbGlmaWVkTm9kZVxuICBkZWJ1ZyA9IGZhbHNlXG4gIGRpZmZjYXAgPSAxMCAvLyBMaW1pdCBmb3IgaG93IG1hbnkgZGlmZnMgYXJlIGFjY2VwdGluZyB3aGVuIGRlYnVnZ2luZy4gSW5hY3RpdmUgd2hlbiBkZWJ1ZyBpcyBmYWxzZS5cbiAgbWF4RGVwdGg6IG51bWJlciB8IGZhbHNlID0gZmFsc2UgLy8gRmFsc2Ugb3IgYSBudW1lcmFsLiBJZiBzZXQgdG8gYSBudW1lcmFsLCBsaW1pdHMgdGhlIGxldmVsIG9mIGRlcHRoIHRoYXQgdGhlIHRoZSBkaWZmIG1lY2hhbmlzbSBsb29rcyBmb3IgZGlmZmVyZW5jZXMuIElmIGZhbHNlLCBnb2VzIHRocm91Z2ggdGhlIGVudGlyZSB0cmVlLlxuICBtYXhDaGlsZENvdW50OiBudW1iZXIgfCBmYWxzZSA9IGZhbHNlIC8vIEZhbHNlIG9yIGEgbnVtZXJhbC4gSWYgc2V0IHRvIGEgbnVtZXJhbCwgZG9lcyBub3QgdHJ5IHRvIGRpZmYgdGhlIGNvbnRlbnRzIG9mIG5vZGVzIHdpdGggbW9yZSBjaGlsZHJlbiBpZiB0aGVyZSBhcmUgbW9yZSB0aGFuIG1heENoaWxkQ291bnREaWZmQ291bnQgZGlmZmVyZW5jZXMgYW1vbmcgY2hpbGQgbm9kZXMuXG4gIG1heENoaWxkQ291bnREaWZmQ291bnQgPSAzIC8vIE51bWVyYWwuIFNlZSBtYXhDaGlsZENvdW50LlxuICBmaWx0ZXJPdXRlckRpZmYgPSBudWxsXG4gIGNvbXByZXNzID0gZmFsc2VcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgb3B0aW9ucyA9IHt9KSB7fVxuXG4gIC8vID09PT09IENyZWF0ZSBhIGRpZmYgPT09PT1cblxuICBkaWZmKHQxTm9kZTogSVNpbXBsaWZpZWROb2RlLCB0Mk5vZGU6IElTaW1wbGlmaWVkTm9kZSk6IERpZmZbXSB7XG4gICAgZGlmZmNvdW50ID0gMFxuXG4gICAgaWYgKHRoaXMuZGVidWcpIHtcbiAgICAgIHRoaXMudDFPcmlnID0gdDFOb2RlXG4gICAgICB0aGlzLnQyT3JpZyA9IHQyTm9kZVxuICAgIH1cblxuICAgIHRoaXMudHJhY2tlciA9IFtdXG4gICAgcmV0dXJuIHRoaXMuZmluZERpZmZzKHQxTm9kZSwgdDJOb2RlKVxuICB9XG5cbiAgZmluZERpZmZzKHQxOiBJU2ltcGxpZmllZE5vZGUsIHQyOiBJU2ltcGxpZmllZE5vZGUpOiBEaWZmW10ge1xuICAgIGxldCBkaWZmczogRGlmZltdXG4gICAgZG8ge1xuICAgICAgaWYgKHRoaXMuZGVidWcpIHtcbiAgICAgICAgZGlmZmNvdW50ICs9IDFcbiAgICAgICAgaWYgKGRpZmZjb3VudCA+IHRoaXMuZGlmZmNhcCkge1xuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuICAgICAgICAgIDsod2luZG93IGFzIGFueSkuZGlmZkVycm9yID0gW3RoaXMudDFPcmlnLCB0aGlzLnQyT3JpZ11cbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3N1cnBhc3NlZCBkaWZmY2FwOicgKyBKU09OLnN0cmluZ2lmeSh0aGlzLnQxT3JpZykgKyAnIC0+ICcgKyBKU09OLnN0cmluZ2lmeSh0aGlzLnQyT3JpZykpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGRpZmZzID0gdGhpcy5maW5kTmV4dERpZmYodDEsIHQyLCBbXSlcblxuICAgICAgaWYgKGRpZmZzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAvLyBMYXN0IGNoZWNrIGlmIHRoZSBlbGVtZW50cyByZWFsbHkgYXJlIHRoZSBzYW1lIG5vdy5cbiAgICAgICAgLy8gSWYgbm90LCByZW1vdmUgYWxsIGluZm8gYWJvdXQgYmVpbmcgZG9uZSBhbmQgc3RhcnQgb3Zlci5cbiAgICAgICAgLy8gU29tZXRpbWVzIGEgbm9kZSBjYW4gYmUgbWFya2VkIGFzIGRvbmUsIGJ1dCB0aGUgY3JlYXRpb24gb2Ygc3Vic2VxdWVudCBkaWZmcyBtZWFucyB0aGF0IGl0IGhhcyB0byBiZSBjaGFuZ2VkIGFnYWluLlxuICAgICAgICBpZiAoIWlzRXF1YWwodDEsIHQyKSkge1xuICAgICAgICAgIGlmIChmb3VuZEFsbCkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignQ291bGQgbm90IGZpbmQgcmVtYWluaW5nIGRpZmZzIScpXG4gICAgICAgICAgICBjb25zb2xlLnRyYWNlKHsgdDEsIHQyIH0pXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZvdW5kQWxsID0gdHJ1ZVxuICAgICAgICAgICAgcmVtb3ZlRG9uZSh0MSlcbiAgICAgICAgICAgIGRpZmZzID0gdGhpcy5maW5kTmV4dERpZmYodDEsIHQyLCBbXSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChkaWZmcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGZvdW5kQWxsID0gZmFsc2VcbiAgICAgICAgdGhpcy50cmFja2VyLnB1c2goLi4uZGlmZnMpXG4gICAgICAgIHRoaXMuYXBwbHlWaXJ0dWFsKHQxLCBkaWZmcylcbiAgICAgIH1cbiAgICB9IHdoaWxlIChkaWZmcy5sZW5ndGggPiAwKVxuICAgIHJldHVybiB0aGlzLnRyYWNrZXJcbiAgfVxuXG4gIGZpbmROZXh0RGlmZih0MTogSVNpbXBsaWZpZWROb2RlLCB0MjogSVNpbXBsaWZpZWROb2RlLCByb3V0ZTogbnVtYmVyW10pOiBEaWZmW10ge1xuICAgIGxldCBkaWZmczogRGlmZltdXG4gICAgbGV0IGZkaWZmc1xuXG4gICAgaWYgKHRoaXMubWF4RGVwdGggJiYgcm91dGUubGVuZ3RoID4gdGhpcy5tYXhEZXB0aCkge1xuICAgICAgcmV0dXJuIFtdXG4gICAgfVxuICAgIC8vIG91dGVyIGRpZmZlcmVuY2VzP1xuICAgIGlmICghdDFbb3V0ZXJEb25lXSkge1xuICAgICAgZGlmZnMgPSB0aGlzLmZpbmRPdXRlckRpZmYodDEsIHQyLCByb3V0ZSlcbiAgICAgIGlmICh0aGlzLmZpbHRlck91dGVyRGlmZikge1xuICAgICAgICBmZGlmZnMgPSB0aGlzLmZpbHRlck91dGVyRGlmZih0MSwgdDIsIGRpZmZzKVxuICAgICAgICBpZiAoZmRpZmZzKSBkaWZmcyA9IGZkaWZmc1xuICAgICAgfVxuICAgICAgaWYgKGRpZmZzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdDFbb3V0ZXJEb25lXSA9IHRydWVcbiAgICAgICAgcmV0dXJuIGRpZmZzXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0MVtvdXRlckRvbmVdID0gdHJ1ZVxuICAgICAgfVxuICAgIH1cbiAgICAvLyBpbm5lciBkaWZmZXJlbmNlcz9cbiAgICBpZiAoIXQxW2lubmVyRG9uZV0pIHtcbiAgICAgIGRpZmZzID0gdGhpcy5maW5kSW5uZXJEaWZmKHQxLCB0Miwgcm91dGUpXG4gICAgICBpZiAoZGlmZnMubGVuZ3RoID4gMCkge1xuICAgICAgICByZXR1cm4gZGlmZnNcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHQxW2lubmVyRG9uZV0gPSB0cnVlXG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gbm8gZGlmZmVyZW5jZXNcbiAgICByZXR1cm4gW11cbiAgfVxuICBmaW5kT3V0ZXJEaWZmKHQxOiBJU2ltcGxpZmllZE5vZGUsIHQyOiBJU2ltcGxpZmllZE5vZGUsIHJvdXRlOiBudW1iZXJbXSk6IERpZmZbXSB7XG4gICAgbGV0IGRpZmZzOiBEaWZmW10gPSBbXVxuICAgIGxldCBhdHRyXG4gICAgbGV0IGF0dHIxXG4gICAgbGV0IGF0dHIyXG4gICAgbGV0IGF0dHJMZW5ndGhcbiAgICBsZXQgcG9zXG4gICAgbGV0IGlcblxuICAgIGlmICh0MS50YWcgIT09IHQyLnRhZykge1xuICAgICAgcmV0dXJuIFtcbiAgICAgICAgbmV3IERpZmYoKVxuICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLmFjdGlvbiwgQWN0aW9ucy5yZXBsYWNlRWxlbWVudClcbiAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5vbGRWYWx1ZSwgdDEpXG4gICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMubmV3VmFsdWUsIGNsb25lT2JqKHQyKSlcbiAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5yb3V0ZSwgcm91dGUpXG4gICAgICBdXG4gICAgfVxuXG4gICAgbGV0IHQxQ2hpbGRyZW4gPSB0MS5jaGlsZHJlbi5maWx0ZXIoZmlsdGVySGF2aW5nVGFnKVxuICAgIGxldCB0MkNoaWxkcmVuID0gdDIuY2hpbGRyZW4uZmlsdGVyKGZpbHRlckhhdmluZ1RhZylcblxuICAgIGlmIChcbiAgICAgIHRoaXMubWF4Q2hpbGRDb3VudCAmJlxuICAgICAgdDFDaGlsZHJlbiAmJlxuICAgICAgdDJDaGlsZHJlbiAmJlxuICAgICAgdDFDaGlsZHJlbi5sZW5ndGggPiB0aGlzLm1heENoaWxkQ291bnQgJiZcbiAgICAgIHQyQ2hpbGRyZW4ubGVuZ3RoID4gdGhpcy5tYXhDaGlsZENvdW50XG4gICAgKSB7XG4gICAgICBsZXQgY2hpbGROb2Rlc0xlbmd0aCA9IHQxQ2hpbGRyZW4ubGVuZ3RoIDwgdDJDaGlsZHJlbi5sZW5ndGggPyB0MUNoaWxkcmVuLmxlbmd0aCA6IHQyQ2hpbGRyZW4ubGVuZ3RoXG4gICAgICBsZXQgY2hpbGREaWZmQ291bnQgPSAwXG4gICAgICBsZXQgaiA9IDBcbiAgICAgIHdoaWxlIChjaGlsZERpZmZDb3VudCA8IHRoaXMubWF4Q2hpbGRDb3VudERpZmZDb3VudCAmJiBqIDwgY2hpbGROb2Rlc0xlbmd0aCkge1xuICAgICAgICBpZiAoIWlzRXF1YWwodDFDaGlsZHJlbltqXSwgdDJDaGlsZHJlbltqXSkpIHtcbiAgICAgICAgICBjaGlsZERpZmZDb3VudCsrXG4gICAgICAgIH1cbiAgICAgICAgaisrXG4gICAgICB9XG4gICAgICBpZiAoY2hpbGREaWZmQ291bnQgPT09IHRoaXMubWF4Q2hpbGRDb3VudERpZmZDb3VudCkge1xuICAgICAgICByZXR1cm4gW1xuICAgICAgICAgIG5ldyBEaWZmKClcbiAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLmFjdGlvbiwgQWN0aW9ucy5yZXBsYWNlRWxlbWVudClcbiAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLm9sZFZhbHVlLCBjbG9uZU9iaih0MSkpXG4gICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5uZXdWYWx1ZSwgY2xvbmVPYmoodDIpKVxuICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMucm91dGUsIHJvdXRlKVxuICAgICAgICBdXG4gICAgICB9XG4gICAgfVxuXG4gICAgYXR0cjEgPSB0MS5hdHRycyA/IE9iamVjdC5rZXlzKHQxLmF0dHJzKS5zb3J0KCkgOiBbXVxuICAgIGF0dHIyID0gdDIuYXR0cnMgPyBPYmplY3Qua2V5cyh0Mi5hdHRycykuc29ydCgpIDogW11cblxuICAgIGF0dHJMZW5ndGggPSBhdHRyMS5sZW5ndGhcbiAgICBmb3IgKGkgPSAwOyBpIDwgYXR0ckxlbmd0aDsgaSsrKSB7XG4gICAgICBhdHRyID0gYXR0cjFbaV1cbiAgICAgIHBvcyA9IGF0dHIyLmluZGV4T2YoYXR0cilcbiAgICAgIGlmIChwb3MgPT09IC0xKSB7XG4gICAgICAgIGRpZmZzLnB1c2goXG4gICAgICAgICAgbmV3IERpZmYoKVxuICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMuYWN0aW9uLCBBY3Rpb25zLnJlbW92ZUF0dHJpYnV0ZSlcbiAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLnJvdXRlLCByb3V0ZSlcbiAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLm5hbWUsIGF0dHIpXG4gICAgICAgIClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF0dHIyLnNwbGljZShwb3MsIDEpXG4gICAgICAgIGlmICghZGVlcEVxdWFsKHQxLmF0dHJzW2F0dHJdLCB0Mi5hdHRyc1thdHRyXSkpIHtcbiAgICAgICAgICBkaWZmcy5wdXNoKFxuICAgICAgICAgICAgbmV3IERpZmYoKVxuICAgICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5hY3Rpb24sIEFjdGlvbnMubW9kaWZ5QXR0cmlidXRlKVxuICAgICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5yb3V0ZSwgcm91dGUpXG4gICAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLm5hbWUsIGF0dHIpXG4gICAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLm9sZFZhbHVlLCB0MS5hdHRyc1thdHRyXSlcbiAgICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMubmV3VmFsdWUsIHQyLmF0dHJzW2F0dHJdKVxuICAgICAgICAgIClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGF0dHJMZW5ndGggPSBhdHRyMi5sZW5ndGhcbiAgICBmb3IgKGkgPSAwOyBpIDwgYXR0ckxlbmd0aDsgaSsrKSB7XG4gICAgICBhdHRyID0gYXR0cjJbaV1cbiAgICAgIGRpZmZzLnB1c2goXG4gICAgICAgIG5ldyBEaWZmKClcbiAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5hY3Rpb24sIEFjdGlvbnMuYWRkQXR0cmlidXRlKVxuICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLnJvdXRlLCByb3V0ZSlcbiAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5uYW1lLCBhdHRyKVxuICAgICAgKVxuICAgIH1cblxuICAgIHJldHVybiBkaWZmc1xuICB9XG4gIGZpbmRJbm5lckRpZmYodDE6IElTaW1wbGlmaWVkTm9kZSwgdDI6IElTaW1wbGlmaWVkTm9kZSwgcm91dGU6IG51bWJlcltdKTogRGlmZltdIHtcbiAgICBsZXQgc3VidHJlZXMgPSB0MS5jaGlsZHJlbiAmJiB0Mi5jaGlsZHJlbiA/IG1hcmtTdWJUcmVlcyh0MSwgdDIpIDogW11cbiAgICBsZXQgdDFDaGlsZE5vZGVzID0gdDEuY2hpbGRyZW4gPyB0MS5jaGlsZHJlbi5maWx0ZXIoZmlsdGVySGF2aW5nVGFnKSA6IFtdXG4gICAgbGV0IHQyQ2hpbGROb2RlcyA9IHQyLmNoaWxkcmVuID8gdDIuY2hpbGRyZW4uZmlsdGVyKGZpbHRlckhhdmluZ1RhZykgOiBbXVxuICAgIGxldCBjaGlsZE5vZGVzTGVuZ3RoRGlmZmVyZW5jZVxuICAgIGxldCBkaWZmczogRGlmZltdID0gW11cbiAgICBsZXQgaW5kZXggPSAwXG4gICAgbGV0IGxhc3RcbiAgICBsZXQgZTFcbiAgICBsZXQgZTJcbiAgICBsZXQgaVxuXG4gICAgaWYgKHN1YnRyZWVzLmxlbmd0aCA+IDApIHtcbiAgICAgIC8qIE9uZSBvciBtb3JlIGdyb3VwcyBoYXZlIGJlZW4gaWRlbnRpZmllZCBhbW9uZyB0aGUgY2hpbGRyZW4gb2YgdDFcbiAgICAgICAqIGFuZCB0Mi5cbiAgICAgICAqL1xuICAgICAgZGlmZnMgPSB0aGlzLmF0dGVtcHRHcm91cFJlbG9jYXRpb24odDEsIHQyLCBzdWJ0cmVlcywgcm91dGUpXG4gICAgICBpZiAoZGlmZnMubGVuZ3RoID4gMCkge1xuICAgICAgICByZXR1cm4gZGlmZnNcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvKiAwIG9yIDEgZ3JvdXBzIG9mIHNpbWlsYXIgY2hpbGQgbm9kZXMgaGF2ZSBiZWVuIGZvdW5kXG4gICAgICogZm9yIHQxIGFuZCB0Mi4gMSBJZiB0aGVyZSBpcyAxLCBpdCBjb3VsZCBiZSBhIHNpZ24gdGhhdCB0aGVcbiAgICAgKiBjb250ZW50cyBhcmUgdGhlIHNhbWUuIFdoZW4gdGhlIG51bWJlciBvZiBncm91cHMgaXMgYmVsb3cgMixcbiAgICAgKiB0MSBhbmQgdDIgYXJlIG1hZGUgdG8gaGF2ZSB0aGUgc2FtZSBsZW5ndGggYW5kIGVhY2ggb2YgdGhlXG4gICAgICogcGFpcnMgb2YgY2hpbGQgbm9kZXMgYXJlIGRpZmZlZC5cbiAgICAgKi9cblxuICAgIGxhc3QgPSBNYXRoLm1heCh0MUNoaWxkTm9kZXMubGVuZ3RoLCB0MkNoaWxkTm9kZXMubGVuZ3RoKVxuICAgIGlmICh0MUNoaWxkTm9kZXMubGVuZ3RoICE9PSB0MkNoaWxkTm9kZXMubGVuZ3RoKSB7XG4gICAgICBjaGlsZE5vZGVzTGVuZ3RoRGlmZmVyZW5jZSA9IHRydWVcbiAgICB9XG5cbiAgICBmb3IgKGkgPSAwOyBpIDwgbGFzdDsgaSArPSAxKSB7XG4gICAgICBlMSA9IHQxQ2hpbGROb2Rlc1tpXVxuICAgICAgZTIgPSB0MkNoaWxkTm9kZXNbaV1cblxuICAgICAgaWYgKGNoaWxkTm9kZXNMZW5ndGhEaWZmZXJlbmNlKSB7XG4gICAgICAgIC8qIHQxIGFuZCB0MiBoYXZlIGRpZmZlcmVudCBhbW91bnRzIG9mIGNoaWxkcmVuLiBBZGRcbiAgICAgICAgICogYW5kIHJlbW92ZSBhcyBuZWNlc3NhcnkgdG8gb2J0YWluIHRoZSBzYW1lIGxlbmd0aCAqL1xuICAgICAgICBpZiAoZTEgJiYgIWUyKSB7XG4gICAgICAgICAgZGlmZnMucHVzaChcbiAgICAgICAgICAgIG5ldyBEaWZmKClcbiAgICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMuYWN0aW9uLCBBY3Rpb25zLnJlbW92ZUVsZW1lbnQpXG4gICAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLnJvdXRlLCByb3V0ZS5jb25jYXQoaW5kZXgpKVxuICAgICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5lbGVtZW50LCBlMSlcbiAgICAgICAgICApXG4gICAgICAgICAgaW5kZXggLT0gMVxuICAgICAgICB9IGVsc2UgaWYgKGUyICYmICFlMSkge1xuICAgICAgICAgIGRpZmZzLnB1c2goXG4gICAgICAgICAgICBuZXcgRGlmZigpXG4gICAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLmFjdGlvbiwgQWN0aW9ucy5hZGRFbGVtZW50KVxuICAgICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5yb3V0ZSwgcm91dGUuY29uY2F0KGluZGV4KSlcbiAgICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMuZWxlbWVudCwgY2xvbmVPYmooZTIpKVxuICAgICAgICAgIClcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLyogV2UgYXJlIG5vdyBndWFyYW50ZWVkIHRoYXQgY2hpbGRyZW4gZTEgYW5kIGUyIGV4aXN0LFxuICAgICAgICogYW5kIHRoYXQgdGhleSBjYW4gYmUgZGlmZmVkLlxuICAgICAgICovXG4gICAgICAvKiBEaWZmcyBpbiBjaGlsZCBub2RlcyBzaG91bGQgbm90IGFmZmVjdCB0aGUgcGFyZW50IG5vZGUsXG4gICAgICAgKiBzbyB3ZSBsZXQgdGhlc2UgZGlmZnMgYmUgc3VibWl0dGVkIHRvZ2V0aGVyIHdpdGggb3RoZXJcbiAgICAgICAqIGRpZmZzLlxuICAgICAgICovXG5cbiAgICAgIGlmIChlMSAmJiBlMikge1xuICAgICAgICBkaWZmcyA9IGRpZmZzLmNvbmNhdCh0aGlzLmZpbmROZXh0RGlmZihlMSwgZTIsIHJvdXRlLmNvbmNhdChpbmRleCkpKVxuICAgICAgfVxuXG4gICAgICBpbmRleCArPSAxXG4gICAgfVxuICAgIHQxW2lubmVyRG9uZV0gPSB0cnVlXG4gICAgcmV0dXJuIGRpZmZzXG4gIH1cblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6cHJlZmVyLWZ1bmN0aW9uLW92ZXItbWV0aG9kXG4gIGF0dGVtcHRHcm91cFJlbG9jYXRpb24odDE6IElTaW1wbGlmaWVkTm9kZSwgdDI6IElTaW1wbGlmaWVkTm9kZSwgc3VidHJlZXMsIHJvdXRlOiBudW1iZXJbXSk6IERpZmZbXSB7XG4gICAgLyogRWl0aGVyIHQxLmNoaWxkcmVuIGFuZCB0Mi5jaGlsZHJlbiBoYXZlIHRoZSBzYW1lIGxlbmd0aCwgb3JcbiAgICAgKiB0aGVyZSBhcmUgYXQgbGVhc3QgdHdvIGdyb3VwcyBvZiBzaW1pbGFyIGVsZW1lbnRzIGNhbiBiZSBmb3VuZC5cbiAgICAgKiBhdHRlbXB0cyBhcmUgbWFkZSBhdCBlcXVhbGl6aW5nIHQxIHdpdGggdDIuIEZpcnN0IGFsbCBpbml0aWFsXG4gICAgICogZWxlbWVudHMgd2l0aCBubyBncm91cCBhZmZpbGlhdGlvbiAoZ2Fwcz10cnVlKSBhcmUgcmVtb3ZlZCAoaWZcbiAgICAgKiBvbmx5IGluIHQxKSBvciBhZGRlZCAoaWYgb25seSBpbiB0MikuIFRoZW4gdGhlIGNyZWF0aW9uIG9mIGEgZ3JvdXBcbiAgICAgKiByZWxvY2F0aW9uIGRpZmYgaXMgYXR0ZW1wdGVkLlxuICAgICovXG5cbiAgICBsZXQgZ2FwSW5mb3JtYXRpb24gPSBnZXRHYXBJbmZvcm1hdGlvbih0MSwgdDIsIHN1YnRyZWVzKVxuICAgIGxldCBnYXBzMSA9IGdhcEluZm9ybWF0aW9uLmdhcHMxXG4gICAgbGV0IGdhcHMyID0gZ2FwSW5mb3JtYXRpb24uZ2FwczJcbiAgICBsZXQgc2hvcnRlc3QgPSBNYXRoLm1pbihnYXBzMS5sZW5ndGgsIGdhcHMyLmxlbmd0aClcbiAgICBsZXQgZGVzdGluYXRpb25EaWZmZXJlbnQ6IGJvb2xlYW5cbiAgICBsZXQgdG9Hcm91cFxuICAgIGxldCBncm91cFxuICAgIGxldCBub2RlXG4gICAgbGV0IGRpZmZzOiBEaWZmW10gPSBbXVxuICAgIGxldCBpbmRleDFcbiAgICBsZXQgaW5kZXgyXG4gICAgbGV0IGpcblxuICAgIGxldCB0MUNoaWxkcmVuID0gdDEuY2hpbGRyZW4uZmlsdGVyKGZpbHRlckhhdmluZ1RhZylcbiAgICBsZXQgdDJDaGlsZHJlbiA9IHQyLmNoaWxkcmVuLmZpbHRlcihmaWx0ZXJIYXZpbmdUYWcpXG5cbiAgICBmb3IgKGluZGV4MiA9IDAsIGluZGV4MSA9IDA7IGluZGV4MiA8IHNob3J0ZXN0OyBpbmRleDEgKz0gMSwgaW5kZXgyICs9IDEpIHtcbiAgICAgIGlmIChnYXBzMVtpbmRleDJdID09PSB0cnVlKSB7XG4gICAgICAgIG5vZGUgPSB0MUNoaWxkcmVuW2luZGV4MV1cbiAgICAgICAgZGlmZnMucHVzaChcbiAgICAgICAgICBuZXcgRGlmZigpXG4gICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5hY3Rpb24sIEFjdGlvbnMucmVtb3ZlRWxlbWVudClcbiAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLnJvdXRlLCByb3V0ZS5jb25jYXQoaW5kZXgyKSlcbiAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLmVsZW1lbnQsIGNsb25lT2JqKG5vZGUpKVxuICAgICAgICApXG4gICAgICAgIGdhcHMxLnNwbGljZShpbmRleDIsIDEpXG4gICAgICAgIHNob3J0ZXN0ID0gTWF0aC5taW4oZ2FwczEubGVuZ3RoLCBnYXBzMi5sZW5ndGgpXG4gICAgICAgIGluZGV4MiAtPSAxXG4gICAgICB9IGVsc2UgaWYgKGdhcHMyW2luZGV4Ml0gPT09IHRydWUpIHtcbiAgICAgICAgbm9kZSA9IHQyQ2hpbGRyZW5baW5kZXgyXVxuXG4gICAgICAgIGRpZmZzLnB1c2goXG4gICAgICAgICAgbmV3IERpZmYoKVxuICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMuYWN0aW9uLCBBY3Rpb25zLmFkZEVsZW1lbnQpXG4gICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5yb3V0ZSwgcm91dGUuY29uY2F0KGluZGV4MikpXG4gICAgICAgICAgICAuc2V0VmFsdWUoQWN0aW9ucy5lbGVtZW50LCBjbG9uZU9iaihub2RlKSlcbiAgICAgICAgKVxuICAgICAgICBnYXBzMS5zcGxpY2UoaW5kZXgyLCAwLCB0cnVlKVxuICAgICAgICBzaG9ydGVzdCA9IE1hdGgubWluKGdhcHMxLmxlbmd0aCwgZ2FwczIubGVuZ3RoKVxuICAgICAgICBpbmRleDEgLT0gMVxuICAgICAgfSBlbHNlIGlmIChnYXBzMVtpbmRleDJdICE9PSBnYXBzMltpbmRleDJdKSB7XG4gICAgICAgIGlmIChkaWZmcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgcmV0dXJuIGRpZmZzXG4gICAgICAgIH1cbiAgICAgICAgLy8gZ3JvdXAgcmVsb2NhdGlvblxuICAgICAgICBncm91cCA9IHN1YnRyZWVzW2dhcHMxW2luZGV4Ml0gYXMgbnVtYmVyXVxuICAgICAgICB0b0dyb3VwID0gTWF0aC5taW4oZ3JvdXAubmV3VmFsdWUsIHQxQ2hpbGRyZW4ubGVuZ3RoIC0gZ3JvdXAubGVuZ3RoKVxuICAgICAgICBpZiAodG9Hcm91cCAhPT0gZ3JvdXAub2xkVmFsdWUpIHtcbiAgICAgICAgICAvLyBDaGVjayB3aGV0aGVyIGRlc3RpbmF0aW9uIG5vZGVzIGFyZSBkaWZmZXJlbnQgdGhhbiBvcmlnaW5hdGluZyBvbmVzLlxuICAgICAgICAgIGRlc3RpbmF0aW9uRGlmZmVyZW50ID0gZmFsc2VcbiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgZ3JvdXAubGVuZ3RoOyBqICs9IDEpIHtcbiAgICAgICAgICAgIGlmICghcm91Z2hseUVxdWFsKHQxQ2hpbGRyZW5bdG9Hcm91cCArIGpdLCB0MUNoaWxkcmVuW2dyb3VwLm9sZFZhbHVlICsgal0sIHt9LCBmYWxzZSwgdHJ1ZSkpIHtcbiAgICAgICAgICAgICAgZGVzdGluYXRpb25EaWZmZXJlbnQgPSB0cnVlXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChkZXN0aW5hdGlvbkRpZmZlcmVudCkge1xuICAgICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgICAgbmV3IERpZmYoKVxuICAgICAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLmFjdGlvbiwgQWN0aW9ucy5yZWxvY2F0ZUdyb3VwKVxuICAgICAgICAgICAgICAgIC5zZXRWYWx1ZShBY3Rpb25zLmdyb3VwTGVuZ3RoLCBncm91cC5sZW5ndGgpXG4gICAgICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMuZnJvbSwgZ3JvdXAub2xkVmFsdWUpXG4gICAgICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMudG8sIHRvR3JvdXApXG4gICAgICAgICAgICAgICAgLnNldFZhbHVlKEFjdGlvbnMucm91dGUsIHJvdXRlKVxuICAgICAgICAgICAgXVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZGlmZnNcbiAgfVxuXG4gIC8vID09PT09IEFwcGx5IGEgdmlydHVhbCBkaWZmID09PT09XG5cbiAgLyoqIFBhdGNoZXMgYSB2aXJ0dWFsIHRyZWUgdXNpbmcgYSBsaXN0IG9mIGRpZmZzICovXG4gIGFwcGx5VmlydHVhbCh0cmVlOiBJU2ltcGxpZmllZE5vZGUsIGRpZmZzOiBJRGlmZltdKSB7XG4gICAgbGV0IGxlbmd0aCA9IGRpZmZzLmxlbmd0aFxuICAgIGlmIChsZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBkaWZmID0gZGlmZnNbaV1cbiAgICAgIHRoaXMuYXBwbHlWaXJ0dWFsRGlmZih0cmVlLCBkaWZmKVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgLyoqIEdldHMgYSBub2RlIGluIHRoZSB2aXJ0dWFsIHRyZWUgYnkgYSByb3V0ZSAqL1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6cHJlZmVyLWZ1bmN0aW9uLW92ZXItbWV0aG9kXG4gIGdldEZyb21WaXJ0dWFsUm91dGUodHJlZTogSVNpbXBsaWZpZWROb2RlLCByb3V0ZTogbnVtYmVyW10pIHtcbiAgICBsZXQgbm9kZSA9IHRyZWVcbiAgICBsZXQgcGFyZW50Tm9kZTogSVNpbXBsaWZpZWROb2RlXG4gICAgbGV0IG5vZGVJbmRleDogbnVtYmVyXG5cbiAgICBsZXQgbmV3Um91dGUgPSByb3V0ZS5zbGljZSgpXG5cbiAgICB3aGlsZSAobmV3Um91dGUubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgY2ggPSBub2RlLmNoaWxkcmVuLmZpbHRlcihmaWx0ZXJIYXZpbmdUYWcpXG5cbiAgICAgIGlmICghY2gubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICAgIH1cblxuICAgICAgbm9kZUluZGV4ID0gbmV3Um91dGUuc2hpZnQoKVxuICAgICAgcGFyZW50Tm9kZSA9IG5vZGVcbiAgICAgIG5vZGUgPSBjaFtub2RlSW5kZXhdXG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5vZGU6IG5vZGUsXG4gICAgICBwYXJlbnROb2RlOiBwYXJlbnROb2RlLFxuICAgICAgbm9kZUluZGV4OiBub2RlSW5kZXhcbiAgICB9XG4gIH1cblxuICAvKiogUGF0Y2hlcyBhIHZpcnR1YWwgdHJlZSB1c2luZyBhIGRpZmYgKi9cbiAgYXBwbHlWaXJ0dWFsRGlmZih0cmVlOiBJU2ltcGxpZmllZE5vZGUsIGRpZmY6IElEaWZmKSB7XG4gICAgbGV0IHJvdXRlSW5mbyA9IHRoaXMuZ2V0RnJvbVZpcnR1YWxSb3V0ZSh0cmVlLCBkaWZmW0FjdGlvbnMucm91dGVdKVxuICAgIGxldCBub2RlID0gcm91dGVJbmZvICYmIHJvdXRlSW5mby5ub2RlXG4gICAgbGV0IHBhcmVudE5vZGUgPSByb3V0ZUluZm8gJiYgcm91dGVJbmZvLnBhcmVudE5vZGVcbiAgICBsZXQgbm9kZUluZGV4ID0gcm91dGVJbmZvICYmIHJvdXRlSW5mby5ub2RlSW5kZXhcbiAgICBsZXQgbmV3Tm9kZTogSVNpbXBsaWZpZWROb2RlXG5cbiAgICAvLyBwcmUtZGlmZiBob29rXG4gICAgbGV0IGluZm8gPSB7XG4gICAgICBkaWZmOiBkaWZmLFxuICAgICAgbm9kZTogbm9kZSxcbiAgICAgIG5ld05vZGU6IHZvaWQgMFxuICAgIH1cblxuICAgIHN3aXRjaCAoZGlmZltBY3Rpb25zLmFjdGlvbl0pIHtcbiAgICAgIGNhc2UgQWN0aW9ucy5hZGRFbGVtZW50OlxuICAgICAgICBjb25zdCByb3V0ZSA9IGRpZmZbQWN0aW9ucy5yb3V0ZV0uc2xpY2UoKVxuICAgICAgICBjb25zdCBwb3NpdGlvbiA9IHJvdXRlLnBvcCgpXG4gICAgICAgIGNvbnN0IHggPSB0aGlzLmdldEZyb21WaXJ0dWFsUm91dGUodHJlZSwgcm91dGUpXG4gICAgICAgIGlmICh4KSB7XG4gICAgICAgICAgbm9kZSA9IHgubm9kZVxuICAgICAgICAgIG5ld05vZGUgPSBjbG9uZU9iaihkaWZmW0FjdGlvbnMuZWxlbWVudF0pXG4gICAgICAgICAgbmV3Tm9kZVtvdXRlckRvbmVdID0gdHJ1ZVxuICAgICAgICAgIG5ld05vZGVbaW5uZXJEb25lXSA9IHRydWVcblxuICAgICAgICAgIGlmICghbm9kZS5jaGlsZHJlbikge1xuICAgICAgICAgICAgbm9kZS5jaGlsZHJlbiA9IFtdXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKG5vZGUuY2hpbGRyZW5bcG9zaXRpb25dKSB7XG4gICAgICAgICAgICBub2RlLmNoaWxkcmVuLnNwbGljZShwb3NpdGlvbiwgMCwgbmV3Tm9kZSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbm9kZS5jaGlsZHJlbi5wdXNoKG5ld05vZGUpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlIEFjdGlvbnMuYWRkQXR0cmlidXRlOlxuICAgICAgICBpZiAoIW5vZGUuYXR0cnMpIHtcbiAgICAgICAgICBub2RlLmF0dHJzID0ge31cbiAgICAgICAgfVxuXG4gICAgICAgIG5vZGUuYXR0cnNbZGlmZltBY3Rpb25zLm5hbWVdXSA9IGRpZmZbQWN0aW9ucy52YWx1ZV1cblxuICAgICAgICBicmVha1xuICAgICAgY2FzZSBBY3Rpb25zLm1vZGlmeUF0dHJpYnV0ZTpcbiAgICAgICAgbm9kZS5hdHRyc1tkaWZmW0FjdGlvbnMubmFtZV1dID0gZGlmZltBY3Rpb25zLm5ld1ZhbHVlXVxuXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlIEFjdGlvbnMucmVtb3ZlQXR0cmlidXRlOlxuICAgICAgICBkZWxldGUgbm9kZS5hdHRyc1tkaWZmW0FjdGlvbnMubmFtZV1dXG5cbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgQWN0aW9ucy5yZXBsYWNlRWxlbWVudDpcbiAgICAgICAgbmV3Tm9kZSA9IGNsb25lT2JqKGRpZmZbQWN0aW9ucy5uZXdWYWx1ZV0pXG4gICAgICAgIG5ld05vZGVbb3V0ZXJEb25lXSA9IHRydWVcbiAgICAgICAgbmV3Tm9kZVtpbm5lckRvbmVdID0gdHJ1ZVxuICAgICAgICBpZiAocGFyZW50Tm9kZSkge1xuICAgICAgICAgIHBhcmVudE5vZGUuY2hpbGRyZW5bbm9kZUluZGV4XSA9IG5ld05vZGVcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgUmVwbGFjZVdob2xlVHJlZUV4Y2VwdGlvbigpXG4gICAgICAgIH1cbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgQWN0aW9ucy5yZWxvY2F0ZUdyb3VwOlxuICAgICAgICBjb25zdCBub2RlQXJyYXkgPSBub2RlLmNoaWxkcmVuLnNwbGljZShkaWZmW0FjdGlvbnMuZnJvbV0sIGRpZmZbQWN0aW9ucy5ncm91cExlbmd0aF0pLnJldmVyc2UoKVxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGVBcnJheS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIG5vZGUuY2hpbGRyZW4uc3BsaWNlKGRpZmZbQWN0aW9ucy50b10sIDAsIG5vZGVBcnJheVtpXSlcbiAgICAgICAgfVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSBBY3Rpb25zLnJlbW92ZUVsZW1lbnQ6XG4gICAgICAgIHBhcmVudE5vZGUuY2hpbGRyZW4uc3BsaWNlKG5vZGVJbmRleCwgMSlcbiAgICAgICAgYnJlYWtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGNvbnNvbGUubG9nKCd1bmtub3duIGFjdGlvbicpXG4gICAgfVxuXG4gICAgLy8gY2FwdHVyZSBuZXdOb2RlIGZvciB0aGUgY2FsbGJhY2tcbiAgICBpbmZvLm5ld05vZGUgPSBuZXdOb2RlXG5cbiAgICByZXR1cm4gdW5kZWZpbmVkXG4gIH1cbn1cbiJdfQ==